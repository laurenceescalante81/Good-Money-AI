<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Good Money Adviser</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/ionicons@7.1.0/dist/css/ionicons.min.css" rel="stylesheet">
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#0C1B2A;color:#E2E8F0;min-height:100vh}
:root{
  --teal:#0D9488;--teal-dark:#0F766E;--teal-light:#2DD4BF;--teal-glow:rgba(13,148,136,0.15);
  --navy:#0C1B2A;--navy-light:#132D46;--navy-mid:#1B3A5C;
  --gold:#F59E0B;--red:#EF4444;--green:#10B981;--blue:#3B82F6;--purple:#8B5CF6;--pink:#EC4899;
  --text:#E2E8F0;--text-secondary:#94A3B8;--text-muted:#64748B;
  --card:#132D46;--card-border:#1E3A5F;--card-hover:#1B3A5C;
  --input-bg:#0C1B2A;--input-border:#1E3A5F;
  --shadow:0 2px 8px rgba(0,0,0,0.3);
  --sidebar-w:260px;
}

.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0C1B2A 0%,#132D46 50%,#0C1B2A 100%)}
.login-card{background:var(--card);border:1px solid var(--card-border);border-radius:20px;padding:40px;width:420px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.login-card .logo-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:24px}
.login-card .logo-icon{width:52px;height:52px;background:var(--teal);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff}
.login-card .logo-text h1{font-size:22px;color:#fff;font-weight:700}
.login-card .logo-text span{font-size:12px;color:var(--teal-light);font-weight:500}
.login-card>p{text-align:center;color:var(--text-secondary);margin-bottom:28px;font-size:14px}

.form-group{margin-bottom:16px}
.form-group label{display:block;font-weight:600;font-size:13px;color:var(--text-secondary);margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:11px 14px;border:1px solid var(--input-border);border-radius:10px;font-size:14px;font-family:inherit;outline:none;transition:border .2s;background:var(--input-bg);color:var(--text)}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--teal)}
.form-group textarea{resize:vertical;min-height:60px}
.form-group select option{background:var(--navy);color:var(--text)}

.btn{padding:10px 20px;border:none;border-radius:10px;font-family:inherit;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--teal);color:#fff}.btn-primary:hover{background:var(--teal-dark)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:#dc2626}
.btn-secondary{background:var(--navy-mid);color:var(--text-secondary);border:1px solid var(--card-border)}.btn-secondary:hover{background:var(--card-border);color:#fff}
.btn-gold{background:var(--gold);color:#7c5800}.btn-gold:hover{background:#d4930d}
.btn-sm{padding:6px 14px;font-size:12px;border-radius:8px}
.btn-full{width:100%;justify-content:center;padding:12px}
.login-error{color:var(--red);font-size:13px;text-align:center;margin-top:12px;display:none}

.app{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-w);background:var(--navy-light);border-right:1px solid var(--card-border);flex-shrink:0;position:fixed;height:100vh;overflow-y:auto;z-index:100;display:flex;flex-direction:column}
.sidebar .logo-area{padding:20px;border-bottom:1px solid var(--card-border);display:flex;align-items:center;gap:12px}
.sidebar .logo-area .logo-sq{width:38px;height:38px;background:var(--teal);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;flex-shrink:0}
.sidebar .logo-area .logo-info h2{font-size:15px;font-weight:700;color:#fff}
.sidebar .logo-area .logo-info span{font-size:11px;color:var(--teal-light);font-weight:500}
.sidebar nav{flex:1;padding:12px 0}
.nav-item{padding:10px 20px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text-muted);transition:all .15s;display:flex;align-items:center;gap:10px;border-left:3px solid transparent;margin:1px 0}
.nav-item:hover{background:rgba(255,255,255,0.03);color:var(--text)}
.nav-item.active{background:var(--teal-glow);color:var(--teal-light);border-left-color:var(--teal)}
.nav-item ion-icon{font-size:18px;width:22px}
.nav-divider{height:1px;background:var(--card-border);margin:8px 20px}
.nav-label{padding:8px 20px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted)}
.sidebar .user-area{padding:16px 20px;border-top:1px solid var(--card-border);background:rgba(0,0,0,0.2)}
.sidebar .user-area .user-name{font-size:13px;font-weight:600;color:#fff}
.sidebar .user-area .user-role{font-size:11px;color:var(--teal-light);text-transform:uppercase;font-weight:600;margin-top:2px}
.sidebar .user-area .logout-btn{font-size:12px;color:var(--text-muted);cursor:pointer;margin-top:8px;background:none;border:none;font-family:inherit;display:flex;align-items:center;gap:4px}
.sidebar .user-area .logout-btn:hover{color:var(--red)}

.main{margin-left:var(--sidebar-w);flex:1;padding:28px;min-height:100vh}
.page-header{margin-bottom:24px}
.page-header h1{font-size:24px;font-weight:700;color:#fff}
.page-header p{font-size:14px;color:var(--text-secondary);margin-top:4px}

.welcome-banner{background:linear-gradient(135deg,var(--teal-dark),var(--navy-mid));border-radius:16px;padding:28px 32px;margin-bottom:24px;border:1px solid var(--teal);position:relative;overflow:hidden}
.welcome-banner::after{content:'';position:absolute;right:-30px;top:-30px;width:160px;height:160px;border-radius:50%;background:rgba(13,148,136,0.15)}
.welcome-banner h2{font-size:22px;color:#fff;margin-bottom:4px}
.welcome-banner p{color:var(--teal-light);font-size:14px}
.welcome-banner .quick-actions{display:flex;gap:10px;margin-top:16px}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border-radius:14px;padding:20px;border:1px solid var(--card-border);transition:border-color .2s}
.stat-card:hover{border-color:var(--teal)}
.stat-card .stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:12px}
.stat-card .stat-label{font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
.stat-card .stat-val{font-size:28px;font-weight:700;margin-top:4px;color:#fff}
.stat-card .stat-sub{font-size:12px;color:var(--text-secondary);margin-top:2px}

.card{background:var(--card);border-radius:14px;padding:20px;border:1px solid var(--card-border);margin-bottom:20px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.card-header h3{font-size:16px;font-weight:700;color:#fff}

table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 12px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--card-border)}
td{padding:10px 12px;font-size:13px;border-bottom:1px solid rgba(30,58,95,0.5);color:var(--text-secondary)}
tr:hover td{background:rgba(255,255,255,0.02)}
tbody tr{cursor:default}
tbody tr.clickable{cursor:pointer}
tbody tr.clickable:hover td{background:var(--teal-glow)}

.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-active{background:rgba(16,185,129,0.15);color:#34D399}
.badge-inactive{background:rgba(239,68,68,0.15);color:#F87171}
.badge-god{background:rgba(245,158,11,0.15);color:#FBBF24}
.badge-adviser{background:rgba(59,130,246,0.15);color:#60A5FA}

.progress-bar{height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden}
.progress-bar .fill{height:100%;border-radius:4px;background:var(--teal);transition:width .3s}

.search-bar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.search-bar input{flex:1;min-width:200px;padding:9px 14px;border:1px solid var(--input-border);border-radius:10px;font-size:13px;font-family:inherit;outline:none;background:var(--input-bg);color:var(--text)}
.search-bar input:focus{border-color:var(--teal)}
.search-bar select{padding:9px 14px;border:1px solid var(--input-border);border-radius:10px;font-size:13px;font-family:inherit;outline:none;background:var(--input-bg);color:var(--text)}

.breadcrumb{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text-muted);margin-bottom:16px}
.breadcrumb a{color:var(--teal-light);text-decoration:none;cursor:pointer}
.breadcrumb a:hover{text-decoration:underline}

.client-header{display:flex;align-items:center;gap:20px;margin-bottom:24px;flex-wrap:wrap}
.client-avatar{width:64px;height:64px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:700;color:#fff;flex-shrink:0}
.client-info h2{font-size:22px;font-weight:700;color:#fff}
.client-info p{font-size:13px;color:var(--text-secondary)}
.client-info .client-meta{display:flex;gap:16px;margin-top:6px;flex-wrap:wrap}
.client-info .client-meta span{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-muted)}

.tag-list{display:flex;flex-wrap:wrap;gap:6px}
.tag{background:rgba(13,148,136,0.12);color:var(--teal-light);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500}

.activity-item{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid rgba(30,58,95,0.3)}
.activity-item:last-child{border-bottom:none}
.activity-dot{width:8px;height:8px;border-radius:50%;background:var(--teal);margin-top:6px;flex-shrink:0}
.activity-item .activity-text{font-size:13px;color:var(--text-secondary)}
.activity-item .activity-time{font-size:11px;color:var(--text-muted);margin-top:2px}
.activity-item .activity-pts{font-size:12px;color:var(--teal-light);font-weight:600;margin-left:auto;flex-shrink:0}

.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:28px;width:520px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.modal h2{font-size:18px;font-weight:700;margin-bottom:20px;color:#fff}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

.toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:10px;font-size:13px;font-weight:500;color:#fff;animation:slideIn .3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.toast-success{background:#065f46;border:1px solid var(--green)}
.toast-error{background:#7f1d1d;border:1px solid var(--red)}
.toast-info{background:var(--navy-mid);border:1px solid var(--teal)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

.chart-container{display:flex;align-items:center;justify-content:center;padding:20px}
.chart-legend{display:flex;flex-direction:column;gap:8px;margin-left:24px}
.chart-legend-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary)}
.chart-legend-item .dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}

.advisor-card{background:var(--card);border-radius:14px;padding:16px;border:1px solid var(--card-border);margin-bottom:12px;transition:border-color .15s}
.advisor-card:hover{border-color:var(--teal)}
.advisor-card .advisor-row{display:flex;align-items:center;gap:14px}
.advisor-card .advisor-avatar{width:44px;height:44px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:#fff;flex-shrink:0}
.advisor-card .advisor-info h4{font-size:15px;font-weight:600;color:#fff}
.advisor-card .advisor-info p{font-size:12px;color:var(--text-secondary)}
.advisor-card .advisor-stats{display:flex;gap:20px;margin-top:12px;padding-top:12px;border-top:1px solid var(--card-border);flex-wrap:wrap}
.advisor-card .advisor-stat{font-size:12px;color:var(--text-muted)}
.advisor-card .advisor-stat strong{color:#fff;display:block;font-size:16px}

.empty-state{text-align:center;padding:40px;color:var(--text-muted);font-size:14px}
.loading{text-align:center;padding:40px;color:var(--text-muted)}

.hidden{display:none!important}

.finance-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.finance-item{background:rgba(255,255,255,0.03);border-radius:10px;padding:12px;border:1px solid var(--card-border)}
.finance-item .fi-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:600}
.finance-item .fi-val{font-size:16px;font-weight:700;color:#fff;margin-top:2px}

@media(max-width:768px){
  .sidebar{display:none!important}
  .main{margin-left:0!important;padding:16px;padding-top:60px}
  .stat-grid{grid-template-columns:1fr 1fr}
  .welcome-banner{padding:20px}
}

.mobile-topbar{display:none;position:fixed;top:0;left:0;right:0;height:52px;background:var(--navy-light);border-bottom:1px solid var(--card-border);z-index:200;align-items:center;justify-content:space-between;padding:0 16px}
.mobile-topbar .mtb-left{display:flex;align-items:center;gap:10px}
.mobile-topbar .mtb-logo{width:32px;height:32px;background:var(--teal);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff}
.mobile-topbar .mtb-title{font-size:15px;font-weight:700;color:#fff}
.mobile-topbar .mtb-btn{width:38px;height:38px;border-radius:10px;background:rgba(255,255,255,0.06);border:1px solid var(--card-border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);font-size:20px}
.mobile-topbar .mtb-btn:active{background:var(--teal-glow);color:var(--teal-light)}
@media(max-width:768px){.mobile-topbar{display:flex}}

.mobile-home-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(160deg,#0C1B2A 0%,#132D46 40%,#1B3A5C 100%);z-index:500;overflow-y:auto;-webkit-overflow-scrolling:touch}
.mobile-home-overlay.show{display:flex;flex-direction:column}
.mho-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;padding-top:max(env(safe-area-inset-top),16px)}
.mho-header .mho-title{font-size:18px;font-weight:700;color:#fff}
.mho-header .mho-close{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,0.08);border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);font-size:22px}
.mho-header .mho-close:active{background:var(--teal-glow);color:var(--teal-light)}
.mho-user{padding:0 20px 20px;display:flex;align-items:center;gap:12px}
.mho-user .mho-avatar{width:44px;height:44px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff}
.mho-user .mho-user-info{flex:1}
.mho-user .mho-user-name{font-size:15px;font-weight:600;color:#fff}
.mho-user .mho-user-role{font-size:11px;color:var(--teal-light);text-transform:uppercase;font-weight:600}
.mho-section{padding:0 20px 8px}
.mho-section-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:12px}
.mho-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:24px}
.mho-item{display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px 8px;border-radius:16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all .15s}
.mho-item:active{background:var(--teal-glow);border-color:var(--teal);transform:scale(0.96)}
.mho-item.active{background:var(--teal-glow);border-color:var(--teal)}
.mho-item .mho-icon{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff}
.mho-item .mho-label{font-size:11px;font-weight:600;color:var(--text-secondary);text-align:center;line-height:1.3}
.mho-item.active .mho-label{color:var(--teal-light)}
.mho-logout{margin:8px 20px 20px;padding:14px;border-radius:14px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.15);display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;color:#F87171;font-size:14px;font-weight:600}
.mho-logout:active{background:rgba(239,68,68,0.15)}
</style>
</head>
<body>

<div id="login-page" class="login-wrap">
  <div class="login-card">
    <div class="logo-row">
      <div class="logo-icon"><ion-icon name="cash-outline"></ion-icon></div>
      <div class="logo-text"><h1>Good Money</h1><span>Adviser Portal</span></div>
    </div>
    <p>Sign in to manage your clients</p>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="you@goodmoney.com.au">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="Enter password">
    </div>
    <button class="btn btn-primary btn-full" onclick="doLogin()">Sign In</button>
    <div id="login-error" class="login-error"></div>
  </div>
</div>

<div id="app-page" class="app hidden">
  <div class="sidebar">
    <div class="logo-area">
      <div class="logo-sq"><ion-icon name="cash-outline"></ion-icon></div>
      <div class="logo-info"><h2>Good Money</h2><span>Adviser Portal</span></div>
    </div>
    <nav id="sidebar-nav"></nav>
    <div class="user-area">
      <div class="user-name" id="sidebar-user-name"></div>
      <div class="user-role" id="sidebar-user-role"></div>
      <div style="display:flex;gap:6px;margin-top:10px">
        <button class="btn btn-sm" style="flex:1;background:rgba(239,68,68,0.12);color:#F87171;border:1px solid rgba(239,68,68,0.25);font-size:11px;justify-content:center" onclick="doLogout()"><ion-icon name="log-out-outline" style="font-size:13px"></ion-icon> Logout</button>
        <button id="sidebar-refresh-btn" class="btn btn-sm hidden" style="flex:1;background:rgba(59,130,246,0.12);color:#60A5FA;border:1px solid rgba(59,130,246,0.25);font-size:11px;justify-content:center" onclick="refreshApp()"><ion-icon name="refresh-outline" style="font-size:13px"></ion-icon> Refresh</button>
      </div>
    </div>
  </div>
  <div class="main" id="main-content"></div>
</div>

<div class="mobile-topbar" id="mobile-topbar">
  <div class="mtb-left">
    <div class="mtb-logo"><ion-icon name="cash-outline"></ion-icon></div>
    <span class="mtb-title" id="mtb-page-title">Dashboard</span>
  </div>
  <div class="mtb-btn" onclick="toggleMobileHome()"><ion-icon name="apps-outline"></ion-icon></div>
</div>

<div class="mobile-home-overlay" id="mobile-home-overlay">
  <div class="mho-header">
    <span class="mho-title">Good Money Adviser</span>
    <div class="mho-close" onclick="toggleMobileHome()"><ion-icon name="close-outline"></ion-icon></div>
  </div>
  <div class="mho-user">
    <div class="mho-avatar" id="mho-avatar">A</div>
    <div class="mho-user-info">
      <div class="mho-user-name" id="mho-user-name">Admin</div>
      <div class="mho-user-role" id="mho-user-role">God Mode</div>
    </div>
  </div>
  <div id="mho-nav-content"></div>
  <div class="mho-logout" onclick="doLogout()"><ion-icon name="log-out-outline"></ion-icon> Sign Out</div>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal-content"></div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
const API = '/api/admin';
let token = localStorage.getItem('adviser_token');
let currentUser = null;
let currentPage = 'dashboard';
let cache = {};

function isGod() { return currentUser && (currentUser.role === 'god' || currentUser.role === 'admin'); }
function isAdviser() { return currentUser && currentUser.role === 'adviser'; }

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['x-admin-token'] = token;
  const r = await fetch(API + path, { ...opts, headers });
  if (r.status === 401) { doLogout(); throw new Error('Unauthorized'); }
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || 'Request failed');
  return data;
}

function toast(msg, type = 'success') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(100%)'; setTimeout(() => t.remove(), 300); }, 3000);
}

async function doLogin() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  try {
    errEl.style.display = 'none';
    const data = await fetch(API + '/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) }).then(r => r.json());
    if (data.error) { errEl.textContent = data.error; errEl.style.display = 'block'; return; }
    token = data.token;
    currentUser = data.user;
    localStorage.setItem('adviser_token', token);
    localStorage.setItem('adviser_user', JSON.stringify(currentUser));
    showApp();
  } catch (e) {
    errEl.textContent = 'Login failed';
    errEl.style.display = 'block';
  }
}

function doLogout() {
  if (token) api('/logout', { method: 'POST' }).catch(() => {});
  token = null;
  currentUser = null;
  cache = {};
  localStorage.removeItem('adviser_token');
  localStorage.removeItem('adviser_user');
  document.getElementById('login-page').classList.remove('hidden');
  document.getElementById('app-page').classList.add('hidden');
}

function refreshApp() {
  toast('Refreshing app — pulling latest features...', 'info');
  cache = {};
  setTimeout(() => {
    window.location.reload();
  }, 800);
}

async function showApp() {
  document.getElementById('login-page').classList.add('hidden');
  document.getElementById('app-page').classList.remove('hidden');
  if (!currentUser) {
    try {
      const data = await api('/me');
      currentUser = data.user;
      localStorage.setItem('adviser_user', JSON.stringify(currentUser));
    } catch {
      doLogout();
      return;
    }
  }
  document.getElementById('sidebar-user-name').textContent = currentUser.name;
  document.getElementById('sidebar-user-role').textContent = isGod() ? 'God Mode' : 'Adviser';
  if (isGod()) document.getElementById('sidebar-refresh-btn').classList.remove('hidden');
  else document.getElementById('sidebar-refresh-btn').classList.add('hidden');
  buildNav();
  navigate('dashboard');
}

function buildNav() {
  let html = '';
  html += navItem('dashboard', 'grid-outline', 'Dashboard');
  html += navItem('clients', 'people-outline', isGod() ? 'All Clients' : 'My Clients');
  html += navItem('reports', 'bar-chart-outline', 'Reports');
  html += navItem('content-reports', 'analytics-outline', 'Content Reports');
  html += navItem('optimization', 'flash-outline', 'Optimization');
  if (isGod()) {
    html += '<div class="nav-divider"></div>';
    html += '<div class="nav-label">Marketing</div>';
    html += navItem('campaigns', 'rocket-outline', 'Campaigns');
    html += navItem('campaign-analytics', 'stats-chart-outline', 'Campaign Analytics');
    html += navItem('cta-optimizer', 'color-wand-outline', 'CTA Optimizer');
    html += '<div class="nav-divider"></div>';
    html += '<div class="nav-label">Administration</div>';
    html += navItem('advisers', 'person-outline', 'Advisers');
    html += navItem('quests', 'trophy-outline', 'Quests');
    html += navItem('ctas', 'megaphone-outline', 'CTAs');
    html += navItem('messages', 'chatbubbles-outline', 'Messages');
    html += navItem('settings', 'settings-outline', 'Settings');
  }
  document.getElementById('sidebar-nav').innerHTML = html;
  buildMobileHome();
}

function navItem(page, icon, label) {
  return `<div class="nav-item${currentPage === page ? ' active' : ''}" data-page="${page}" onclick="navigate('${page}')"><ion-icon name="${icon}"></ion-icon><span>${label}</span></div>`;
}

const PAGE_LABELS = {
  dashboard:'Dashboard', clients:'Clients', reports:'Reports', 'content-reports':'Content Reports',
  optimization:'Optimization', campaigns:'Campaigns', 'campaign-analytics':'Campaign Analytics',
  'cta-optimizer':'CTA Optimizer', advisers:'Advisers', quests:'Quests', ctas:'CTAs',
  messages:'Messages', settings:'Settings'
};

const MOBILE_NAV_COLORS = {
  dashboard:'#0D9488', clients:'#3B82F6', reports:'#8B5CF6', 'content-reports':'#14B8A6',
  optimization:'#F59E0B', campaigns:'#EF4444', 'campaign-analytics':'#EC4899',
  'cta-optimizer':'#D97706', advisers:'#10B981', quests:'#F59E0B', ctas:'#3B82F6',
  messages:'#8B5CF6', settings:'#64748B'
};

function buildMobileHome() {
  const items = [
    { page:'dashboard', icon:'grid-outline', label:'Dashboard' },
    { page:'clients', icon:'people-outline', label: isGod() ? 'All Clients' : 'My Clients' },
    { page:'reports', icon:'bar-chart-outline', label:'Reports' },
    { page:'content-reports', icon:'analytics-outline', label:'Content Reports' },
    { page:'optimization', icon:'flash-outline', label:'Optimization' },
  ];
  const marketing = [
    { page:'campaigns', icon:'rocket-outline', label:'Campaigns' },
    { page:'campaign-analytics', icon:'stats-chart-outline', label:'Analytics' },
    { page:'cta-optimizer', icon:'color-wand-outline', label:'CTA Optimizer' },
  ];
  const admin = [
    { page:'advisers', icon:'person-outline', label:'Advisers' },
    { page:'quests', icon:'trophy-outline', label:'Quests' },
    { page:'ctas', icon:'megaphone-outline', label:'CTAs' },
    { page:'messages', icon:'chatbubbles-outline', label:'Messages' },
    { page:'settings', icon:'settings-outline', label:'Settings' },
  ];

  function grid(arr) {
    return arr.map(i => `<div class="mho-item${currentPage===i.page?' active':''}" data-mho-page="${i.page}" onclick="mobileNavigate('${i.page}')">
      <div class="mho-icon" style="background:${MOBILE_NAV_COLORS[i.page]||'#0D9488'}"><ion-icon name="${i.icon}"></ion-icon></div>
      <span class="mho-label">${i.label}</span>
    </div>`).join('');
  }

  let html = '<div class="mho-section"><div class="mho-section-label">Main</div><div class="mho-grid">' + grid(items) + '</div></div>';
  if (isGod()) {
    html += '<div class="mho-section"><div class="mho-section-label">Marketing</div><div class="mho-grid">' + grid(marketing) + '</div></div>';
    html += '<div class="mho-section"><div class="mho-section-label">Administration</div><div class="mho-grid">' + grid(admin) + '</div></div>';
  }
  document.getElementById('mho-nav-content').innerHTML = html;

  if (currentUser) {
    const initials = (currentUser.name || 'A').split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
    document.getElementById('mho-avatar').textContent = initials;
    document.getElementById('mho-user-name').textContent = currentUser.name;
    document.getElementById('mho-user-role').textContent = isGod() ? 'God Mode' : 'Adviser';
  }
}

function toggleMobileHome() {
  document.getElementById('mobile-home-overlay').classList.toggle('show');
}

function mobileNavigate(page) {
  document.getElementById('mobile-home-overlay').classList.remove('show');
  navigate(page);
}

function navigate(page) {
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
  document.querySelectorAll('.mho-item').forEach(n => n.classList.toggle('active', n.dataset.mhoPage === page));
  const titleEl = document.getElementById('mtb-page-title');
  if (titleEl) titleEl.textContent = PAGE_LABELS[page] || page;
  const renderers = { dashboard: renderDashboard, clients: renderClients, reports: renderReports, advisers: renderAdvisers, quests: renderQuests, ctas: renderCTAs, messages: renderMessages, 'content-reports': renderContentReports, optimization: renderOptimization, campaigns: renderCampaigns, 'campaign-analytics': renderCampaignAnalytics, 'cta-optimizer': renderCTAOptimizer, settings: renderSettings };
  if (renderers[page]) renderers[page]();
}

function showModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}
function hideModal() {
  document.getElementById('modal-overlay').classList.remove('show');
}
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-overlay')) hideModal();
});

function setMain(html) { document.getElementById('main-content').innerHTML = html; }
function $(id) { return document.getElementById(id); }
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmt(n) { return Number(n || 0).toLocaleString(); }
function pct(n) { return Number(n || 0).toFixed(0); }
function fmtDate(d) { if (!d) return '—'; return new Date(d).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' }); }
function fmtDateTime(d) { if (!d) return '—'; return new Date(d).toLocaleString('en-AU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); }
function timeAgo(d) {
  if (!d) return 'Never';
  const diff = Date.now() - new Date(d).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 30) return days + 'd ago';
  return fmtDate(d);
}
function initials(name) { if (!name) return '?'; return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2); }

async function renderDashboard() {
  setMain(`<div id="dash-content"><div class="loading">Loading dashboard...</div></div>`);
  try {
    let stats, recentActivity = [], advisorName = currentUser.name;
    if (isGod()) {
      const data = await api('/analytics/overview');
      stats = data.overview;
      recentActivity = data.recent_activity || [];
    } else {
      const aid = currentUser.advisorId;
      if (aid) {
        const data = await api('/analytics/advisor/' + aid);
        stats = data.stats;
        advisorName = data.advisor?.name || currentUser.name;
      } else {
        stats = { total_customers: 0, active_7d: 0, avg_fact_find: 0, avg_level: 1, total_points: 0, avg_streak: 0 };
      }
    }
    let html = `
      <div class="welcome-banner">
        <h2>Welcome back, ${esc(advisorName)}</h2>
        <p>${isGod() ? 'God Mode — Full platform overview' : 'Your client portfolio overview'}</p>
        <div class="quick-actions">
          <button class="btn btn-primary btn-sm" onclick="navigate('clients')"><ion-icon name="people-outline"></ion-icon> View Clients</button>
          <button class="btn btn-secondary btn-sm" onclick="navigate('reports')"><ion-icon name="bar-chart-outline"></ion-icon> Reports</button>
        </div>
      </div>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(13,148,136,0.15);color:var(--teal-light)"><ion-icon name="people"></ion-icon></div>
          <div class="stat-label">Total Clients</div>
          <div class="stat-val">${fmt(stats.total_customers)}</div>
          <div class="stat-sub">${fmt(stats.active_7d)} active this week</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(16,185,129,0.15);color:var(--green)"><ion-icon name="checkmark-circle"></ion-icon></div>
          <div class="stat-label">Avg Fact Find</div>
          <div class="stat-val">${pct(stats.avg_fact_find)}%</div>
          <div class="stat-sub">Completion rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(139,92,246,0.15);color:var(--purple)"><ion-icon name="trending-up"></ion-icon></div>
          <div class="stat-label">Avg Level</div>
          <div class="stat-val">${Number(stats.avg_level || 1).toFixed(1)}</div>
          <div class="stat-sub">Avg streak: ${Number(stats.avg_streak || 0).toFixed(1)}d</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(245,158,11,0.15);color:var(--gold)"><ion-icon name="star"></ion-icon></div>
          <div class="stat-label">Total Good Coins</div>
          <div class="stat-val">${fmt(stats.total_points_issued || stats.total_points || 0)}</div>
          <div class="stat-sub">Coins issued</div>
        </div>
      </div>`;

    if (recentActivity.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Recent Client Activity</h3></div>`;
      recentActivity.slice(0, 10).forEach(a => {
        html += `<div class="activity-item">
          <div class="activity-dot"></div>
          <div>
            <div class="activity-text"><strong>${esc(a.customer_name || 'Unknown')}</strong> — ${esc(a.action)}</div>
            <div class="activity-time">${timeAgo(a.created_at)}</div>
          </div>
          ${a.points_earned > 0 ? `<div class="activity-pts">+${a.points_earned} coins</div>` : ''}
        </div>`;
      });
      html += '</div>';
    }

    if (!isGod() && currentUser.advisorId) {
      try {
        const customers = await api('/customers?advisor_id=' + currentUser.advisorId);
        if (customers.length > 0) {
          const recent = customers.filter(c => c.last_active).sort((a, b) => new Date(b.last_active) - new Date(a.last_active)).slice(0, 5);
          if (recent.length) {
            html += `<div class="card"><div class="card-header"><h3>Recently Active Clients</h3></div>
            <table><thead><tr><th>Client</th><th>Level</th><th>Good Coins</th><th>Fact Find</th><th>Last Active</th></tr></thead><tbody>`;
            recent.forEach(c => {
              html += `<tr class="clickable" onclick="viewClient(${c.id})">
                <td><strong>${esc(c.name || 'Unnamed')}</strong></td>
                <td>${c.level}</td><td>${fmt(c.total_points_earned)}</td>
                <td><div class="progress-bar" style="width:60px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${pct(c.fact_find_progress)}%"></div></div> ${pct(c.fact_find_progress)}%</td>
                <td>${timeAgo(c.last_active)}</td>
              </tr>`;
            });
            html += '</tbody></table></div>';
          }
        }
      } catch {}
    }

    $('dash-content').innerHTML = html;
  } catch (e) {
    $('dash-content').innerHTML = '<div class="empty-state">Failed to load dashboard</div>';
  }
}

let clientSearch = '';
let clientAdvisorFilter = '';
let clientSort = 'last_active';
let clientSortDir = 'desc';

async function renderClients() {
  setMain(`<div class="page-header"><h1>${isGod() ? 'All Clients' : 'My Clients'}</h1><p>Manage your client portfolio</p></div><div id="clients-content"><div class="loading">Loading clients...</div></div>`);
  try {
    let url = '/customers';
    if (isAdviser() && currentUser.advisorId) url += '?advisor_id=' + currentUser.advisorId;
    else if (clientAdvisorFilter) url += '?advisor_id=' + clientAdvisorFilter;
    const customers = await api(url);
    cache.customers = customers;

    let advisors = [];
    if (isGod()) {
      try { advisors = await api('/advisors'); cache.advisors = advisors; } catch {}
    }

    let filtered = customers;
    if (clientSearch) {
      const s = clientSearch.toLowerCase();
      filtered = filtered.filter(c => (c.name || '').toLowerCase().includes(s) || (c.email || '').toLowerCase().includes(s));
    }

    filtered.sort((a, b) => {
      let va = a[clientSort], vb = b[clientSort];
      if (clientSort === 'last_active' || clientSort === 'created_at') {
        va = va ? new Date(va).getTime() : 0;
        vb = vb ? new Date(vb).getTime() : 0;
      }
      if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
      if (va < vb) return clientSortDir === 'asc' ? -1 : 1;
      if (va > vb) return clientSortDir === 'asc' ? 1 : -1;
      return 0;
    });

    let html = '<div class="search-bar">';
    html += `<input type="text" placeholder="Search by name or email..." value="${esc(clientSearch)}" oninput="clientSearch=this.value;renderClientsTable()">`;
    if (isGod() && advisors.length > 0) {
      html += `<select onchange="clientAdvisorFilter=this.value;renderClients()"><option value="">All Advisers</option>`;
      advisors.forEach(a => { html += `<option value="${a.id}" ${clientAdvisorFilter == a.id ? 'selected' : ''}>${esc(a.name)}</option>`; });
      html += '</select>';
    }
    html += '</div>';

    html += `<div class="card" style="padding:0;overflow-x:auto"><table><thead><tr>`;
    const cols = [
      { key: 'name', label: 'Name' },
      { key: 'email', label: 'Email' },
      { key: 'level', label: 'Level' },
      { key: 'total_points_earned', label: 'Good Coins' },
      { key: 'streak', label: 'Streak' },
      { key: 'fact_find_progress', label: 'Fact Find %' },
      { key: 'last_active', label: 'Last Active' },
    ];
    if (isGod()) cols.splice(2, 0, { key: 'advisor_name', label: 'Adviser' });
    cols.forEach(col => {
      const arrow = clientSort === col.key ? (clientSortDir === 'asc' ? ' ▲' : ' ▼') : '';
      html += `<th style="cursor:pointer" onclick="sortClients('${col.key}')">${col.label}${arrow}</th>`;
    });
    html += '</tr></thead><tbody id="clients-tbody">'; 

    filtered.forEach(c => {
      html += `<tr class="clickable" onclick="viewClient(${c.id})">
        <td><strong>${esc(c.name || 'Unnamed')}</strong></td>
        <td>${esc(c.email || '—')}</td>`;
      if (isGod()) html += `<td>${esc(c.advisor_name || 'Unassigned')}</td>`;
      html += `<td>${c.level}</td>
        <td>${fmt(c.total_points_earned)}</td>
        <td>${c.streak}d</td>
        <td><div class="progress-bar" style="width:60px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${pct(c.fact_find_progress)}%"></div></div> ${pct(c.fact_find_progress)}%</td>
        <td>${timeAgo(c.last_active)}</td>
      </tr>`;
    });

    if (filtered.length === 0) html += '<tr><td colspan="10" class="empty-state">No clients found</td></tr>';
    html += '</tbody></table></div>';
    html += `<p style="font-size:12px;color:var(--text-muted);margin-top:8px">Showing ${filtered.length} of ${customers.length} clients</p>`;

    $('clients-content').innerHTML = html;
  } catch (e) {
    $('clients-content').innerHTML = '<div class="empty-state">Failed to load clients</div>';
  }
}

function sortClients(key) {
  if (clientSort === key) clientSortDir = clientSortDir === 'asc' ? 'desc' : 'asc';
  else { clientSort = key; clientSortDir = key === 'name' || key === 'email' ? 'asc' : 'desc'; }
  renderClients();
}

function renderClientsTable() {
  renderClients();
}

async function viewClient(id) {
  setMain(`<div id="client-detail"><div class="loading">Loading client...</div></div>`);
  currentPage = 'client-detail';
  try {
    const c = await api('/customers/' + id);
    let advisors = cache.advisors || [];
    if (isGod() && !advisors.length) {
      try { advisors = await api('/advisors'); cache.advisors = advisors; } catch {}
    }

    let html = `<div class="breadcrumb">
      <a onclick="navigate('clients')">${isGod() ? 'All Clients' : 'My Clients'}</a>
      <span>›</span>
      <span>${esc(c.name || 'Client #' + c.id)}</span>
    </div>`;

    html += `<div class="client-header">
      <div class="client-avatar">${initials(c.name)}</div>
      <div class="client-info">
        <h2>${esc(c.name || 'Unnamed Client')}</h2>
        <p>${esc(c.email || 'No email')}${c.phone ? ' · ' + esc(c.phone) : ''}</p>
        <div class="client-meta">
          <span><ion-icon name="time-outline"></ion-icon> Last active: ${timeAgo(c.last_active)}</span>
          <span><ion-icon name="calendar-outline"></ion-icon> Joined: ${fmtDate(c.created_at)}</span>
          ${c.advisor_name ? `<span><ion-icon name="person-outline"></ion-icon> Adviser: ${esc(c.advisor_name)}</span>` : ''}
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="showEditClientModal(${c.id})" style="margin-left:auto"><ion-icon name="create-outline"></ion-icon> Edit</button>
    </div>`;

    html += `<div class="stat-grid">
      <div class="stat-card"><div class="stat-label">Level / XP</div><div class="stat-val">${c.level}</div><div class="stat-sub">${fmt(c.xp)} XP</div></div>
      <div class="stat-card"><div class="stat-label">Good Coins</div><div class="stat-val">${fmt(c.points)}</div><div class="stat-sub">${fmt(c.total_points_earned)} total earned</div></div>
      <div class="stat-card"><div class="stat-label">Streak</div><div class="stat-val">${c.streak}d</div><div class="stat-sub">Daily check-in streak</div></div>
      <div class="stat-card"><div class="stat-label">Token Balance</div><div class="stat-val">$${Number(c.token_balance || 0).toFixed(2)}</div><div class="stat-sub">$${Number(c.total_tokens_earned || 0).toFixed(2)} total</div></div>
      <div class="stat-card"><div class="stat-label">Fact Find</div><div class="stat-val">${pct(c.fact_find_progress)}%</div><div class="progress-bar" style="margin-top:8px"><div class="fill" style="width:${pct(c.fact_find_progress)}%"></div></div></div>
    </div>`;

    const missions = c.completed_missions || [];
    const badges = c.unlocked_badges || [];
    const rewards = c.redeemed_rewards || [];

    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">';
    html += `<div class="card"><div class="card-header"><h3>Completed Missions (${missions.length})</h3></div>`;
    if (missions.length) { html += '<div class="tag-list">'; missions.forEach(m => html += `<span class="tag">${esc(m)}</span>`); html += '</div>'; }
    else html += '<div class="empty-state">No missions completed yet</div>';
    html += '</div>';

    html += `<div class="card"><div class="card-header"><h3>Earned Badges (${badges.length})</h3></div>`;
    if (badges.length) { html += '<div class="tag-list">'; badges.forEach(b => html += `<span class="tag" style="background:rgba(245,158,11,0.12);color:var(--gold)">${esc(b)}</span>`); html += '</div>'; }
    else html += '<div class="empty-state">No badges earned yet</div>';
    html += '</div>';
    html += '</div>';

    if (rewards.length) {
      html += `<div class="card"><div class="card-header"><h3>Redeemed Rewards (${rewards.length})</h3></div>`;
      html += '<div class="tag-list">'; rewards.forEach(r => html += `<span class="tag" style="background:rgba(139,92,246,0.12);color:var(--purple)">${esc(r)}</span>`); html += '</div></div>';
    }

    const fd = c.finance_data || {};
    if (Object.keys(fd).length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Finance Summary</h3></div><div class="finance-grid">`;
      for (const [key, val] of Object.entries(fd)) {
        if (val !== null && val !== undefined && val !== '' && typeof val !== 'object') {
          const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          html += `<div class="finance-item"><div class="fi-label">${esc(label)}</div><div class="fi-val">${typeof val === 'number' ? fmt(val) : esc(String(val))}</div></div>`;
        }
      }
      html += '</div></div>';
    }

    const activities = c.recent_activities || [];
    if (activities.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Recent Activity</h3></div>`;
      activities.forEach(a => {
        html += `<div class="activity-item">
          <div class="activity-dot"></div>
          <div>
            <div class="activity-text">${esc(a.action)}</div>
            <div class="activity-time">${fmtDateTime(a.created_at)}</div>
          </div>
          ${a.points_earned > 0 ? `<div class="activity-pts">+${a.points_earned} coins</div>` : ''}
        </div>`;
      });
      html += '</div>';
    }

    cache.currentClient = c;
    cache.clientAdvisors = advisors;
    $('client-detail').innerHTML = html;
  } catch (e) {
    $('client-detail').innerHTML = '<div class="empty-state">Failed to load client details</div>';
  }
}

function showEditClientModal(id) {
  const c = cache.currentClient;
  const advisors = cache.clientAdvisors || [];
  let advisorOpts = '<option value="">Unassigned</option>';
  advisors.forEach(a => { advisorOpts += `<option value="${a.id}" ${c.advisor_id == a.id ? 'selected' : ''}>${esc(a.name)}</option>`; });

  showModal(`
    <h2>Edit Client</h2>
    <div class="form-group"><label>Name</label><input id="m-client-name" value="${esc(c.name || '')}"></div>
    <div class="form-group"><label>Email</label><input id="m-client-email" value="${esc(c.email || '')}"></div>
    <div class="form-group"><label>Phone</label><input id="m-client-phone" value="${esc(c.phone || '')}"></div>
    ${isGod() ? `<div class="form-group"><label>Assigned Adviser</label><select id="m-client-advisor">${advisorOpts}</select></div>` : ''}
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveClient(${id})">Save Changes</button>
    </div>
  `);
}

async function saveClient(id) {
  const data = {
    name: $('m-client-name').value,
    email: $('m-client-email').value,
    phone: $('m-client-phone').value,
  };
  if (isGod()) {
    const av = $('m-client-advisor');
    data.advisor_id = av ? (av.value || null) : undefined;
  }
  try {
    await api('/customers/' + id, { method: 'PUT', body: JSON.stringify(data) });
    hideModal();
    toast('Client updated successfully');
    viewClient(id);
  } catch (e) { toast('Failed to save: ' + e.message, 'error'); }
}

async function renderReports() {
  setMain(`<div class="page-header"><h1>Reports</h1><p>${isGod() ? 'Global analytics and performance reports' : 'Your portfolio performance'}</p></div><div id="reports-content"><div class="loading">Loading reports...</div></div>`);
  try {
    let html = '';
    if (isGod()) {
      const data = await api('/analytics/overview');
      const o = data.overview;

      html += `<div class="stat-grid">
        <div class="stat-card"><div class="stat-label">Total Clients</div><div class="stat-val">${fmt(o.total_customers)}</div></div>
        <div class="stat-card"><div class="stat-label">Active (7d)</div><div class="stat-val">${fmt(o.active_7d)}</div></div>
        <div class="stat-card"><div class="stat-label">Active (30d)</div><div class="stat-val">${fmt(o.active_30d)}</div></div>
        <div class="stat-card"><div class="stat-label">Unassigned</div><div class="stat-val">${fmt(data.unassigned_customers)}</div></div>
        <div class="stat-card"><div class="stat-label">Tokens Issued</div><div class="stat-val">${fmt(o.total_tokens_issued)}</div></div>
      </div>`;

      const active7d = Number(o.active_7d);
      const inactive = Number(o.total_customers) - active7d;
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">';
      html += `<div class="card"><div class="card-header"><h3>Client Engagement</h3></div>
        <div class="chart-container">${renderPieChart([{label:'Active (7d)',value:active7d,color:'#10B981'},{label:'Inactive',value:inactive,color:'#EF4444'}], 100)}</div></div>`;

      const levelDist = data.level_distribution || [];
      if (levelDist.length > 0) {
        html += `<div class="card"><div class="card-header"><h3>Level Distribution</h3></div>
          <div class="chart-container">${renderBarChart(levelDist.map(l => ({label:'L'+l.level, value:Number(l.count)})), '#8B5CF6')}</div></div>`;
      }
      html += '</div>';

      if (data.by_advisor.length > 0) {
        html += `<div class="card"><div class="card-header"><h3>Adviser Performance Comparison</h3></div>
          <div style="overflow-x:auto"><table><thead><tr><th>Adviser</th><th>Clients</th><th>Active (7d)</th><th>Avg Fact Find</th><th>Total Coins</th><th>Avg Level</th><th>Avg Streak</th><th>Tokens</th><th>Status</th></tr></thead><tbody>`;
        data.by_advisor.forEach(a => {
          html += `<tr>
            <td><strong>${esc(a.name)}</strong><br><small style="color:var(--text-muted)">${esc(a.email)}</small></td>
            <td>${a.customer_count}</td><td>${a.active_7d}</td>
            <td><div class="progress-bar" style="width:60px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${pct(a.avg_fact_find)}%"></div></div> ${pct(a.avg_fact_find)}%</td>
            <td>${fmt(a.total_points)}</td><td>${Number(a.avg_level).toFixed(1)}</td><td>${Number(a.avg_streak).toFixed(1)}d</td><td>${fmt(a.total_tokens)}</td>
            <td><span class="badge ${a.status==='active'?'badge-active':'badge-inactive'}">${a.status}</span></td>
          </tr>`;
        });
        html += '</tbody></table></div></div>';
      }
    } else {
      const aid = currentUser.advisorId;
      if (!aid) { $('reports-content').innerHTML = '<div class="empty-state">No adviser profile linked to your account</div>'; return; }
      const data = await api('/analytics/advisor/' + aid);
      const s = data.stats;
      const customers = data.customers || [];

      html += `<div class="stat-grid">
        <div class="stat-card"><div class="stat-label">Total Clients</div><div class="stat-val">${fmt(s.total_customers)}</div></div>
        <div class="stat-card"><div class="stat-label">Active (7d)</div><div class="stat-val">${fmt(s.active_7d)}</div></div>
        <div class="stat-card"><div class="stat-label">Avg Fact Find</div><div class="stat-val">${pct(s.avg_fact_find)}%</div></div>
        <div class="stat-card"><div class="stat-label">Total Good Coins</div><div class="stat-val">${fmt(s.total_points)}</div></div>
      </div>`;

      const active7d = Number(s.active_7d);
      const inactive = Number(s.total_customers) - active7d;
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">';
      html += `<div class="card"><div class="card-header"><h3>Client Engagement</h3></div>
        <div class="chart-container">${renderPieChart([{label:'Active (7d)',value:active7d,color:'#10B981'},{label:'Inactive',value:inactive,color:'#EF4444'}], 100)}</div></div>`;

      if (customers.length > 0) {
        const ffRanges = [{label:'0-25%',min:0,max:25,color:'#EF4444'},{label:'26-50%',min:26,max:50,color:'#F59E0B'},{label:'51-75%',min:51,max:75,color:'#3B82F6'},{label:'76-100%',min:76,max:100,color:'#10B981'}];
        const ffData = ffRanges.map(r => ({label:r.label, value:customers.filter(c => c.fact_find_progress >= r.min && c.fact_find_progress <= r.max).length, color:r.color}));
        html += `<div class="card"><div class="card-header"><h3>Fact Find Completion</h3></div>
          <div class="chart-container">${renderPieChart(ffData, 100)}</div></div>`;
      }
      html += '</div>';

      if (customers.length > 0) {
        const pointsData = customers.filter(c => c.total_points_earned > 0).sort((a, b) => b.total_points_earned - a.total_points_earned).slice(0, 10);
        if (pointsData.length) {
          html += `<div class="card"><div class="card-header"><h3>Good Coins Distribution — Top Clients</h3></div>
            <div class="chart-container">${renderBarChart(pointsData.map(c => ({label: (c.name||'?').split(' ')[0], value: Number(c.total_points_earned)})), '#F59E0B')}</div></div>`;
        }

        const topClients = [...customers].sort((a, b) => (b.level * 1000 + b.streak * 10 + b.total_points_earned) - (a.level * 1000 + a.streak * 10 + a.total_points_earned)).slice(0, 5);
        html += `<div class="card"><div class="card-header"><h3>Top Performing Clients</h3></div>
          <table><thead><tr><th>Client</th><th>Level</th><th>Streak</th><th>Good Coins</th><th>Fact Find</th></tr></thead><tbody>`;
        topClients.forEach(c => {
          html += `<tr class="clickable" onclick="viewClient(${c.id})"><td><strong>${esc(c.name || 'Unnamed')}</strong></td><td>${c.level}</td><td>${c.streak}d</td><td>${fmt(c.total_points_earned)}</td><td>${pct(c.fact_find_progress)}%</td></tr>`;
        });
        html += '</tbody></table></div>';
      }
    }

    $('reports-content').innerHTML = html;
  } catch (e) {
    $('reports-content').innerHTML = '<div class="empty-state">Failed to load reports</div>';
  }
}

function renderPieChart(data, radius) {
  const total = data.reduce((s, d) => s + d.value, 0);
  if (total === 0) return '<div class="empty-state">No data</div>';
  const r = radius || 80;
  const cx = r + 10, cy = r + 10;
  let svg = `<svg width="${(r+10)*2}" height="${(r+10)*2}" viewBox="0 0 ${(r+10)*2} ${(r+10)*2}">`;
  let startAngle = -90;
  data.forEach(d => {
    if (d.value === 0) return;
    const pct = d.value / total;
    const angle = pct * 360;
    const endAngle = startAngle + angle;
    const largeArc = angle > 180 ? 1 : 0;
    const x1 = cx + r * Math.cos(startAngle * Math.PI / 180);
    const y1 = cy + r * Math.sin(startAngle * Math.PI / 180);
    const x2 = cx + r * Math.cos(endAngle * Math.PI / 180);
    const y2 = cy + r * Math.sin(endAngle * Math.PI / 180);
    if (data.filter(dd => dd.value > 0).length === 1) {
      svg += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${d.color}" opacity="0.8"/>`;
    } else {
      svg += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} Z" fill="${d.color}" opacity="0.8"/>`;
    }
    startAngle = endAngle;
  });
  svg += '</svg>';
  let legend = '<div class="chart-legend">';
  data.forEach(d => {
    const p = total > 0 ? ((d.value / total) * 100).toFixed(0) : 0;
    legend += `<div class="chart-legend-item"><div class="dot" style="background:${d.color}"></div>${d.label}: ${d.value} (${p}%)</div>`;
  });
  legend += '</div>';
  return svg + legend;
}

function renderBarChart(data, color) {
  if (!data.length) return '<div class="empty-state">No data</div>';
  const maxVal = Math.max(...data.map(d => d.value));
  const barW = Math.min(40, Math.floor(300 / data.length));
  const h = 160;
  const w = data.length * (barW + 8) + 20;
  let svg = `<svg width="${w}" height="${h + 30}" viewBox="0 0 ${w} ${h + 30}">`;
  data.forEach((d, i) => {
    const bh = maxVal > 0 ? (d.value / maxVal) * h : 0;
    const x = i * (barW + 8) + 10;
    const y = h - bh;
    svg += `<rect x="${x}" y="${y}" width="${barW}" height="${bh}" rx="4" fill="${color}" opacity="0.8"/>`;
    svg += `<text x="${x + barW / 2}" y="${h + 14}" text-anchor="middle" fill="#94A3B8" font-size="10" font-family="DM Sans">${d.label}</text>`;
    svg += `<text x="${x + barW / 2}" y="${y - 4}" text-anchor="middle" fill="#E2E8F0" font-size="10" font-family="DM Sans">${d.value}</text>`;
  });
  svg += '</svg>';
  return svg;
}

async function renderAdvisers() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Advisers</h1><p>Manage adviser team</p></div><div id="advisers-content"><div class="loading">Loading advisers...</div></div>`);
  try {
    const advisors = await api('/advisors');
    cache.advisors = advisors;
    let html = `<div style="margin-bottom:16px"><button class="btn btn-primary btn-sm" onclick="showAdviserModal()"><ion-icon name="add-outline"></ion-icon> Add Adviser</button></div>`;

    advisors.forEach(a => {
      html += `<div class="advisor-card">
        <div class="advisor-row">
          <div class="advisor-avatar">${initials(a.name)}</div>
          <div class="advisor-info">
            <h4>${esc(a.name)}</h4>
            <p>${esc(a.email)}${a.phone ? ' · ' + esc(a.phone) : ''}</p>
            ${a.specialization ? `<p style="color:var(--teal-light);font-size:11px;margin-top:2px">${esc(a.specialization)}</p>` : ''}
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <span class="badge ${a.status === 'active' ? 'badge-active' : 'badge-inactive'}">${a.status}</span>
            <button class="btn btn-secondary btn-sm" onclick="showAdviserModal(${a.id})"><ion-icon name="create-outline"></ion-icon></button>
            <button class="btn btn-secondary btn-sm" onclick="showCreateAdviserLogin(${a.id},'${esc(a.name)}','${esc(a.email)}')" title="Create Login"><ion-icon name="key-outline"></ion-icon></button>
            <button class="btn btn-danger btn-sm" onclick="deleteAdviser(${a.id})"><ion-icon name="trash-outline"></ion-icon></button>
          </div>
        </div>
        <div class="advisor-stats">
          <div class="advisor-stat"><strong>${a.customer_count}</strong>Clients</div>
          <div class="advisor-stat"><strong>${fmt(a.total_customer_points)}</strong>Total Coins</div>
          <div class="advisor-stat"><strong>${pct(a.avg_fact_find_progress)}%</strong>Avg Fact Find</div>
          ${a.license_number ? `<div class="advisor-stat"><strong>${esc(a.license_number)}</strong>License</div>` : ''}
        </div>
      </div>`;
    });

    if (advisors.length === 0) html += '<div class="empty-state">No advisers yet</div>';
    $('advisers-content').innerHTML = html;
  } catch (e) {
    $('advisers-content').innerHTML = '<div class="empty-state">Failed to load advisers</div>';
  }
}

function showAdviserModal(editId) {
  const a = editId ? (cache.advisors || []).find(x => x.id === editId) : null;
  showModal(`
    <h2>${a ? 'Edit Adviser' : 'Add New Adviser'}</h2>
    <div class="form-group"><label>Name</label><input id="m-adv-name" value="${esc(a?.name || '')}"></div>
    <div class="form-group"><label>Email</label><input id="m-adv-email" value="${esc(a?.email || '')}"></div>
    <div class="form-group"><label>Phone</label><input id="m-adv-phone" value="${esc(a?.phone || '')}"></div>
    <div class="form-group"><label>License Number</label><input id="m-adv-license" value="${esc(a?.license_number || '')}"></div>
    <div class="form-group"><label>Specialization</label><input id="m-adv-spec" value="${esc(a?.specialization || '')}" placeholder="e.g. Mortgage, Super, Insurance"></div>
    ${a ? `<div class="form-group"><label>Status</label><select id="m-adv-status"><option ${a.status==='active'?'selected':''}>active</option><option ${a.status==='inactive'?'selected':''}>inactive</option></select></div>` : ''}
    <div class="form-group"><label>Notes</label><textarea id="m-adv-notes">${esc(a?.notes || '')}</textarea></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveAdviser(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveAdviser(editId) {
  const data = {
    name: $('m-adv-name').value,
    email: $('m-adv-email').value,
    phone: $('m-adv-phone').value,
    license_number: $('m-adv-license').value,
    specialization: $('m-adv-spec').value,
    notes: $('m-adv-notes').value,
  };
  if (editId) {
    const st = $('m-adv-status');
    data.status = st ? st.value : 'active';
  }
  try {
    if (editId) await api('/advisors/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/advisors', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast(editId ? 'Adviser updated' : 'Adviser created');
    renderAdvisers();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteAdviser(id) {
  if (!confirm('Delete this adviser? Their clients will become unassigned.')) return;
  try {
    await api('/advisors/' + id, { method: 'DELETE' });
    toast('Adviser deleted');
    renderAdvisers();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

function showCreateAdviserLogin(advisorId, name, email) {
  showModal(`
    <h2>Create Login for ${esc(name)}</h2>
    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">This will create an admin account with the "adviser" role, linked to this adviser profile.</p>
    <div class="form-group"><label>Email</label><input id="m-login-email" value="${esc(email)}"></div>
    <div class="form-group"><label>Password</label><input type="password" id="m-login-pass" placeholder="Set a password"></div>
    <div class="form-group"><label>Display Name</label><input id="m-login-name" value="${esc(name)}"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createAdviserLogin(${advisorId})">Create Login</button>
    </div>
  `);
}

async function createAdviserLogin(advisorId) {
  const data = {
    email: $('m-login-email').value,
    password: $('m-login-pass').value,
    name: $('m-login-name').value,
    role: 'adviser',
    advisor_id: advisorId,
  };
  try {
    await api('/admin-users', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast('Login created successfully');
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

let messagesFilter = 'all';
let messagesCache = [];

async function renderMessages() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Tooltips, Pop-ups & FTUE</h1><p>Manage in-app messages and user guidance</p></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <div style="display:flex;gap:6px" id="msg-filters">
        <button class="btn btn-sm ${messagesFilter==='all'?'btn-primary':'btn-secondary'}" onclick="messagesFilter='all';renderMessages()">All</button>
        <button class="btn btn-sm ${messagesFilter==='tooltip'?'btn-primary':'btn-secondary'}" onclick="messagesFilter='tooltip';renderMessages()">Tooltips</button>
        <button class="btn btn-sm ${messagesFilter==='popup'?'btn-primary':'btn-secondary'}" onclick="messagesFilter='popup';renderMessages()">Pop-ups</button>
        <button class="btn btn-sm ${messagesFilter==='ftue'?'btn-primary':'btn-secondary'}" onclick="messagesFilter='ftue';renderMessages()">FTUE</button>
      </div>
      <button class="btn btn-primary btn-sm" onclick="showMessageModal()"><ion-icon name="add-outline"></ion-icon> New Message</button>
    </div>
    <div id="messages-content"><div class="loading">Loading...</div></div>`);
  try {
    const msgs = await api('/messages?type=' + messagesFilter);
    messagesCache = msgs;
    if (!msgs.length) { $('messages-content').innerHTML = '<div class="empty-state">No messages found</div>'; return; }
    let html = '<div class="card"><table><thead><tr><th>Type</th><th>Title</th><th>Target</th><th>Animation</th><th>Display Rule</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    msgs.forEach(m => {
      const typeBadge = m.type === 'tooltip' ? 'background:rgba(59,130,246,0.15);color:#60A5FA' : m.type === 'popup' ? 'background:rgba(139,92,246,0.15);color:#A78BFA' : 'background:rgba(16,185,129,0.15);color:#34D399';
      html += `<tr>
        <td><span class="badge" style="${typeBadge}">${m.type}</span></td>
        <td><strong style="color:#fff">${esc(m.title)}</strong>${m.body ? '<br><span style="font-size:11px;color:var(--text-muted)">' + esc(m.body).substring(0,60) + (m.body.length>60?'...':'') + '</span>' : ''}</td>
        <td>${m.target_screen || 'all'}</td>
        <td><span style="font-size:11px;color:var(--teal-light)">${m.animation_type || 'fade'}</span></td>
        <td>${m.display_rule}</td>
        <td>${m.priority}</td>
        <td><span class="badge ${m.is_active?'badge-active':'badge-inactive'}" style="cursor:pointer" onclick="toggleMessageActive(${m.id},${!m.is_active})">${m.is_active?'Active':'Inactive'}</span></td>
        <td><button class="btn btn-secondary btn-sm" onclick="showMessageModal(${m.id})" style="margin-right:4px"><ion-icon name="pencil-outline"></ion-icon></button><button class="btn btn-danger btn-sm" onclick="deleteMessage(${m.id})"><ion-icon name="trash-outline"></ion-icon></button></td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    $('messages-content').innerHTML = html;
  } catch (e) { $('messages-content').innerHTML = '<div class="empty-state">Failed to load messages</div>'; }
}

async function toggleMessageActive(id, active) {
  const msg = messagesCache.find(m => m.id === id);
  if (!msg) return;
  try {
    await api('/messages/' + id, { method: 'PUT', body: JSON.stringify({ ...msg, is_active: active }) });
    toast(active ? 'Message activated' : 'Message deactivated');
    renderMessages();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function showMessageModal(editId) {
  let msg = editId ? messagesCache.find(m => m.id === editId) : null;
  let segments = [];
  try { segments = await api('/segments'); } catch {}

  let segOpts = '<option value="">None</option>';
  segments.forEach(s => segOpts += `<option value="${s.id}" ${msg && msg.segment_id==s.id?'selected':''}>${esc(s.name)}</option>`);

  const screenOpts = ['overview','mortgage','super','budget','insurance','rewards','banks','planning','investor','fact-find','all']
    .map(s => `<option value="${s}" ${msg && msg.target_screen===s?'selected':''}>${s}</option>`).join('');

  showModal(`
    <h2>${editId ? 'Edit' : 'New'} Message</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Message ID (slug)</label><input id="m-msg-id" value="${msg?esc(msg.message_id):''}" ${editId?'readonly style="opacity:0.6"':''}></div>
      <div class="form-group"><label>Type</label><select id="m-msg-type"><option value="tooltip" ${msg&&msg.type==='tooltip'?'selected':''}>Tooltip</option><option value="popup" ${msg&&msg.type==='popup'?'selected':''}>Pop-up</option><option value="ftue" ${msg&&msg.type==='ftue'?'selected':''}>FTUE</option></select></div>
    </div>
    <div class="form-group"><label>Title</label><input id="m-msg-title" value="${msg?esc(msg.title):''}" oninput="if(!${!!editId}){document.getElementById('m-msg-id').value=this.value.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'')}"></div>
    <div class="form-group"><label>Body</label><textarea id="m-msg-body" rows="3">${msg?esc(msg.body||''):''}</textarea></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>CTA Text</label><input id="m-msg-cta" value="${msg?esc(msg.cta_text||''):''}"></div>
      <div class="form-group"><label>CTA Action (tab/URL)</label><input id="m-msg-action" value="${msg?esc(msg.cta_action||''):''}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Target Screen</label><select id="m-msg-screen">${screenOpts}</select></div>
      <div class="form-group"><label>Position</label><select id="m-msg-pos"><option value="center" ${msg&&msg.position==='center'?'selected':''}>Center</option><option value="bottom" ${msg&&msg.position==='bottom'?'selected':''}>Bottom</option><option value="top" ${msg&&msg.position==='top'?'selected':''}>Top</option><option value="left" ${msg&&msg.position==='left'?'selected':''}>Left</option><option value="right" ${msg&&msg.position==='right'?'selected':''}>Right</option></select></div>
    </div>
    <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px">
      <div class="form-group"><label>Icon (ionicons)</label><input id="m-msg-icon" value="${msg?esc(msg.icon||''):''}"></div>
      <div class="form-group"><label>Icon Color</label><input type="color" id="m-msg-iconcolor" value="${msg?msg.icon_color||'#0D9488':'#0D9488'}" style="height:38px"></div>
      <div class="form-group"><label>BG Color</label><input type="color" id="m-msg-bgcolor" value="${msg?msg.bg_color||'#132D46':'#132D46'}" style="height:38px"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Display Rule</label><select id="m-msg-rule"><option value="once" ${msg&&msg.display_rule==='once'?'selected':''}>Once</option><option value="every_session" ${msg&&msg.display_rule==='every_session'?'selected':''}>Every Session</option><option value="every_time" ${msg&&msg.display_rule==='every_time'?'selected':''}>Every Time</option><option value="first_time_only" ${msg&&msg.display_rule==='first_time_only'?'selected':''}>First Time Only</option></select></div>
      <div class="form-group"><label>Animation</label><select id="m-msg-anim"><option value="fade" ${msg&&msg.animation_type==='fade'?'selected':''}>Fade In</option><option value="slide_up" ${msg&&msg.animation_type==='slide_up'?'selected':''}>Slide Up</option><option value="slide_down" ${msg&&msg.animation_type==='slide_down'?'selected':''}>Slide Down</option><option value="slide_right" ${msg&&msg.animation_type==='slide_right'?'selected':''}>Slide Right</option><option value="bounce" ${msg&&msg.animation_type==='bounce'?'selected':''}>Bounce</option><option value="zoom" ${msg&&msg.animation_type==='zoom'?'selected':''}>Zoom</option><option value="flip" ${msg&&msg.animation_type==='flip'?'selected':''}>Flip</option><option value="pulse" ${msg&&msg.animation_type==='pulse'?'selected':''}>Pulse Glow</option><option value="confetti" ${msg&&msg.animation_type==='confetti'?'selected':''}>Confetti Burst</option></select></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="form-group"><label>Priority (1-10)</label><input type="number" id="m-msg-priority" min="1" max="10" value="${msg?msg.priority:5}"></div>
      <div class="form-group"><label>Delay (ms)</label><input type="number" id="m-msg-delay" min="0" value="${msg?msg.delay_ms:500}"></div>
      <div class="form-group"><label>Sort Order</label><input type="number" id="m-msg-sort" min="0" value="${msg?msg.sort_order:0}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Start Date</label><input type="datetime-local" id="m-msg-start" value="${msg&&msg.start_date?new Date(msg.start_date).toISOString().slice(0,16):''}"></div>
      <div class="form-group"><label>End Date</label><input type="datetime-local" id="m-msg-end" value="${msg&&msg.end_date?new Date(msg.end_date).toISOString().slice(0,16):''}"></div>
    </div>
    <div class="form-group"><label>Segment</label><select id="m-msg-segment">${segOpts}</select></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveMessage(${editId||'null'})">${editId?'Update':'Create'} Message</button>
    </div>
  `);
}

async function saveMessage(editId) {
  const data = {
    message_id: $('m-msg-id').value.trim(),
    type: $('m-msg-type').value,
    title: $('m-msg-title').value.trim(),
    body: $('m-msg-body').value.trim(),
    cta_text: $('m-msg-cta').value.trim() || null,
    cta_action: $('m-msg-action').value.trim() || null,
    target_screen: $('m-msg-screen').value,
    position: $('m-msg-pos').value,
    icon: $('m-msg-icon').value.trim() || null,
    icon_color: $('m-msg-iconcolor').value,
    bg_color: $('m-msg-bgcolor').value,
    display_rule: $('m-msg-rule').value,
    priority: parseInt($('m-msg-priority').value) || 5,
    delay_ms: parseInt($('m-msg-delay').value) || 500,
    is_active: editId ? (messagesCache.find(m=>m.id===editId)?.is_active ?? true) : true,
    start_date: $('m-msg-start').value || null,
    end_date: $('m-msg-end').value || null,
    segment_id: $('m-msg-segment').value ? parseInt($('m-msg-segment').value) : null,
    sort_order: parseInt($('m-msg-sort').value) || 0,
    animation_type: $('m-msg-anim').value || 'fade'
  };
  if (!data.message_id || !data.title) { toast('Message ID and Title are required', 'error'); return; }
  try {
    if (editId) {
      await api('/messages/' + editId, { method: 'PUT', body: JSON.stringify(data) });
      toast('Message updated');
    } else {
      await api('/messages', { method: 'POST', body: JSON.stringify(data) });
      toast('Message created');
    }
    hideModal();
    renderMessages();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteMessage(id) {
  if (!confirm('Delete this message?')) return;
  try {
    await api('/messages/' + id, { method: 'DELETE' });
    toast('Message deleted');
    renderMessages();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function renderSettings() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Settings</h1><p>Manage admin users, adviser profiles, and system access</p></div><div id="settings-content"><div class="loading">Loading...</div></div>`);
  try {
    const [users] = await Promise.all([api('/admin-users'), api('/advisors').then(a => { cache.advisors = a; }).catch(() => {})]);
    cache.adminUsers = users;
    let html = `<div class="card"><div class="card-header"><h3>Admin Users (${users.length})</h3><button class="btn btn-primary btn-sm" onclick="showCreateUserModal()"><ion-icon name="add-outline"></ion-icon> Add User</button></div>
      <table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Created</th><th>Last Login</th><th>Actions</th></tr></thead><tbody>`;
    users.forEach(u => {
      const roleBadge = u.role === 'god' ? 'badge-god' : u.role === 'adviser' ? 'badge-adviser' : 'badge-active';
      html += `<tr>
        <td><strong style="color:#fff">${esc(u.name)}</strong></td>
        <td>${esc(u.email)}</td>
        <td><span class="badge ${roleBadge}">${u.role}</span></td>
        <td>${fmtDate(u.created_at)}</td>
        <td>${u.last_login ? fmtDateTime(u.last_login) : '<span style="color:var(--text-muted)">Never</span>'}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-secondary btn-sm" onclick="showEditUserModal(${u.id})" title="Edit"><ion-icon name="create-outline"></ion-icon></button>
          <button class="btn btn-secondary btn-sm" onclick="showResetPasswordModal(${u.id},'${esc(u.name)}')" title="Reset Password" style="margin-left:4px"><ion-icon name="key-outline"></ion-icon></button>
          <button class="btn btn-danger btn-sm" onclick="deleteAdminUser(${u.id},'${esc(u.name)}')" title="Delete" style="margin-left:4px"><ion-icon name="trash-outline"></ion-icon></button>
        </td>
      </tr>`;
    });
    html += '</tbody></table></div>';

    html += `<div class="card" style="margin-top:20px"><div class="card-header"><h3>System</h3></div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="refreshApp()"><ion-icon name="refresh-outline"></ion-icon> Refresh &amp; Republish</button>
        <button class="btn btn-secondary" onclick="clearCacheAndReload()"><ion-icon name="trash-outline"></ion-icon> Clear Cache</button>
      </div>
      <p style="font-size:12px;color:var(--text-muted);margin-top:12px"><strong>Refresh &amp; Republish</strong> — Reloads the portal to pull the latest features. Use after new updates have been deployed.</p>
      <p style="font-size:12px;color:var(--text-muted);margin-top:4px"><strong>Clear Cache</strong> — Clears local cached data and reloads the portal.</p>
    </div>`;

    $('settings-content').innerHTML = html;
  } catch (e) {
    $('settings-content').innerHTML = '<div class="empty-state">Failed to load settings</div>';
  }
}

function showEditUserModal(userId) {
  const u = (cache.adminUsers || []).find(x => x.id === userId);
  if (!u) return;
  const advisors = cache.advisors || [];
  let advOpts = '<option value="">None</option>';
  advisors.forEach(a => advOpts += `<option value="${a.id}" ${u.advisor_id==a.id?'selected':''}>${esc(a.name)}</option>`);

  showModal(`
    <h2>Edit Admin User</h2>
    <div class="form-group"><label>Name</label><input id="m-eu-name" value="${esc(u.name)}"></div>
    <div class="form-group"><label>Email</label><input id="m-eu-email" value="${esc(u.email)}"></div>
    <div class="form-group"><label>Role</label><select id="m-eu-role" onchange="document.getElementById('m-eu-advisor-group').style.display=this.value==='adviser'?'block':'none'">
      <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
      <option value="adviser" ${u.role==='adviser'?'selected':''}>Adviser</option>
      <option value="god" ${u.role==='god'?'selected':''}>God</option>
    </select></div>
    <div class="form-group" id="m-eu-advisor-group" style="${u.role==='adviser'?'':'display:none'}"><label>Linked Adviser</label><select id="m-eu-advisor">${advOpts}</select></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="updateAdminUser(${userId})">Save Changes</button>
    </div>
  `);
}

async function updateAdminUser(userId) {
  const data = {
    name: $('m-eu-name').value,
    email: $('m-eu-email').value,
    role: $('m-eu-role').value,
  };
  if (data.role === 'adviser') {
    const av = $('m-eu-advisor');
    if (av && av.value) data.advisor_id = parseInt(av.value);
  }
  try {
    await api('/admin-users/' + userId, { method: 'PUT', body: JSON.stringify(data) });
    hideModal();
    toast('User updated');
    renderSettings();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

function showResetPasswordModal(userId, name) {
  showModal(`
    <h2>Reset Password</h2>
    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">Set a new password for <strong style="color:#fff">${esc(name)}</strong></p>
    <div class="form-group"><label>New Password</label><input type="password" id="m-rp-pass" placeholder="Min 6 characters"></div>
    <div class="form-group"><label>Confirm Password</label><input type="password" id="m-rp-confirm" placeholder="Re-enter password"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="resetUserPassword(${userId})">Reset Password</button>
    </div>
  `);
}

async function resetUserPassword(userId) {
  const pass = $('m-rp-pass').value;
  const confirm = $('m-rp-confirm').value;
  if (!pass || pass.length < 6) { toast('Password must be at least 6 characters', 'error'); return; }
  if (pass !== confirm) { toast('Passwords do not match', 'error'); return; }
  try {
    await api('/admin-users/' + userId + '/password', { method: 'PUT', body: JSON.stringify({ password: pass }) });
    hideModal();
    toast('Password reset successfully');
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteAdminUser(userId, name) {
  if (!confirm('Delete admin user "' + name + '"? This cannot be undone.')) return;
  try {
    await api('/admin-users/' + userId, { method: 'DELETE' });
    toast('User deleted');
    renderSettings();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

function clearCacheAndReload() {
  cache = {};
  localStorage.removeItem('adviser_user');
  toast('Cache cleared, reloading...', 'info');
  setTimeout(() => window.location.reload(), 800);
}

function showCreateUserModal() {
  const advisors = cache.advisors || [];
  let advOpts = '<option value="">None</option>';
  advisors.forEach(a => advOpts += `<option value="${a.id}">${esc(a.name)}</option>`);

  showModal(`
    <h2>Create Admin User</h2>
    <div class="form-group"><label>Name</label><input id="m-user-name"></div>
    <div class="form-group"><label>Email</label><input id="m-user-email"></div>
    <div class="form-group"><label>Password</label><input type="password" id="m-user-pass"></div>
    <div class="form-group"><label>Role</label><select id="m-user-role" onchange="document.getElementById('m-user-advisor-group').style.display=this.value==='adviser'?'block':'none'">
      <option value="admin">Admin</option>
      <option value="adviser">Adviser</option>
      <option value="god">God</option>
    </select></div>
    <div class="form-group" id="m-user-advisor-group" style="display:none"><label>Linked Adviser</label><select id="m-user-advisor">${advOpts}</select></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createUser()">Create User</button>
    </div>
  `);
}

async function createUser() {
  const data = {
    name: $('m-user-name').value,
    email: $('m-user-email').value,
    password: $('m-user-pass').value,
    role: $('m-user-role').value,
  };
  if (data.role === 'adviser') {
    const av = $('m-user-advisor');
    if (av && av.value) data.advisor_id = parseInt(av.value);
  }
  try {
    await api('/admin-users', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast('User created');
    renderSettings();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

let questTypeFilter = 'all';
async function renderQuests() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Quests & Missions</h1><p>Manage in-app quests and missions for users</p></div><div id="quests-content"><div class="loading">Loading...</div></div>`);
  try {
    const quests = await api('/quests');
    cache.quests = quests;
    let segments = [];
    try { segments = await api('/segments'); cache.segments = segments; } catch {}

    let html = `<div class="card"><div class="card-header"><h3>All Quests (${quests.length})</h3><button class="btn btn-primary btn-sm" onclick="showQuestModal()"><ion-icon name="add-outline"></ion-icon> Add Quest</button></div>`;
    html += `<table><thead><tr><th>Icon</th><th>Title</th><th>Description</th><th>Base Coins</th><th>2x Active</th><th>Category</th><th>Segment</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    quests.forEach(q => {
      const statusBadge = q.is_active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>';
      const twoxBadge = q.is_2x_active ? '<span class="badge badge-god">2x</span>' : '<span style="color:var(--text-muted);font-size:12px">—</span>';
      html += `<tr>
        <td><ion-icon name="${esc(q.icon || 'help-outline')}" style="font-size:20px;color:${esc(q.icon_bg || 'var(--teal)')}"></ion-icon></td>
        <td><strong>${esc(q.title)}</strong></td>
        <td style="max-width:220px;font-size:12px;color:var(--text-secondary)">${esc(q.description || '')}</td>
        <td>${fmt(q.base_points)}</td>
        <td>${twoxBadge}</td>
        <td><span style="font-size:12px;color:var(--text-muted)">${esc(q.category || 'mission')}</span></td>
        <td>${q.segment_name ? '<span class="badge badge-adviser">' + esc(q.segment_name) + '</span>' : '<span style="font-size:12px;color:var(--text-muted)">All</span>'}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="showQuestModal(${q.id})" style="margin-right:4px"><ion-icon name="create-outline"></ion-icon></button>
          <button class="btn btn-danger btn-sm" onclick="deleteQuest(${q.id})"><ion-icon name="trash-outline"></ion-icon></button>
        </td>
      </tr>`;
    });
    if (quests.length === 0) html += '<tr><td colspan="9" class="empty-state">No quests configured</td></tr>';
    html += '</tbody></table></div>';
    $('quests-content').innerHTML = html;
  } catch (e) {
    $('quests-content').innerHTML = '<div class="empty-state">Failed to load quests</div>';
  }
}

function showQuestModal(editId) {
  const q = editId ? (cache.quests || []).find(x => x.id === editId) : null;
  const segments = cache.segments || [];
  let segOpts = '<option value="">All Users</option>';
  segments.forEach(s => segOpts += `<option value="${s.id}" ${q && q.segment_id == s.id ? 'selected' : ''}>${esc(s.name)}</option>`);

  showModal(`
    <h2>${q ? 'Edit Quest' : 'Add New Quest'}</h2>
    ${!q ? '<div class="form-group"><label>Quest ID (slug)</label><input id="m-q-qid" placeholder="e.g. review_super"></div>' : ''}
    <div class="form-group"><label>Title</label><input id="m-q-title" value="${esc(q?.title || '')}"></div>
    <div class="form-group"><label>Description</label><textarea id="m-q-desc">${esc(q?.description || '')}</textarea></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Icon (Ionicons)</label><input id="m-q-icon" value="${esc(q?.icon || 'help-outline')}" placeholder="e.g. shield-checkmark-outline"></div>
      <div class="form-group"><label>Icon Background</label><input id="m-q-iconbg" type="color" value="${q?.icon_bg || '#3B82F6'}" style="height:40px"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="form-group"><label>Base Coins</label><input id="m-q-points" type="number" value="${q?.base_points || 100}"></div>
      <div class="form-group"><label>Category</label><select id="m-q-cat"><option value="mission" ${(!q || q.category === 'mission') ? 'selected' : ''}>Mission</option><option value="daily" ${q?.category === 'daily' ? 'selected' : ''}>Daily</option><option value="weekly" ${q?.category === 'weekly' ? 'selected' : ''}>Weekly</option><option value="special" ${q?.category === 'special' ? 'selected' : ''}>Special</option></select></div>
      <div class="form-group"><label>Sort Order</label><input id="m-q-sort" type="number" value="${q?.sort_order || 0}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>2x Multiplier Active</label><select id="m-q-2x"><option value="false" ${!q?.is_2x_active ? 'selected' : ''}>No</option><option value="true" ${q?.is_2x_active ? 'selected' : ''}>Yes</option></select></div>
      <div class="form-group"><label>Segment</label><select id="m-q-seg">${segOpts}</select></div>
    </div>
    ${q ? `<div class="form-group"><label>Status</label><select id="m-q-active"><option value="true" ${q.is_active ? 'selected' : ''}>Active</option><option value="false" ${!q.is_active ? 'selected' : ''}>Inactive</option></select></div>` : ''}
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveQuest(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveQuest(editId) {
  const data = {
    title: $('m-q-title').value,
    description: $('m-q-desc').value,
    icon: $('m-q-icon').value,
    icon_bg: $('m-q-iconbg').value,
    base_points: parseInt($('m-q-points').value) || 100,
    is_2x_active: $('m-q-2x').value === 'true',
    category: $('m-q-cat').value,
    sort_order: parseInt($('m-q-sort').value) || 0,
    segment_id: $('m-q-seg').value || null,
  };
  if (!editId) data.quest_id = $('m-q-qid').value;
  if (editId) data.is_active = $('m-q-active').value === 'true';
  try {
    if (editId) await api('/quests/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/quests', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast(editId ? 'Quest updated' : 'Quest created');
    renderQuests();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteQuest(id) {
  if (!confirm('Delete this quest?')) return;
  try {
    await api('/quests/' + id, { method: 'DELETE' });
    toast('Quest deleted');
    renderQuests();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

let ctaTabFilter = 'all';
async function renderCTAs() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Sales CTAs</h1><p>Manage call-to-action banners shown on each app tab</p></div><div id="ctas-content"><div class="loading">Loading...</div></div>`);
  try {
    const ctas = await api('/ctas');
    cache.ctas = ctas;
    let segments = [];
    try { segments = await api('/segments'); cache.segments = segments; } catch {}

    const tabs = [...new Set(ctas.map(c => c.tab_key))].sort();
    let filterHtml = `<div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">`;
    filterHtml += `<button class="btn btn-sm ${ctaTabFilter === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="ctaTabFilter='all';renderCTAs()">All</button>`;
    tabs.forEach(t => {
      filterHtml += `<button class="btn btn-sm ${ctaTabFilter === t ? 'btn-primary' : 'btn-secondary'}" onclick="ctaTabFilter='${t}';renderCTAs()">${esc(t.charAt(0).toUpperCase() + t.slice(1))}</button>`;
    });
    filterHtml += '</div>';

    const filtered = ctaTabFilter === 'all' ? ctas : ctas.filter(c => c.tab_key === ctaTabFilter);

    let html = filterHtml;
    html += `<div class="card"><div class="card-header"><h3>CTAs (${filtered.length})</h3><button class="btn btn-primary btn-sm" onclick="showCTAModal()"><ion-icon name="add-outline"></ion-icon> Add CTA</button></div>`;
    html += `<table><thead><tr><th>Icon</th><th>Tab</th><th>CTA Text</th><th>Segment</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    filtered.forEach(c => {
      const statusBadge = c.is_active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>';
      html += `<tr>
        <td><ion-icon name="${esc(c.icon || 'megaphone-outline')}" style="font-size:20px;color:${esc(c.icon_color || 'var(--teal)')}"></ion-icon></td>
        <td><span class="badge" style="background:rgba(13,148,136,0.15);color:var(--teal-light)">${esc(c.tab_label || c.tab_key)}</span></td>
        <td><strong>${esc(c.cta_text)}</strong></td>
        <td>${c.segment_name ? '<span class="badge badge-adviser">' + esc(c.segment_name) + '</span>' : '<span style="font-size:12px;color:var(--text-muted)">All</span>'}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="showCTAModal(${c.id})" style="margin-right:4px"><ion-icon name="create-outline"></ion-icon></button>
          <button class="btn btn-danger btn-sm" onclick="deleteCTA(${c.id})"><ion-icon name="trash-outline"></ion-icon></button>
        </td>
      </tr>`;
    });
    if (filtered.length === 0) html += '<tr><td colspan="6" class="empty-state">No CTAs found</td></tr>';
    html += '</tbody></table></div>';
    $('ctas-content').innerHTML = html;
  } catch (e) {
    $('ctas-content').innerHTML = '<div class="empty-state">Failed to load CTAs</div>';
  }
}

function showCTAModal(editId) {
  const c = editId ? (cache.ctas || []).find(x => x.id === editId) : null;
  const segments = cache.segments || [];
  let segOpts = '<option value="">All Users</option>';
  segments.forEach(s => segOpts += `<option value="${s.id}" ${c && c.segment_id == s.id ? 'selected' : ''}>${esc(s.name)}</option>`);

  const tabOptions = ['mortgage','super','insurance','savings','rewards','banks','budget','planning','fact_find','investor','overview'].map(t =>
    `<option value="${t}" ${c?.tab_key === t ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1).replace('_',' ')}</option>`
  ).join('');

  showModal(`
    <h2>${c ? 'Edit CTA' : 'Add New CTA'}</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Tab</label><select id="m-cta-tab" onchange="var l=$('m-cta-label');if(!l.value||l.dataset.auto)l.value=this.options[this.selectedIndex].text,l.dataset.auto='1'">${tabOptions}</select></div>
      <div class="form-group"><label>Tab Label</label><input id="m-cta-label" value="${esc(c?.tab_label || '')}" ${!c ? 'data-auto="1"' : ''}></div>
    </div>
    <div class="form-group"><label>CTA Text</label><input id="m-cta-text" value="${esc(c?.cta_text || '')}" placeholder="e.g. Get a free rate review"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Icon (Ionicons)</label><input id="m-cta-icon" value="${esc(c?.icon || 'megaphone-outline')}" placeholder="e.g. home-outline"></div>
      <div class="form-group"><label>Icon Color</label><input id="m-cta-color" type="color" value="${c?.icon_color || '#0D9488'}" style="height:40px"></div>
    </div>
    <div class="form-group"><label>Segment</label><select id="m-cta-seg">${segOpts}</select></div>
    ${c ? `<div class="form-group"><label>Status</label><select id="m-cta-active"><option value="true" ${c.is_active ? 'selected' : ''}>Active</option><option value="false" ${!c.is_active ? 'selected' : ''}>Inactive</option></select></div>` : ''}
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCTA(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveCTA(editId) {
  const data = {
    cta_text: $('m-cta-text').value,
    icon: $('m-cta-icon').value,
    icon_color: $('m-cta-color').value,
    segment_id: $('m-cta-seg').value || null,
  };
  if (!editId) {
    data.tab_key = $('m-cta-tab').value;
    data.tab_label = $('m-cta-label').value;
  }
  if (editId) data.is_active = $('m-cta-active').value === 'true';
  try {
    if (editId) await api('/ctas/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/ctas', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast(editId ? 'CTA updated' : 'CTA created');
    renderCTAs();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteCTA(id) {
  if (!confirm('Delete this CTA?')) return;
  try {
    await api('/ctas/' + id, { method: 'DELETE' });
    toast('CTA deleted');
    renderCTAs();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

let contentReportsDays = 30;
let contentReportsType = 'all';
async function renderContentReports() {
  if (!isGod() && !(currentUser && currentUser.role === 'adviser')) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Content Reports</h1><p>FTUE, CTA & message performance analytics</p></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <div style="display:flex;gap:6px">
        <button class="btn btn-sm ${contentReportsType==='all'?'btn-primary':'btn-secondary'}" onclick="contentReportsType='all';renderContentReports()">All</button>
        <button class="btn btn-sm ${contentReportsType==='ftue'?'btn-primary':'btn-secondary'}" onclick="contentReportsType='ftue';renderContentReports()">FTUE</button>
        <button class="btn btn-sm ${contentReportsType==='popup'?'btn-primary':'btn-secondary'}" onclick="contentReportsType='popup';renderContentReports()">Popups</button>
        <button class="btn btn-sm ${contentReportsType==='tooltip'?'btn-primary':'btn-secondary'}" onclick="contentReportsType='tooltip';renderContentReports()">Tooltips</button>
        <button class="btn btn-sm ${contentReportsType==='cta'?'btn-primary':'btn-secondary'}" onclick="contentReportsType='cta';renderContentReports()">CTAs</button>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <span style="font-size:12px;color:var(--text-muted)">Period:</span>
        <button class="btn btn-sm ${contentReportsDays===7?'btn-primary':'btn-secondary'}" onclick="contentReportsDays=7;renderContentReports()">7d</button>
        <button class="btn btn-sm ${contentReportsDays===14?'btn-primary':'btn-secondary'}" onclick="contentReportsDays=14;renderContentReports()">14d</button>
        <button class="btn btn-sm ${contentReportsDays===30?'btn-primary':'btn-secondary'}" onclick="contentReportsDays=30;renderContentReports()">30d</button>
        <button class="btn btn-sm ${contentReportsDays===90?'btn-primary':'btn-secondary'}" onclick="contentReportsDays=90;renderContentReports()">90d</button>
      </div>
    </div>
    <div id="cr-content"><div class="loading">Loading reports...</div></div>`);

  try {
    const data = await api('/content-reports?days=' + contentReportsDays + '&content_type=' + contentReportsType);
    let html = '';

    const totals = { impressions: 0, clicks: 0, dismissals: 0, conversions: 0, unique_users: 0 };
    (data.summary || []).forEach(s => {
      if (s.event_type === 'impression') { totals.impressions += parseInt(s.count); totals.unique_users += parseInt(s.unique_users); }
      if (s.event_type === 'click' || s.event_type === 'cta_click') totals.clicks += parseInt(s.count);
      if (s.event_type === 'dismiss') totals.dismissals += parseInt(s.count);
      if (s.event_type === 'conversion') totals.conversions += parseInt(s.count);
    });
    const clickRate = totals.impressions > 0 ? ((totals.clicks / totals.impressions) * 100).toFixed(1) : '0.0';
    const dismissRate = totals.impressions > 0 ? ((totals.dismissals / totals.impressions) * 100).toFixed(1) : '0.0';

    html += `<div class="stat-grid">
      <div class="stat-card"><div class="stat-icon" style="background:rgba(59,130,246,0.15);color:#60A5FA"><ion-icon name="eye-outline"></ion-icon></div><div class="stat-label">Total Impressions</div><div class="stat-val">${fmt(totals.impressions)}</div><div class="stat-sub">${fmt(totals.unique_users)} unique users</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(16,185,129,0.15);color:#34D399"><ion-icon name="finger-print-outline"></ion-icon></div><div class="stat-label">CTA Clicks</div><div class="stat-val">${fmt(totals.clicks)}</div><div class="stat-sub">${clickRate}% click rate</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(239,68,68,0.15);color:#F87171"><ion-icon name="close-circle-outline"></ion-icon></div><div class="stat-label">Dismissals</div><div class="stat-val">${fmt(totals.dismissals)}</div><div class="stat-sub">${dismissRate}% dismiss rate</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(139,92,246,0.15);color:#A78BFA"><ion-icon name="checkmark-done-outline"></ion-icon></div><div class="stat-label">Conversions</div><div class="stat-val">${fmt(totals.conversions)}</div><div class="stat-sub">${totals.clicks > 0 ? ((totals.conversions / totals.clicks) * 100).toFixed(1) : '0.0'}% conversion rate</div></div>
    </div>`;

    const items = data.content_items || [];
    if (items.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Per-Element Breakdown</h3></div>
        <table><thead><tr><th>Type</th><th>Content ID</th><th>Impressions</th><th>CTA Clicks</th><th>Click Rate</th><th>Dismissals</th><th>Dismiss Rate</th></tr></thead><tbody>`;
      items.sort((a,b) => b.impressions - a.impressions).forEach(item => {
        const typeBadge = item.content_type === 'tooltip' ? 'background:rgba(59,130,246,0.15);color:#60A5FA' : item.content_type === 'popup' ? 'background:rgba(139,92,246,0.15);color:#A78BFA' : item.content_type === 'ftue' ? 'background:rgba(16,185,129,0.15);color:#34D399' : 'background:rgba(245,158,11,0.15);color:#FBBF24';
        html += `<tr>
          <td><span class="badge" style="${typeBadge}">${item.content_type}</span></td>
          <td><strong style="color:#fff">${esc(item.content_id)}</strong></td>
          <td>${fmt(item.impressions)}<br><span style="font-size:11px;color:var(--text-muted)">${fmt(item.unique_impressions)} unique</span></td>
          <td>${fmt(item.cta_clicks || item.clicks)}</td>
          <td><span style="color:${parseFloat(item.click_rate) > 5 ? '#34D399' : parseFloat(item.click_rate) > 0 ? '#FBBF24' : 'var(--text-muted)'}">${item.click_rate}%</span></td>
          <td>${fmt(item.dismissals)}</td>
          <td><span style="color:${parseFloat(item.dismiss_rate) > 50 ? '#F87171' : 'var(--text-secondary)'}">${item.dismiss_rate}%</span></td>
        </tr>`;
      });
      html += '</tbody></table></div>';
    } else {
      html += '<div class="card"><div class="empty-state">No content events recorded yet. Events will appear once users interact with FTUE, tooltips, popups, and CTAs in the app.</div></div>';
    }

    const trends = data.daily_trends || [];
    if (trends.length > 0) {
      const dailyMap = {};
      trends.forEach(t => {
        if (!dailyMap[t.date]) dailyMap[t.date] = { impressions: 0, clicks: 0, dismissals: 0 };
        if (t.event_type === 'impression') dailyMap[t.date].impressions += parseInt(t.count);
        if (t.event_type === 'click' || t.event_type === 'cta_click') dailyMap[t.date].clicks += parseInt(t.count);
        if (t.event_type === 'dismiss') dailyMap[t.date].dismissals += parseInt(t.count);
      });
      const dates = Object.keys(dailyMap).sort().slice(-14);
      const maxVal = Math.max(...dates.map(d => dailyMap[d].impressions), 1);

      html += `<div class="card"><div class="card-header"><h3>Daily Trend (Last 14 Days)</h3></div>
        <div style="display:flex;gap:4px;align-items:flex-end;height:140px;padding:10px 0">`;
      dates.forEach(d => {
        const day = dailyMap[d];
        const h = Math.max((day.impressions / maxVal) * 120, 4);
        const clickH = Math.max((day.clicks / maxVal) * 120, 0);
        const dLabel = new Date(d).toLocaleDateString('en-AU', { day: 'numeric', month: 'short' });
        html += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px" title="${dLabel}: ${day.impressions} impressions, ${day.clicks} clicks">
          <div style="width:100%;max-width:30px;height:${h}px;background:rgba(59,130,246,0.4);border-radius:4px 4px 0 0;position:relative">
            <div style="position:absolute;bottom:0;width:100%;height:${clickH}px;background:var(--teal);border-radius:0 0 4px 4px;opacity:0.8"></div>
          </div>
          <span style="font-size:9px;color:var(--text-muted);white-space:nowrap">${dLabel.split(' ')[0]}</span>
        </div>`;
      });
      html += `</div>
        <div style="display:flex;gap:16px;margin-top:8px;justify-content:center">
          <span style="font-size:11px;color:var(--text-muted)"><span style="display:inline-block;width:10px;height:10px;background:rgba(59,130,246,0.4);border-radius:2px;vertical-align:middle;margin-right:4px"></span>Impressions</span>
          <span style="font-size:11px;color:var(--text-muted)"><span style="display:inline-block;width:10px;height:10px;background:var(--teal);border-radius:2px;vertical-align:middle;margin-right:4px"></span>Clicks</span>
        </div></div>`;
    }

    const msgList = data.messages || [];
    const ctaList = data.ctas || [];
    if (msgList.length > 0 || ctaList.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Recommendation Status</h3></div>
        <table><thead><tr><th>Type</th><th>Name</th><th>Status</th><th>Recommendations</th><th>Dynamic Content</th></tr></thead><tbody>`;
      msgList.forEach(m => {
        const typeBadge = m.type === 'tooltip' ? 'background:rgba(59,130,246,0.15);color:#60A5FA' : m.type === 'popup' ? 'background:rgba(139,92,246,0.15);color:#A78BFA' : 'background:rgba(16,185,129,0.15);color:#34D399';
        html += `<tr>
          <td><span class="badge" style="${typeBadge}">${m.type}</span></td>
          <td><strong style="color:#fff">${esc(m.title)}</strong><br><span style="font-size:11px;color:var(--text-muted)">${esc(m.message_id)}</span></td>
          <td><span class="badge ${m.is_active ? 'badge-active' : 'badge-inactive'}">${m.is_active ? 'Active' : 'Inactive'}</span></td>
          <td><span class="badge" style="${m.recommendation_enabled ? 'background:rgba(16,185,129,0.15);color:#34D399' : 'background:rgba(100,116,139,0.15);color:#94A3B8'}">${m.recommendation_enabled ? 'On' : 'Off'}</span></td>
          <td><span class="badge" style="${m.dynamic_content_enabled ? 'background:rgba(139,92,246,0.15);color:#A78BFA' : 'background:rgba(100,116,139,0.15);color:#94A3B8'}">${m.dynamic_content_enabled ? 'On' : 'Off'}</span></td>
        </tr>`;
      });
      ctaList.forEach(c => {
        html += `<tr>
          <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FBBF24">cta</span></td>
          <td><strong style="color:#fff">${esc(c.cta_text)}</strong><br><span style="font-size:11px;color:var(--text-muted)">${esc(c.tab_key)}</span></td>
          <td><span class="badge ${c.is_active ? 'badge-active' : 'badge-inactive'}">${c.is_active ? 'Active' : 'Inactive'}</span></td>
          <td><span class="badge" style="${c.recommendation_enabled ? 'background:rgba(16,185,129,0.15);color:#34D399' : 'background:rgba(100,116,139,0.15);color:#94A3B8'}">${c.recommendation_enabled ? 'On' : 'Off'}</span></td>
          <td><span class="badge" style="${c.dynamic_content_enabled ? 'background:rgba(139,92,246,0.15);color:#A78BFA' : 'background:rgba(100,116,139,0.15);color:#94A3B8'}">${c.dynamic_content_enabled ? 'On' : 'Off'}</span></td>
        </tr>`;
      });
      html += '</tbody></table></div>';
    }

    $('cr-content').innerHTML = html;
  } catch (e) {
    $('cr-content').innerHTML = '<div class="empty-state">Failed to load content reports</div>';
  }
}

async function renderOptimization() {
  if (!isGod() && !(currentUser && currentUser.role === 'adviser')) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Content Optimization</h1><p>Control dynamic content delivery and per-element recommendations</p></div>
    <div id="opt-content"><div class="loading">Loading optimization settings...</div></div>`);

  try {
    const data = await api('/optimization');
    const settings = data.settings || [];
    const messages = data.messages || [];
    const ctas = data.ctas || [];
    let html = '';

    html += `<div class="card"><div class="card-header"><h3>Global Settings</h3></div>
      <div style="display:grid;gap:16px">`;
    settings.forEach(s => {
      const isOn = s.setting_value === 'true';
      const label = s.setting_key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--card-border)">
        <div>
          <div style="font-weight:600;color:#fff;font-size:14px">${label}</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:2px">${esc(s.description || '')}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:12px;color:${isOn ? '#34D399' : 'var(--text-muted)'}">${isOn ? 'Enabled' : 'Disabled'}</span>
          <button class="btn btn-sm ${isOn ? 'btn-primary' : 'btn-secondary'}" onclick="toggleOptSetting('${esc(s.setting_key)}', ${!isOn})">
            <ion-icon name="${isOn ? 'toggle' : 'toggle-outline'}"></ion-icon> ${isOn ? 'Disable' : 'Enable'}
          </button>
        </div>
      </div>`;
    });
    html += '</div></div>';

    if (messages.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Messages — Per-Element Controls</h3></div>
        <table><thead><tr><th>Type</th><th>Title</th><th>Status</th><th>Recommendations</th><th>Dynamic Content</th></tr></thead><tbody>`;
      messages.forEach(m => {
        const typeBadge = m.type === 'tooltip' ? 'background:rgba(59,130,246,0.15);color:#60A5FA' : m.type === 'popup' ? 'background:rgba(139,92,246,0.15);color:#A78BFA' : 'background:rgba(16,185,129,0.15);color:#34D399';
        html += `<tr>
          <td><span class="badge" style="${typeBadge}">${m.type}</span></td>
          <td><strong style="color:#fff">${esc(m.title)}</strong><br><span style="font-size:11px;color:var(--text-muted)">${esc(m.message_id)}</span></td>
          <td><span class="badge ${m.is_active ? 'badge-active' : 'badge-inactive'}">${m.is_active ? 'Active' : 'Inactive'}</span></td>
          <td>
            <button class="btn btn-sm ${m.recommendation_enabled ? 'btn-primary' : 'btn-secondary'}" onclick="toggleMsgOpt(${m.id}, 'recommendation_enabled', ${!m.recommendation_enabled})">
              <ion-icon name="${m.recommendation_enabled ? 'checkmark-circle' : 'ellipse-outline'}"></ion-icon> ${m.recommendation_enabled ? 'On' : 'Off'}
            </button>
          </td>
          <td>
            <button class="btn btn-sm ${m.dynamic_content_enabled ? 'btn-primary' : 'btn-secondary'}" onclick="toggleMsgOpt(${m.id}, 'dynamic_content_enabled', ${!m.dynamic_content_enabled})">
              <ion-icon name="${m.dynamic_content_enabled ? 'flash' : 'flash-outline'}"></ion-icon> ${m.dynamic_content_enabled ? 'On' : 'Off'}
            </button>
          </td>
        </tr>`;
      });
      html += '</tbody></table></div>';
    }

    if (ctas.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Sales CTAs — Per-Element Controls</h3></div>
        <table><thead><tr><th>Tab</th><th>CTA Text</th><th>Status</th><th>Recommendations</th><th>Dynamic Content</th></tr></thead><tbody>`;
      ctas.forEach(c => {
        html += `<tr>
          <td><span class="badge" style="background:rgba(245,158,11,0.15);color:#FBBF24">${esc(c.tab_label || c.tab_key)}</span></td>
          <td><strong style="color:#fff">${esc(c.cta_text)}</strong></td>
          <td><span class="badge ${c.is_active ? 'badge-active' : 'badge-inactive'}">${c.is_active ? 'Active' : 'Inactive'}</span></td>
          <td>
            <button class="btn btn-sm ${c.recommendation_enabled ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCtaOpt(${c.id}, 'recommendation_enabled', ${!c.recommendation_enabled})">
              <ion-icon name="${c.recommendation_enabled ? 'checkmark-circle' : 'ellipse-outline'}"></ion-icon> ${c.recommendation_enabled ? 'On' : 'Off'}
            </button>
          </td>
          <td>
            <button class="btn btn-sm ${c.dynamic_content_enabled ? 'btn-primary' : 'btn-secondary'}" onclick="toggleCtaOpt(${c.id}, 'dynamic_content_enabled', ${!c.dynamic_content_enabled})">
              <ion-icon name="${c.dynamic_content_enabled ? 'flash' : 'flash-outline'}"></ion-icon> ${c.dynamic_content_enabled ? 'On' : 'Off'}
            </button>
          </td>
        </tr>`;
      });
      html += '</tbody></table></div>';
    }

    $('opt-content').innerHTML = html;
  } catch (e) {
    $('opt-content').innerHTML = '<div class="empty-state">Failed to load optimization settings</div>';
  }
}

async function toggleOptSetting(key, value) {
  try {
    await api('/optimization/settings/' + key, { method: 'PUT', body: JSON.stringify({ value: String(value) }) });
    toast(value ? 'Setting enabled' : 'Setting disabled');
    renderOptimization();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function toggleMsgOpt(id, field, value) {
  try {
    const body = {};
    body[field] = value;
    await api('/optimization/message/' + id, { method: 'PUT', body: JSON.stringify(body) });
    toast('Message updated');
    renderOptimization();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function toggleCtaOpt(id, field, value) {
  try {
    const body = {};
    body[field] = value;
    await api('/optimization/cta/' + id, { method: 'PUT', body: JSON.stringify(body) });
    toast('CTA updated');
    renderOptimization();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

// ========== Marketing: Campaigns Page ==========
let campaignStatusFilter = 'all';
let campaignDetailId = null;
async function renderCampaigns(detailId) {
  if (!isGod()) { navigate('dashboard'); return; }
  if (detailId || campaignDetailId) { renderCampaignDetail(detailId || campaignDetailId); return; }
  setMain(`<div class="page-header"><h1>Marketing Campaigns</h1><p>Create, manage, and optimize campaigns</p></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <div style="display:flex;gap:6px">
        ${['all','draft','active','paused','completed','archived'].map(s => `<button class="btn btn-sm ${campaignStatusFilter===s?'btn-primary':'btn-secondary'}" onclick="campaignStatusFilter='${s}';campaignDetailId=null;renderCampaigns()">${s.charAt(0).toUpperCase()+s.slice(1)}</button>`).join('')}
      </div>
      <button class="btn btn-primary btn-sm" onclick="showCampaignModal()"><ion-icon name="add-outline"></ion-icon> New Campaign</button>
    </div>
    <div id="campaigns-content"><div class="loading">Loading campaigns...</div></div>`);
  try {
    const url = '/campaigns' + (campaignStatusFilter !== 'all' ? '?status=' + campaignStatusFilter : '');
    const campaigns = await api(url);
    cache.campaigns = campaigns;
    let html = '';
    if (campaigns.length === 0) {
      html = '<div class="card"><div class="empty-state">No campaigns found. Create your first campaign to get started.</div></div>';
    } else {
      html = '<div style="display:grid;gap:12px">';
      campaigns.forEach(c => {
        const statusColors = { draft:'rgba(100,116,139,0.15);color:#94A3B8', active:'rgba(16,185,129,0.15);color:#34D399', paused:'rgba(245,158,11,0.15);color:#FBBF24', completed:'rgba(139,92,246,0.15);color:#A78BFA', archived:'rgba(239,68,68,0.15);color:#F87171' };
        const typeIcons = { in_app:'phone-portrait-outline', push_notification:'notifications-outline', email:'mail-outline', banner:'easel-outline' };
        const totalImps = parseInt(c.total_impressions || 0);
        const totalClicks = parseInt(c.total_clicks || 0);
        const totalConvs = parseInt(c.total_conversions || 0);
        const ctr = totalImps > 0 ? ((totalClicks/totalImps)*100).toFixed(1) : '0.0';
        const goalPct = c.goal_target > 0 ? Math.min(100, Math.round((c.goal_type === 'impressions' ? totalImps : c.goal_type === 'clicks' ? totalClicks : totalConvs) / c.goal_target * 100)) : 0;
        html += `<div class="card" style="cursor:pointer;transition:border-color .15s" onclick="campaignDetailId=${c.id};renderCampaigns(${c.id})" onmouseover="this.style.borderColor='var(--teal)'" onmouseout="this.style.borderColor='var(--card-border)'">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
            <div style="display:flex;gap:14px;align-items:center;flex:1;min-width:200px">
              <div style="width:44px;height:44px;border-radius:12px;background:rgba(13,148,136,0.15);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                <ion-icon name="${typeIcons[c.campaign_type]||'rocket-outline'}" style="font-size:22px;color:var(--teal-light)"></ion-icon>
              </div>
              <div>
                <div style="font-weight:700;color:#fff;font-size:15px">${esc(c.name)}</div>
                <div style="display:flex;gap:8px;margin-top:4px;flex-wrap:wrap">
                  <span class="badge" style="${statusColors[c.status]||statusColors.draft}">${c.status}</span>
                  <span style="font-size:12px;color:var(--text-muted)">${c.campaign_type.replace('_',' ')}</span>
                  ${c.ab_enabled ? '<span class="badge" style="background:rgba(139,92,246,0.15);color:#A78BFA">A/B</span>' : ''}
                  ${c.segment_name ? '<span class="badge badge-adviser">'+esc(c.segment_name)+'</span>' : ''}
                </div>
              </div>
            </div>
            <div style="display:flex;gap:24px;flex-wrap:wrap">
              <div style="text-align:center"><div style="font-size:11px;color:var(--text-muted)">Impressions</div><div style="font-size:18px;font-weight:700;color:#fff">${fmt(totalImps)}</div></div>
              <div style="text-align:center"><div style="font-size:11px;color:var(--text-muted)">Clicks</div><div style="font-size:18px;font-weight:700;color:#fff">${fmt(totalClicks)}</div></div>
              <div style="text-align:center"><div style="font-size:11px;color:var(--text-muted)">CTR</div><div style="font-size:18px;font-weight:700;color:${parseFloat(ctr)>5?'#34D399':parseFloat(ctr)>2?'#FBBF24':'var(--text-secondary)'}">${ctr}%</div></div>
              <div style="text-align:center"><div style="font-size:11px;color:var(--text-muted)">Goal</div>
                <div style="width:60px;margin-top:6px"><div class="progress-bar"><div class="fill" style="width:${goalPct}%"></div></div></div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${goalPct}%</div>
              </div>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px;font-size:11px;color:var(--text-muted);border-top:1px solid var(--card-border);padding-top:8px">
            <span><ion-icon name="calendar-outline" style="font-size:12px;vertical-align:middle"></ion-icon> Created ${fmtDate(c.created_at)}</span>
            ${c.start_date ? '<span><ion-icon name="play-outline" style="font-size:12px;vertical-align:middle"></ion-icon> ' + fmtDate(c.start_date) + '</span>' : ''}
            ${c.end_date ? '<span><ion-icon name="stop-outline" style="font-size:12px;vertical-align:middle"></ion-icon> ' + fmtDate(c.end_date) + '</span>' : ''}
            <span>${parseInt(c.variant_count)} variant${parseInt(c.variant_count)!==1?'s':''}</span>
          </div>
        </div>`;
      });
      html += '</div>';
    }
    $('campaigns-content').innerHTML = html;
  } catch (e) {
    $('campaigns-content').innerHTML = '<div class="empty-state">Failed to load campaigns</div>';
  }
}

async function renderCampaignDetail(id) {
  campaignDetailId = id;
  setMain(`<div class="breadcrumb"><a onclick="campaignDetailId=null;renderCampaigns()">Campaigns</a> <ion-icon name="chevron-forward-outline" style="font-size:10px"></ion-icon> <span>Campaign Detail</span></div>
    <div id="cd-content"><div class="loading">Loading campaign...</div></div>`);
  try {
    const data = await api('/campaigns/' + id);
    const c = data.campaign;
    const variants = data.variants || [];
    cache.campaignDetail = data;
    let segments = [];
    try { segments = await api('/segments'); cache.segments = segments; } catch {}

    const statusColors = { draft:'rgba(100,116,139,0.15);color:#94A3B8', active:'rgba(16,185,129,0.15);color:#34D399', paused:'rgba(245,158,11,0.15);color:#FBBF24', completed:'rgba(139,92,246,0.15);color:#A78BFA', archived:'rgba(239,68,68,0.15);color:#F87171' };
    const statusActions = {
      draft: [{label:'Activate',status:'active',icon:'play',color:'#34D399'},{label:'Archive',status:'archived',icon:'archive',color:'#F87171'}],
      active: [{label:'Pause',status:'paused',icon:'pause',color:'#FBBF24'},{label:'Complete',status:'completed',icon:'checkmark-circle',color:'#A78BFA'}],
      paused: [{label:'Resume',status:'active',icon:'play',color:'#34D399'},{label:'Complete',status:'completed',icon:'checkmark-circle',color:'#A78BFA'}],
      completed: [{label:'Archive',status:'archived',icon:'archive',color:'#F87171'}],
      archived: [{label:'Reactivate to Draft',status:'draft',icon:'refresh',color:'#94A3B8'}]
    };

    let html = `<div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;margin-bottom:20px">
      <div>
        <h1 style="font-size:22px;font-weight:700;color:#fff;margin:0">${esc(c.name)}</h1>
        <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
          <span class="badge" style="${statusColors[c.status]}">${c.status.toUpperCase()}</span>
          <span style="font-size:12px;color:var(--text-muted)">${c.campaign_type.replace('_',' ')}</span>
          ${c.ab_enabled ? '<span class="badge" style="background:rgba(139,92,246,0.15);color:#A78BFA">A/B Testing</span>' : ''}
          ${c.auto_optimize ? '<span class="badge" style="background:rgba(16,185,129,0.15);color:#34D399">Auto-Optimize</span>' : ''}
        </div>
        ${c.description ? '<p style="color:var(--text-secondary);font-size:13px;margin-top:6px">'+esc(c.description)+'</p>' : ''}
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${(statusActions[c.status]||[]).map(a => `<button class="btn btn-sm" style="background:rgba(${a.color==='#34D399'?'16,185,129':a.color==='#FBBF24'?'245,158,11':a.color==='#A78BFA'?'139,92,246':a.color==='#F87171'?'239,68,68':'100,116,139'},0.15);color:${a.color};border:1px solid ${a.color}33" onclick="changeCampaignStatus(${c.id},'${a.status}')"><ion-icon name="${a.icon}-outline"></ion-icon> ${a.label}</button>`).join('')}
        <button class="btn btn-secondary btn-sm" onclick="showCampaignModal(${c.id})"><ion-icon name="create-outline"></ion-icon> Edit</button>
        <button class="btn btn-secondary btn-sm" onclick="duplicateCampaign(${c.id})"><ion-icon name="copy-outline"></ion-icon> Duplicate</button>
        <button class="btn btn-sm" style="background:rgba(239,68,68,0.12);color:#F87171;border:1px solid rgba(239,68,68,0.25)" onclick="deleteCampaign(${c.id})"><ion-icon name="trash-outline"></ion-icon></button>
      </div>
    </div>`;

    // Campaign info cards
    const totalImps = variants.reduce((s,v) => s+v.impressions, 0);
    const totalClicks = variants.reduce((s,v) => s+v.clicks, 0);
    const totalConvs = variants.reduce((s,v) => s+v.conversions, 0);
    const totalDismiss = variants.reduce((s,v) => s+v.dismissals, 0);
    const ctr = totalImps > 0 ? ((totalClicks/totalImps)*100).toFixed(1) : '0.0';
    const cvr = totalClicks > 0 ? ((totalConvs/totalClicks)*100).toFixed(1) : '0.0';

    html += `<div class="stat-grid">
      <div class="stat-card"><div class="stat-icon" style="background:rgba(59,130,246,0.15);color:#60A5FA"><ion-icon name="eye-outline"></ion-icon></div><div class="stat-label">Impressions</div><div class="stat-val">${fmt(totalImps)}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(16,185,129,0.15);color:#34D399"><ion-icon name="finger-print-outline"></ion-icon></div><div class="stat-label">Clicks</div><div class="stat-val">${fmt(totalClicks)}</div><div class="stat-sub">${ctr}% CTR</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(139,92,246,0.15);color:#A78BFA"><ion-icon name="checkmark-done-outline"></ion-icon></div><div class="stat-label">Conversions</div><div class="stat-val">${fmt(totalConvs)}</div><div class="stat-sub">${cvr}% CVR</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(239,68,68,0.15);color:#F87171"><ion-icon name="close-circle-outline"></ion-icon></div><div class="stat-label">Dismissals</div><div class="stat-val">${fmt(totalDismiss)}</div></div>
    </div>`;

    // Settings card
    html += `<div class="card"><div class="card-header"><h3>Campaign Settings</h3></div>
      <div class="finance-grid">
        <div class="finance-item"><div class="fi-label">Type</div><div class="fi-val">${c.campaign_type.replace('_',' ')}</div></div>
        <div class="finance-item"><div class="fi-label">Target Screen</div><div class="fi-val">${c.target_screen || 'All'}</div></div>
        <div class="finance-item"><div class="fi-label">Segment</div><div class="fi-val">${c.segment_name || 'All Users'}</div></div>
        <div class="finance-item"><div class="fi-label">Priority</div><div class="fi-val">${c.priority}/10</div></div>
        <div class="finance-item"><div class="fi-label">Start Date</div><div class="fi-val">${fmtDate(c.start_date)}</div></div>
        <div class="finance-item"><div class="fi-label">End Date</div><div class="fi-val">${fmtDate(c.end_date)}</div></div>
        <div class="finance-item"><div class="fi-label">Budget</div><div class="fi-val">$${Number(c.budget||0).toFixed(2)}</div></div>
        <div class="finance-item"><div class="fi-label">Goal</div><div class="fi-val">${fmt(c.goal_target)} ${c.goal_type}</div></div>
      </div>
    </div>`;

    // Variants card
    html += `<div class="card"><div class="card-header"><h3>Variants (${variants.length})</h3><button class="btn btn-primary btn-sm" onclick="addCampaignVariant(${c.id})"><ion-icon name="add-outline"></ion-icon> Add Variant</button></div>`;
    if (variants.length > 0) {
      html += `<table><thead><tr><th>Label</th><th>Name</th><th>Headline</th><th>CTA Text</th><th>Traffic</th><th>Impressions</th><th>Clicks</th><th>CTR</th><th>Conversions</th><th>Actions</th></tr></thead><tbody>`;
      variants.forEach(v => {
        const vCtr = v.impressions > 0 ? ((v.clicks/v.impressions)*100).toFixed(1) : '0.0';
        const isWinner = c.winning_variant_id === v.id;
        html += `<tr style="${isWinner?'background:rgba(16,185,129,0.06)':''}">
          <td><span class="badge" style="background:rgba(139,92,246,0.15);color:#A78BFA;font-weight:700;font-size:14px">${esc(v.variant_label)}</span>${isWinner?'<span style="color:#34D399;font-size:10px;margin-left:4px">WINNER</span>':''}</td>
          <td><strong style="color:#fff">${esc(v.variant_name)}</strong></td>
          <td style="max-width:150px;font-size:12px;color:var(--text-secondary)">${esc(v.headline||'')}</td>
          <td><span style="background:rgba(13,148,136,0.15);color:var(--teal-light);padding:3px 8px;border-radius:6px;font-size:12px">${esc(v.cta_text||'')}</span></td>
          <td>${v.traffic_pct}%</td>
          <td>${fmt(v.impressions)}</td>
          <td>${fmt(v.clicks)}</td>
          <td><span style="color:${parseFloat(vCtr)>5?'#34D399':parseFloat(vCtr)>2?'#FBBF24':'var(--text-muted)'};font-weight:600">${vCtr}%</span></td>
          <td>${fmt(v.conversions)}</td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();showVariantModal(${c.id},${v.id})" style="margin-right:4px"><ion-icon name="create-outline"></ion-icon></button>
            ${variants.length > 1 ? `<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteVariant(${v.id},${c.id})"><ion-icon name="trash-outline"></ion-icon></button>` : ''}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
    }
    html += '</div>';

    // Daily trend chart
    const trends = data.daily_trends || [];
    if (trends.length > 0) {
      const dailyMap = {};
      trends.forEach(t => {
        if (!dailyMap[t.date]) dailyMap[t.date] = { impressions:0, clicks:0 };
        if (t.event_type === 'impression') dailyMap[t.date].impressions += parseInt(t.count);
        if (t.event_type === 'click' || t.event_type === 'cta_click') dailyMap[t.date].clicks += parseInt(t.count);
      });
      const dates = Object.keys(dailyMap).sort().slice(-14);
      const maxVal = Math.max(...dates.map(d => dailyMap[d].impressions), 1);
      html += `<div class="card"><div class="card-header"><h3>Daily Performance (Last 14 Days)</h3></div>
        <div style="display:flex;gap:4px;align-items:flex-end;height:140px;padding:10px 0">`;
      dates.forEach(d => {
        const day = dailyMap[d];
        const h = Math.max((day.impressions / maxVal)*120, 4);
        const clickH = Math.max((day.clicks / maxVal)*120, 0);
        const label = new Date(d).toLocaleDateString('en-AU',{day:'numeric',month:'short'});
        html += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px" title="${label}: ${day.impressions} imps, ${day.clicks} clicks">
          <div style="width:100%;max-width:30px;height:${h}px;background:rgba(59,130,246,0.4);border-radius:4px 4px 0 0;position:relative">
            <div style="position:absolute;bottom:0;width:100%;height:${clickH}px;background:var(--teal);border-radius:0 0 4px 4px;opacity:0.8"></div>
          </div>
          <span style="font-size:9px;color:var(--text-muted)">${label.split(' ')[0]}</span>
        </div>`;
      });
      html += `</div>
        <div style="display:flex;gap:16px;margin-top:8px;justify-content:center">
          <span style="font-size:11px;color:var(--text-muted)"><span style="display:inline-block;width:10px;height:10px;background:rgba(59,130,246,0.4);border-radius:2px;vertical-align:middle;margin-right:4px"></span>Impressions</span>
          <span style="font-size:11px;color:var(--text-muted)"><span style="display:inline-block;width:10px;height:10px;background:var(--teal);border-radius:2px;vertical-align:middle;margin-right:4px"></span>Clicks</span>
        </div></div>`;
    }

    $('cd-content').innerHTML = html;
  } catch (e) {
    $('cd-content').innerHTML = '<div class="empty-state">Failed to load campaign details</div>';
  }
}

function showCampaignModal(editId) {
  const c = editId ? (cache.campaignDetail ? cache.campaignDetail.campaign : (cache.campaigns||[]).find(x => x.id === editId)) : null;
  const segments = cache.segments || [];
  let segOpts = '<option value="">All Users</option>';
  segments.forEach(s => segOpts += `<option value="${s.id}" ${c && c.target_segment_id == s.id ? 'selected' : ''}>${esc(s.name)}</option>`);
  const screens = ['overview','mortgage','super','insurance','savings','rewards','banks','budget','planning','fact_find','investor'];
  let screenOpts = '<option value="">All Screens</option>';
  screens.forEach(s => screenOpts += `<option value="${s}" ${c?.target_screen === s ? 'selected' : ''}>${s.charAt(0).toUpperCase()+s.slice(1).replace('_',' ')}</option>`);

  showModal(`
    <h2>${c ? 'Edit Campaign' : 'New Campaign'}</h2>
    <div class="form-group"><label>Campaign Name</label><input id="m-camp-name" value="${esc(c?.name||'')}" placeholder="e.g. Summer Super Review"></div>
    <div class="form-group"><label>Description</label><textarea id="m-camp-desc">${esc(c?.description||'')}</textarea></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Type</label><select id="m-camp-type">
        <option value="in_app" ${(!c||c.campaign_type==='in_app')?'selected':''}>In-App</option>
        <option value="push_notification" ${c?.campaign_type==='push_notification'?'selected':''}>Push Notification</option>
        <option value="email" ${c?.campaign_type==='email'?'selected':''}>Email</option>
        <option value="banner" ${c?.campaign_type==='banner'?'selected':''}>Banner</option>
      </select></div>
      <div class="form-group"><label>Target Screen</label><select id="m-camp-screen">${screenOpts}</select></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Segment</label><select id="m-camp-seg">${segOpts}</select></div>
      <div class="form-group"><label>Priority (1-10)</label><input id="m-camp-priority" type="number" min="1" max="10" value="${c?.priority||5}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Start Date</label><input id="m-camp-start" type="date" value="${c?.start_date?c.start_date.slice(0,10):''}"></div>
      <div class="form-group"><label>End Date</label><input id="m-camp-end" type="date" value="${c?.end_date?c.end_date.slice(0,10):''}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="form-group"><label>Budget ($)</label><input id="m-camp-budget" type="number" step="0.01" value="${c?.budget||0}"></div>
      <div class="form-group"><label>Goal Type</label><select id="m-camp-goaltype">
        <option value="impressions" ${(!c||c.goal_type==='impressions')?'selected':''}>Impressions</option>
        <option value="clicks" ${c?.goal_type==='clicks'?'selected':''}>Clicks</option>
        <option value="conversions" ${c?.goal_type==='conversions'?'selected':''}>Conversions</option>
      </select></div>
      <div class="form-group"><label>Goal Target</label><input id="m-camp-goaltarget" type="number" value="${c?.goal_target||1000}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>A/B Testing</label><select id="m-camp-ab"><option value="false" ${!c?.ab_enabled?'selected':''}>Disabled</option><option value="true" ${c?.ab_enabled?'selected':''}>Enabled</option></select></div>
      <div class="form-group"><label>Auto-Optimize</label><select id="m-camp-autoopt"><option value="false" ${!c?.auto_optimize?'selected':''}>Disabled</option><option value="true" ${c?.auto_optimize?'selected':''}>Enabled</option></select></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCampaign(${editId||'null'})">${c?'Update':'Create'}</button>
    </div>
  `);
}

async function saveCampaign(editId) {
  const data = {
    name: $('m-camp-name').value,
    description: $('m-camp-desc').value,
    campaign_type: $('m-camp-type').value,
    target_segment_id: $('m-camp-seg').value || null,
    target_screen: $('m-camp-screen').value || null,
    priority: parseInt($('m-camp-priority').value) || 5,
    start_date: $('m-camp-start').value || null,
    end_date: $('m-camp-end').value || null,
    budget: parseFloat($('m-camp-budget').value) || 0,
    goal_type: $('m-camp-goaltype').value,
    goal_target: parseInt($('m-camp-goaltarget').value) || 1000,
    ab_enabled: $('m-camp-ab').value === 'true',
    auto_optimize: $('m-camp-autoopt').value === 'true'
  };
  if (!data.name) { toast('Campaign name is required', 'error'); return; }
  try {
    if (editId) {
      await api('/campaigns/' + editId, { method: 'PUT', body: JSON.stringify(data) });
      toast('Campaign updated');
    } else {
      const result = await api('/campaigns', { method: 'POST', body: JSON.stringify(data) });
      toast('Campaign created');
      campaignDetailId = result.id;
    }
    hideModal();
    renderCampaigns();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function changeCampaignStatus(id, status) {
  const labels = { active:'activate', paused:'pause', completed:'complete', archived:'archive', draft:'reset to draft' };
  if (!confirm('Are you sure you want to ' + (labels[status]||status) + ' this campaign?')) return;
  try {
    await api('/campaigns/' + id + '/status', { method: 'PUT', body: JSON.stringify({ status }) });
    toast('Campaign ' + status);
    renderCampaignDetail(id);
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function duplicateCampaign(id) {
  try {
    const result = await api('/campaigns/' + id + '/duplicate', { method: 'POST' });
    toast('Campaign duplicated');
    campaignDetailId = result.id;
    renderCampaigns();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteCampaign(id) {
  if (!confirm('Delete this campaign and all its data? This cannot be undone.')) return;
  try {
    await api('/campaigns/' + id, { method: 'DELETE' });
    toast('Campaign deleted');
    campaignDetailId = null;
    renderCampaigns();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function addCampaignVariant(campaignId) {
  try {
    await api('/campaigns/' + campaignId + '/variants', { method: 'POST', body: JSON.stringify({}) });
    toast('Variant added');
    renderCampaignDetail(campaignId);
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

function showVariantModal(campaignId, variantId) {
  const v = variantId ? ((cache.campaignDetail?.variants||[]).find(x => x.id === variantId)) : null;
  showModal(`
    <h2>${v ? 'Edit Variant ' + esc(v.variant_label) : 'Edit Variant'}</h2>
    <div class="form-group"><label>Variant Name</label><input id="m-v-name" value="${esc(v?.variant_name||'')}"></div>
    <div class="form-group"><label>Headline</label><input id="m-v-headline" value="${esc(v?.headline||'')}" placeholder="Main headline text"></div>
    <div class="form-group"><label>Body</label><textarea id="m-v-body">${esc(v?.body||'')}</textarea></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>CTA Text</label><input id="m-v-cta" value="${esc(v?.cta_text||'Learn More')}"></div>
      <div class="form-group"><label>Traffic %</label><input id="m-v-traffic" type="number" min="0" max="100" value="${v?.traffic_pct||50}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="form-group"><label>Icon (Ionicons)</label><input id="m-v-icon" value="${esc(v?.icon||'')}" placeholder="e.g. rocket-outline"></div>
      <div class="form-group"><label>Icon Color</label><input id="m-v-iconcolor" type="color" value="${v?.icon_color||'#0D9488'}" style="height:40px"></div>
      <div class="form-group"><label>BG Color</label><input id="m-v-bgcolor" type="color" value="${v?.bg_color||'#132D46'}" style="height:40px"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveVariant(${campaignId},${variantId||'null'})">Save</button>
    </div>
  `);
}

async function saveVariant(campaignId, variantId) {
  const data = {
    variant_name: $('m-v-name').value,
    headline: $('m-v-headline').value,
    body: $('m-v-body').value,
    cta_text: $('m-v-cta').value,
    traffic_pct: parseInt($('m-v-traffic').value) || 50,
    icon: $('m-v-icon').value || null,
    icon_color: $('m-v-iconcolor').value,
    bg_color: $('m-v-bgcolor').value
  };
  try {
    await api('/campaigns/variants/' + variantId, { method: 'PUT', body: JSON.stringify(data) });
    hideModal();
    toast('Variant updated');
    renderCampaignDetail(campaignId);
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteVariant(variantId, campaignId) {
  if (!confirm('Delete this variant?')) return;
  try {
    await api('/campaigns/variants/' + variantId, { method: 'DELETE' });
    toast('Variant deleted');
    renderCampaignDetail(campaignId);
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

// ========== Marketing: Campaign Analytics Page ==========
let analyticsSelectedCampaign = null;
let analyticsDays = 30;
async function renderCampaignAnalytics() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Campaign Analytics</h1><p>Performance metrics, A/B test results, and conversion funnels</p></div>
    <div id="ca-content"><div class="loading">Loading analytics...</div></div>`);
  try {
    const overview = await api('/marketing/overview');
    const campaigns = await api('/campaigns');
    cache.campaigns = campaigns;

    let html = '';
    // Overview KPIs
    const statusMap = {};
    (overview.campaign_counts || []).forEach(c => statusMap[c.status] = parseInt(c.count));
    const globalCtr = overview.total_impressions > 0 ? ((overview.total_clicks / overview.total_impressions) * 100).toFixed(1) : '0.0';
    const globalCvr = overview.total_clicks > 0 ? ((overview.total_conversions / overview.total_clicks) * 100).toFixed(1) : '0.0';

    html += `<div class="stat-grid">
      <div class="stat-card"><div class="stat-icon" style="background:rgba(13,148,136,0.15);color:var(--teal-light)"><ion-icon name="rocket"></ion-icon></div><div class="stat-label">Active Campaigns</div><div class="stat-val">${overview.active_campaigns}</div><div class="stat-sub">${fmt(statusMap.draft||0)} draft, ${fmt(statusMap.completed||0)} completed</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(59,130,246,0.15);color:#60A5FA"><ion-icon name="eye"></ion-icon></div><div class="stat-label">Total Impressions</div><div class="stat-val">${fmt(overview.total_impressions)}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(16,185,129,0.15);color:#34D399"><ion-icon name="finger-print"></ion-icon></div><div class="stat-label">Total Clicks</div><div class="stat-val">${fmt(overview.total_clicks)}</div><div class="stat-sub">${globalCtr}% CTR</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(139,92,246,0.15);color:#A78BFA"><ion-icon name="checkmark-done"></ion-icon></div><div class="stat-label">Conversions</div><div class="stat-val">${fmt(overview.total_conversions)}</div><div class="stat-sub">${globalCvr}% CVR</div></div>
    </div>`;

    // Budget overview
    if (overview.budget.total > 0) {
      const budgetPct = overview.budget.total > 0 ? Math.min(100, Math.round(overview.budget.spent / overview.budget.total * 100)) : 0;
      html += `<div class="card"><div class="card-header"><h3>Budget Overview</h3></div>
        <div style="display:flex;align-items:center;gap:20px">
          <div style="flex:1"><div class="progress-bar" style="height:14px"><div class="fill" style="width:${budgetPct}%;background:${budgetPct>90?'#F87171':budgetPct>70?'#FBBF24':'var(--teal)'}"></div></div></div>
          <div style="white-space:nowrap;font-size:14px;color:#fff"><strong>$${Number(overview.budget.spent).toFixed(2)}</strong> / $${Number(overview.budget.total).toFixed(2)} <span style="color:var(--text-muted)">(${budgetPct}%)</span></div>
        </div></div>`;
    }

    // Campaign comparison table
    if (campaigns.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Campaign Performance Comparison</h3></div>
        <table><thead><tr><th>Campaign</th><th>Status</th><th>Type</th><th>Impressions</th><th>Clicks</th><th>CTR</th><th>Conversions</th><th>CVR</th><th>A/B</th></tr></thead><tbody>`;
      campaigns.forEach(c => {
        const imps = parseInt(c.total_impressions||0);
        const clicks = parseInt(c.total_clicks||0);
        const convs = parseInt(c.total_conversions||0);
        const ctr = imps > 0 ? ((clicks/imps)*100).toFixed(1) : '0.0';
        const cvr = clicks > 0 ? ((convs/clicks)*100).toFixed(1) : '0.0';
        const statusColors = { draft:'#94A3B8', active:'#34D399', paused:'#FBBF24', completed:'#A78BFA', archived:'#F87171' };
        html += `<tr class="clickable" onclick="analyticsSelectedCampaign=${c.id};showCampaignAnalyticsDetail(${c.id})">
          <td><strong style="color:#fff">${esc(c.name)}</strong></td>
          <td><span class="badge" style="background:rgba(${statusColors[c.status]==='#34D399'?'16,185,129':statusColors[c.status]==='#FBBF24'?'245,158,11':statusColors[c.status]==='#A78BFA'?'139,92,246':statusColors[c.status]==='#F87171'?'239,68,68':'100,116,139'},0.15);color:${statusColors[c.status]}">${c.status}</span></td>
          <td style="font-size:12px;color:var(--text-secondary)">${c.campaign_type.replace('_',' ')}</td>
          <td>${fmt(imps)}</td>
          <td>${fmt(clicks)}</td>
          <td><span style="color:${parseFloat(ctr)>5?'#34D399':parseFloat(ctr)>2?'#FBBF24':'var(--text-muted)'};font-weight:600">${ctr}%</span></td>
          <td>${fmt(convs)}</td>
          <td><span style="color:${parseFloat(cvr)>5?'#34D399':parseFloat(cvr)>2?'#FBBF24':'var(--text-muted)'}">${cvr}%</span></td>
          <td>${c.ab_enabled?'<span class="badge" style="background:rgba(139,92,246,0.15);color:#A78BFA">A/B</span>':'—'}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
    } else {
      html += '<div class="card"><div class="empty-state">No campaigns created yet. Go to Campaigns to create your first one.</div></div>';
    }

    $('ca-content').innerHTML = html;
  } catch (e) {
    $('ca-content').innerHTML = '<div class="empty-state">Failed to load campaign analytics</div>';
  }
}

async function showCampaignAnalyticsDetail(id) {
  setMain(`<div class="breadcrumb"><a onclick="renderCampaignAnalytics()">Campaign Analytics</a> <ion-icon name="chevron-forward-outline" style="font-size:10px"></ion-icon> <span>Detail</span></div>
    <div style="display:flex;gap:6px;margin-bottom:16px">
      ${[7,14,30,90].map(d => `<button class="btn btn-sm ${analyticsDays===d?'btn-primary':'btn-secondary'}" onclick="analyticsDays=${d};showCampaignAnalyticsDetail(${id})">${d}d</button>`).join('')}
    </div>
    <div id="cad-content"><div class="loading">Loading...</div></div>`);
  try {
    const data = await api('/campaigns/' + id + '/analytics?days=' + analyticsDays);
    const campaign = await api('/campaigns/' + id);
    const c = campaign.campaign;
    const variants = data.variants || [];
    let html = `<h2 style="color:#fff;font-size:18px;margin-bottom:16px">${esc(c.name)}</h2>`;

    // Variant comparison
    if (variants.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Variant Performance</h3></div>
        <table><thead><tr><th>Variant</th><th>Name</th><th>Traffic</th><th>Impressions</th><th>Clicks</th><th>CTR</th><th>Conversions</th><th>CVR</th><th>Dismiss Rate</th></tr></thead><tbody>`;

      let bestCtr = 0;
      let bestVariant = null;
      variants.forEach(v => {
        const ctr = parseFloat(v.ctr);
        if (ctr > bestCtr && v.impressions > 10) { bestCtr = ctr; bestVariant = v.id; }
      });

      variants.forEach(v => {
        const isBest = v.id === bestVariant && variants.length > 1;
        html += `<tr style="${isBest?'background:rgba(16,185,129,0.06)':''}">
          <td><span class="badge" style="background:rgba(139,92,246,0.15);color:#A78BFA;font-weight:700">${esc(v.variant_label)}</span>${isBest?'<span style="color:#34D399;font-size:10px;margin-left:4px">BEST</span>':''}</td>
          <td><strong style="color:#fff">${esc(v.variant_name)}</strong></td>
          <td>${v.traffic_pct}%</td>
          <td>${fmt(v.impressions)}</td>
          <td>${fmt(v.clicks)}</td>
          <td><span style="color:${parseFloat(v.ctr)>5?'#34D399':parseFloat(v.ctr)>2?'#FBBF24':'var(--text-muted)'};font-weight:600">${v.ctr}%</span></td>
          <td>${fmt(v.conversions)}</td>
          <td>${v.cvr}%</td>
          <td><span style="color:${parseFloat(v.dismiss_rate)>30?'#F87171':'var(--text-secondary)'}">${v.dismiss_rate}%</span></td>
        </tr>`;
      });
      html += '</tbody></table></div>';

      // Visual variant bar comparison
      if (variants.length > 1) {
        const maxImps = Math.max(...variants.map(v => v.impressions), 1);
        html += `<div class="card"><div class="card-header"><h3>A/B Comparison</h3></div>
          <div style="display:grid;gap:16px;padding:8px 0">`;
        variants.forEach(v => {
          const impW = Math.max((v.impressions / maxImps) * 100, 2);
          const clickW = v.impressions > 0 ? Math.max((v.clicks / maxImps) * 100, 1) : 0;
          html += `<div>
            <div style="display:flex;justify-content:space-between;margin-bottom:4px">
              <span style="font-weight:600;color:#fff">${esc(v.variant_label)} — ${esc(v.variant_name)}</span>
              <span style="font-size:12px;color:var(--text-muted)">${v.ctr}% CTR</span>
            </div>
            <div style="height:24px;background:rgba(255,255,255,0.05);border-radius:6px;overflow:hidden;position:relative">
              <div style="height:100%;width:${impW}%;background:rgba(59,130,246,0.4);border-radius:6px;position:absolute"></div>
              <div style="height:100%;width:${clickW}%;background:var(--teal);border-radius:6px;position:absolute"></div>
            </div>
          </div>`;
        });
        html += '</div></div>';
      }
    }

    // Hourly distribution
    const hourly = data.hourly_distribution || [];
    if (hourly.length > 0) {
      const hourMap = {};
      for (let h = 0; h < 24; h++) hourMap[h] = { impressions: 0, clicks: 0 };
      hourly.forEach(h => {
        const hr = parseInt(h.hour);
        if (h.event_type === 'impression') hourMap[hr].impressions += parseInt(h.count);
        if (h.event_type === 'click' || h.event_type === 'cta_click') hourMap[hr].clicks += parseInt(h.count);
      });
      const maxHour = Math.max(...Object.values(hourMap).map(h => h.impressions), 1);
      html += `<div class="card"><div class="card-header"><h3>Hourly Distribution</h3></div>
        <div style="display:flex;gap:2px;align-items:flex-end;height:100px;padding:8px 0">`;
      for (let h = 0; h < 24; h++) {
        const d = hourMap[h];
        const barH = Math.max((d.impressions / maxHour) * 80, 2);
        html += `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px" title="${h}:00 — ${d.impressions} imps, ${d.clicks} clicks">
          <div style="width:100%;height:${barH}px;background:rgba(59,130,246,0.4);border-radius:2px"></div>
          <span style="font-size:8px;color:var(--text-muted)">${h}</span>
        </div>`;
      }
      html += '</div></div>';
    }

    // Reach
    if (data.reach) {
      html += `<div class="card"><div class="card-header"><h3>Reach</h3></div>
        <div class="finance-grid">
          <div class="finance-item"><div class="fi-label">Unique Devices</div><div class="fi-val">${fmt(data.reach.unique_devices)}</div></div>
          <div class="finance-item"><div class="fi-label">Total Events</div><div class="fi-val">${fmt(data.reach.total_events)}</div></div>
        </div></div>`;
    }

    $('cad-content').innerHTML = html;
  } catch (e) {
    $('cad-content').innerHTML = '<div class="empty-state">Failed to load analytics detail</div>';
  }
}

// ========== Marketing: CTA Optimizer Page ==========
let ctaOptDays = 30;
async function renderCTAOptimizer() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>CTA Optimizer</h1><p>Dynamic performance-based CTA ranking and optimization</p></div>
    <div style="display:flex;gap:6px;margin-bottom:16px;align-items:center">
      <span style="font-size:12px;color:var(--text-muted)">Period:</span>
      ${[7,14,30,90].map(d => `<button class="btn btn-sm ${ctaOptDays===d?'btn-primary':'btn-secondary'}" onclick="ctaOptDays=${d};renderCTAOptimizer()">${d}d</button>`).join('')}
    </div>
    <div id="cto-content"><div class="loading">Loading optimizer data...</div></div>`);
  try {
    const data = await api('/cta-optimizer?days=' + ctaOptDays);
    const ctas = data.ctas || [];
    let html = '';

    // Optimizer overview
    const highPerf = ctas.filter(c => c.recommendation === 'high_performer').length;
    const moderate = ctas.filter(c => c.recommendation === 'moderate').length;
    const needsWork = ctas.filter(c => c.recommendation === 'needs_improvement').length;
    const insuffData = ctas.filter(c => c.recommendation === 'insufficient_data').length;

    html += `<div class="stat-grid">
      <div class="stat-card"><div class="stat-icon" style="background:rgba(16,185,129,0.15);color:#34D399"><ion-icon name="rocket"></ion-icon></div><div class="stat-label">High Performers</div><div class="stat-val">${highPerf}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(245,158,11,0.15);color:#FBBF24"><ion-icon name="trending-up"></ion-icon></div><div class="stat-label">Moderate</div><div class="stat-val">${moderate}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(239,68,68,0.15);color:#F87171"><ion-icon name="trending-down"></ion-icon></div><div class="stat-label">Needs Improvement</div><div class="stat-val">${needsWork}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:rgba(100,116,139,0.15);color:#94A3B8"><ion-icon name="help-circle"></ion-icon></div><div class="stat-label">Insufficient Data</div><div class="stat-val">${insuffData}</div></div>
    </div>`;

    // Auto-optimize toggle
    html += `<div class="card" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div>
        <div style="font-weight:700;color:#fff">Auto-Optimize CTA Ranking</div>
        <div style="font-size:12px;color:var(--text-muted)">Automatically reorder CTAs based on performance scores</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span style="font-size:12px;color:${data.auto_optimize_enabled?'#34D399':'var(--text-muted)'}">${data.auto_optimize_enabled?'Enabled':'Disabled'}</span>
        <button class="btn btn-primary btn-sm" onclick="applyCtaRanking()" ${ctas.length===0?'disabled':''}><ion-icon name="swap-vertical-outline"></ion-icon> Apply Optimized Ranking Now</button>
      </div>
    </div>`;

    // CTA ranking table
    if (ctas.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>CTA Performance Ranking</h3></div>
        <table><thead><tr><th>#</th><th>Tab</th><th>CTA Text</th><th>Score</th><th>Impressions</th><th>Clicks</th><th>CTR</th><th>Conversions</th><th>CVR</th><th>Dismiss Rate</th><th>Status</th></tr></thead><tbody>`;
      ctas.forEach((c, idx) => {
        const recColors = { high_performer:'#34D399', moderate:'#FBBF24', needs_improvement:'#F87171', insufficient_data:'#94A3B8' };
        const recLabels = { high_performer:'High Performer', moderate:'Moderate', needs_improvement:'Needs Work', insufficient_data:'No Data' };
        const scoreColor = parseFloat(c.optimization_score) > 15 ? '#34D399' : parseFloat(c.optimization_score) > 5 ? '#FBBF24' : '#F87171';
        html += `<tr>
          <td style="font-weight:700;color:var(--teal-light)">${idx+1}</td>
          <td><span class="badge" style="background:rgba(13,148,136,0.15);color:var(--teal-light)">${esc(c.tab_label || c.tab_key)}</span></td>
          <td><strong style="color:#fff">${esc(c.cta_text)}</strong></td>
          <td><span style="font-size:18px;font-weight:700;color:${scoreColor}">${c.optimization_score}</span></td>
          <td>${fmt(c.performance?.impressions||0)}</td>
          <td>${fmt(c.performance?.clicks||0)}</td>
          <td><span style="color:${parseFloat(c.ctr)>5?'#34D399':parseFloat(c.ctr)>2?'#FBBF24':'var(--text-muted)'};font-weight:600">${c.ctr}%</span></td>
          <td>${fmt(c.performance?.conversions||0)}</td>
          <td>${c.cvr}%</td>
          <td><span style="color:${parseFloat(c.dismiss_rate)>30?'#F87171':'var(--text-secondary)'}">${c.dismiss_rate}%</span></td>
          <td><span class="badge" style="background:rgba(${recColors[c.recommendation]==='#34D399'?'16,185,129':recColors[c.recommendation]==='#FBBF24'?'245,158,11':recColors[c.recommendation]==='#F87171'?'239,68,68':'100,116,139'},0.15);color:${recColors[c.recommendation]}">${recLabels[c.recommendation]}</span></td>
        </tr>`;
      });
      html += '</tbody></table></div>';

      // Score visualization
      html += `<div class="card"><div class="card-header"><h3>Optimization Scores</h3></div>
        <div style="display:grid;gap:10px;padding:8px 0">`;
      const maxScore = Math.max(...ctas.map(c => parseFloat(c.optimization_score)), 1);
      ctas.slice(0, 10).forEach(c => {
        const w = Math.max((parseFloat(c.optimization_score) / maxScore) * 100, 2);
        const scoreColor = parseFloat(c.optimization_score) > 15 ? '#34D399' : parseFloat(c.optimization_score) > 5 ? '#FBBF24' : '#F87171';
        html += `<div style="display:flex;align-items:center;gap:12px">
          <div style="width:120px;font-size:12px;color:var(--text-secondary);text-align:right;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.tab_label||c.tab_key)}</div>
          <div style="flex:1;height:20px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden">
            <div style="height:100%;width:${w}%;background:${scoreColor};border-radius:4px;transition:width .3s"></div>
          </div>
          <div style="width:50px;font-size:13px;font-weight:700;color:${scoreColor}">${c.optimization_score}</div>
        </div>`;
      });
      html += '</div></div>';

      // Scoring formula explanation
      html += `<div class="card"><div class="card-header"><h3>Scoring Formula</h3></div>
        <div style="padding:8px 0">
          <code style="color:var(--teal-light);font-size:13px;background:rgba(0,0,0,0.2);padding:8px 14px;border-radius:8px;display:block">
            Score = (CTR × 3) + (CVR × 5) - (Dismiss Rate × 2) + (Unique Users × 0.1)
          </code>
          <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;font-size:12px;color:var(--text-secondary)">
            <div><strong style="color:#fff">CTR weight: 3×</strong> — Click-through rate importance</div>
            <div><strong style="color:#fff">CVR weight: 5×</strong> — Conversion rate priority</div>
            <div><strong style="color:#fff">Dismiss: -2×</strong> — Penalizes high dismiss rates</div>
            <div><strong style="color:#fff">Users: 0.1×</strong> — Bonus for wider reach</div>
          </div>
        </div></div>`;
    } else {
      html += '<div class="card"><div class="empty-state">No CTAs configured. Create CTAs in the Administration section to start optimization.</div></div>';
    }

    $('cto-content').innerHTML = html;
  } catch (e) {
    $('cto-content').innerHTML = '<div class="empty-state">Failed to load CTA optimizer</div>';
  }
}

async function applyCtaRanking() {
  if (!confirm('Apply the optimized CTA ranking based on performance scores? This will reorder CTAs across the app.')) return;
  try {
    const data = await api('/cta-optimizer?days=' + ctaOptDays);
    const rankings = (data.ctas || []).map(c => c.id);
    await api('/cta-optimizer/apply-ranking', { method: 'POST', body: JSON.stringify({ rankings }) });
    toast('Optimized ranking applied successfully');
    renderCTAOptimizer();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

if (token) {
  const savedUser = localStorage.getItem('adviser_user');
  if (savedUser) { try { currentUser = JSON.parse(savedUser); } catch {} }
  showApp();
}
</script>
</body>
</html>