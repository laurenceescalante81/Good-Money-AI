<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Good Money Adviser</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://unpkg.com/ionicons@7.1.0/dist/css/ionicons.min.css" rel="stylesheet">
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#0C1B2A;color:#E2E8F0;min-height:100vh}
:root{
  --teal:#0D9488;--teal-dark:#0F766E;--teal-light:#2DD4BF;--teal-glow:rgba(13,148,136,0.15);
  --navy:#0C1B2A;--navy-light:#132D46;--navy-mid:#1B3A5C;
  --gold:#F59E0B;--red:#EF4444;--green:#10B981;--blue:#3B82F6;--purple:#8B5CF6;--pink:#EC4899;
  --text:#E2E8F0;--text-secondary:#94A3B8;--text-muted:#64748B;
  --card:#132D46;--card-border:#1E3A5F;--card-hover:#1B3A5C;
  --input-bg:#0C1B2A;--input-border:#1E3A5F;
  --shadow:0 2px 8px rgba(0,0,0,0.3);
  --sidebar-w:260px;
}

.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0C1B2A 0%,#132D46 50%,#0C1B2A 100%)}
.login-card{background:var(--card);border:1px solid var(--card-border);border-radius:20px;padding:40px;width:420px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.login-card .logo-row{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:24px}
.login-card .logo-icon{width:52px;height:52px;background:var(--teal);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff}
.login-card .logo-text h1{font-size:22px;color:#fff;font-weight:700}
.login-card .logo-text span{font-size:12px;color:var(--teal-light);font-weight:500}
.login-card>p{text-align:center;color:var(--text-secondary);margin-bottom:28px;font-size:14px}

.form-group{margin-bottom:16px}
.form-group label{display:block;font-weight:600;font-size:13px;color:var(--text-secondary);margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:11px 14px;border:1px solid var(--input-border);border-radius:10px;font-size:14px;font-family:inherit;outline:none;transition:border .2s;background:var(--input-bg);color:var(--text)}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--teal)}
.form-group textarea{resize:vertical;min-height:60px}
.form-group select option{background:var(--navy);color:var(--text)}

.btn{padding:10px 20px;border:none;border-radius:10px;font-family:inherit;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--teal);color:#fff}.btn-primary:hover{background:var(--teal-dark)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:#dc2626}
.btn-secondary{background:var(--navy-mid);color:var(--text-secondary);border:1px solid var(--card-border)}.btn-secondary:hover{background:var(--card-border);color:#fff}
.btn-gold{background:var(--gold);color:#7c5800}.btn-gold:hover{background:#d4930d}
.btn-sm{padding:6px 14px;font-size:12px;border-radius:8px}
.btn-full{width:100%;justify-content:center;padding:12px}
.login-error{color:var(--red);font-size:13px;text-align:center;margin-top:12px;display:none}

.app{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-w);background:var(--navy-light);border-right:1px solid var(--card-border);flex-shrink:0;position:fixed;height:100vh;overflow-y:auto;z-index:100;display:flex;flex-direction:column}
.sidebar .logo-area{padding:20px;border-bottom:1px solid var(--card-border);display:flex;align-items:center;gap:12px}
.sidebar .logo-area .logo-sq{width:38px;height:38px;background:var(--teal);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;flex-shrink:0}
.sidebar .logo-area .logo-info h2{font-size:15px;font-weight:700;color:#fff}
.sidebar .logo-area .logo-info span{font-size:11px;color:var(--teal-light);font-weight:500}
.sidebar nav{flex:1;padding:12px 0}
.nav-item{padding:10px 20px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text-muted);transition:all .15s;display:flex;align-items:center;gap:10px;border-left:3px solid transparent;margin:1px 0}
.nav-item:hover{background:rgba(255,255,255,0.03);color:var(--text)}
.nav-item.active{background:var(--teal-glow);color:var(--teal-light);border-left-color:var(--teal)}
.nav-item ion-icon{font-size:18px;width:22px}
.nav-divider{height:1px;background:var(--card-border);margin:8px 20px}
.nav-label{padding:8px 20px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted)}
.sidebar .user-area{padding:16px 20px;border-top:1px solid var(--card-border);background:rgba(0,0,0,0.2)}
.sidebar .user-area .user-name{font-size:13px;font-weight:600;color:#fff}
.sidebar .user-area .user-role{font-size:11px;color:var(--teal-light);text-transform:uppercase;font-weight:600;margin-top:2px}
.sidebar .user-area .logout-btn{font-size:12px;color:var(--text-muted);cursor:pointer;margin-top:8px;background:none;border:none;font-family:inherit;display:flex;align-items:center;gap:4px}
.sidebar .user-area .logout-btn:hover{color:var(--red)}

.main{margin-left:var(--sidebar-w);flex:1;padding:28px;min-height:100vh}
.page-header{margin-bottom:24px}
.page-header h1{font-size:24px;font-weight:700;color:#fff}
.page-header p{font-size:14px;color:var(--text-secondary);margin-top:4px}

.welcome-banner{background:linear-gradient(135deg,var(--teal-dark),var(--navy-mid));border-radius:16px;padding:28px 32px;margin-bottom:24px;border:1px solid var(--teal);position:relative;overflow:hidden}
.welcome-banner::after{content:'';position:absolute;right:-30px;top:-30px;width:160px;height:160px;border-radius:50%;background:rgba(13,148,136,0.15)}
.welcome-banner h2{font-size:22px;color:#fff;margin-bottom:4px}
.welcome-banner p{color:var(--teal-light);font-size:14px}
.welcome-banner .quick-actions{display:flex;gap:10px;margin-top:16px}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border-radius:14px;padding:20px;border:1px solid var(--card-border);transition:border-color .2s}
.stat-card:hover{border-color:var(--teal)}
.stat-card .stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:12px}
.stat-card .stat-label{font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
.stat-card .stat-val{font-size:28px;font-weight:700;margin-top:4px;color:#fff}
.stat-card .stat-sub{font-size:12px;color:var(--text-secondary);margin-top:2px}

.card{background:var(--card);border-radius:14px;padding:20px;border:1px solid var(--card-border);margin-bottom:20px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.card-header h3{font-size:16px;font-weight:700;color:#fff}

table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 12px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--card-border)}
td{padding:10px 12px;font-size:13px;border-bottom:1px solid rgba(30,58,95,0.5);color:var(--text-secondary)}
tr:hover td{background:rgba(255,255,255,0.02)}
tbody tr{cursor:default}
tbody tr.clickable{cursor:pointer}
tbody tr.clickable:hover td{background:var(--teal-glow)}

.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-active{background:rgba(16,185,129,0.15);color:#34D399}
.badge-inactive{background:rgba(239,68,68,0.15);color:#F87171}
.badge-god{background:rgba(245,158,11,0.15);color:#FBBF24}
.badge-adviser{background:rgba(59,130,246,0.15);color:#60A5FA}

.progress-bar{height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden}
.progress-bar .fill{height:100%;border-radius:4px;background:var(--teal);transition:width .3s}

.search-bar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
.search-bar input{flex:1;min-width:200px;padding:9px 14px;border:1px solid var(--input-border);border-radius:10px;font-size:13px;font-family:inherit;outline:none;background:var(--input-bg);color:var(--text)}
.search-bar input:focus{border-color:var(--teal)}
.search-bar select{padding:9px 14px;border:1px solid var(--input-border);border-radius:10px;font-size:13px;font-family:inherit;outline:none;background:var(--input-bg);color:var(--text)}

.breadcrumb{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text-muted);margin-bottom:16px}
.breadcrumb a{color:var(--teal-light);text-decoration:none;cursor:pointer}
.breadcrumb a:hover{text-decoration:underline}

.client-header{display:flex;align-items:center;gap:20px;margin-bottom:24px;flex-wrap:wrap}
.client-avatar{width:64px;height:64px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:700;color:#fff;flex-shrink:0}
.client-info h2{font-size:22px;font-weight:700;color:#fff}
.client-info p{font-size:13px;color:var(--text-secondary)}
.client-info .client-meta{display:flex;gap:16px;margin-top:6px;flex-wrap:wrap}
.client-info .client-meta span{display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-muted)}

.tag-list{display:flex;flex-wrap:wrap;gap:6px}
.tag{background:rgba(13,148,136,0.12);color:var(--teal-light);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500}

.activity-item{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid rgba(30,58,95,0.3)}
.activity-item:last-child{border-bottom:none}
.activity-dot{width:8px;height:8px;border-radius:50%;background:var(--teal);margin-top:6px;flex-shrink:0}
.activity-item .activity-text{font-size:13px;color:var(--text-secondary)}
.activity-item .activity-time{font-size:11px;color:var(--text-muted);margin-top:2px}
.activity-item .activity-pts{font-size:12px;color:var(--teal-light);font-weight:600;margin-left:auto;flex-shrink:0}

.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:28px;width:520px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5)}
.modal h2{font-size:18px;font-weight:700;margin-bottom:20px;color:#fff}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

.toast-container{position:fixed;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:10px;font-size:13px;font-weight:500;color:#fff;animation:slideIn .3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
.toast-success{background:#065f46;border:1px solid var(--green)}
.toast-error{background:#7f1d1d;border:1px solid var(--red)}
.toast-info{background:var(--navy-mid);border:1px solid var(--teal)}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

.chart-container{display:flex;align-items:center;justify-content:center;padding:20px}
.chart-legend{display:flex;flex-direction:column;gap:8px;margin-left:24px}
.chart-legend-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary)}
.chart-legend-item .dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}

.advisor-card{background:var(--card);border-radius:14px;padding:16px;border:1px solid var(--card-border);margin-bottom:12px;transition:border-color .15s}
.advisor-card:hover{border-color:var(--teal)}
.advisor-card .advisor-row{display:flex;align-items:center;gap:14px}
.advisor-card .advisor-avatar{width:44px;height:44px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:#fff;flex-shrink:0}
.advisor-card .advisor-info h4{font-size:15px;font-weight:600;color:#fff}
.advisor-card .advisor-info p{font-size:12px;color:var(--text-secondary)}
.advisor-card .advisor-stats{display:flex;gap:20px;margin-top:12px;padding-top:12px;border-top:1px solid var(--card-border);flex-wrap:wrap}
.advisor-card .advisor-stat{font-size:12px;color:var(--text-muted)}
.advisor-card .advisor-stat strong{color:#fff;display:block;font-size:16px}

.empty-state{text-align:center;padding:40px;color:var(--text-muted);font-size:14px}
.loading{text-align:center;padding:40px;color:var(--text-muted)}

.hidden{display:none!important}

.finance-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.finance-item{background:rgba(255,255,255,0.03);border-radius:10px;padding:12px;border:1px solid var(--card-border)}
.finance-item .fi-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:600}
.finance-item .fi-val{font-size:16px;font-weight:700;color:#fff;margin-top:2px}

@media(max-width:768px){
  .sidebar{width:64px}
  .sidebar .logo-area .logo-info,.nav-item span,.nav-label,.sidebar .user-area .user-name,.sidebar .user-area .user-role{display:none}
  .sidebar .logo-area{justify-content:center;padding:16px 8px}
  .nav-item{justify-content:center;padding:12px 8px}
  .nav-item ion-icon{margin:0}
  .main{margin-left:64px;padding:16px}
  .stat-grid{grid-template-columns:1fr 1fr}
  .welcome-banner{padding:20px}
}
</style>
</head>
<body>

<div id="login-page" class="login-wrap">
  <div class="login-card">
    <div class="logo-row">
      <div class="logo-icon"><ion-icon name="cash-outline"></ion-icon></div>
      <div class="logo-text"><h1>Good Money</h1><span>Adviser Portal</span></div>
    </div>
    <p>Sign in to manage your clients</p>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="you@goodmoney.com.au">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="Enter password">
    </div>
    <button class="btn btn-primary btn-full" onclick="doLogin()">Sign In</button>
    <div id="login-error" class="login-error"></div>
  </div>
</div>

<div id="app-page" class="app hidden">
  <div class="sidebar">
    <div class="logo-area">
      <div class="logo-sq"><ion-icon name="cash-outline"></ion-icon></div>
      <div class="logo-info"><h2>Good Money</h2><span>Adviser Portal</span></div>
    </div>
    <nav id="sidebar-nav"></nav>
    <div class="user-area">
      <div class="user-name" id="sidebar-user-name"></div>
      <div class="user-role" id="sidebar-user-role"></div>
      <button class="logout-btn" onclick="doLogout()"><ion-icon name="log-out-outline" style="font-size:14px"></ion-icon> Sign Out</button>
    </div>
  </div>
  <div class="main" id="main-content"></div>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal-content"></div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
const API = '/api/admin';
let token = localStorage.getItem('adviser_token');
let currentUser = null;
let currentPage = 'dashboard';
let cache = {};

function isGod() { return currentUser && (currentUser.role === 'god' || currentUser.role === 'admin'); }
function isAdviser() { return currentUser && currentUser.role === 'adviser'; }

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['x-admin-token'] = token;
  const r = await fetch(API + path, { ...opts, headers });
  if (r.status === 401) { doLogout(); throw new Error('Unauthorized'); }
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || 'Request failed');
  return data;
}

function toast(msg, type = 'success') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast toast-' + type;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(100%)'; setTimeout(() => t.remove(), 300); }, 3000);
}

async function doLogin() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  try {
    errEl.style.display = 'none';
    const data = await fetch(API + '/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) }).then(r => r.json());
    if (data.error) { errEl.textContent = data.error; errEl.style.display = 'block'; return; }
    token = data.token;
    currentUser = data.user;
    localStorage.setItem('adviser_token', token);
    localStorage.setItem('adviser_user', JSON.stringify(currentUser));
    showApp();
  } catch (e) {
    errEl.textContent = 'Login failed';
    errEl.style.display = 'block';
  }
}

function doLogout() {
  if (token) api('/logout', { method: 'POST' }).catch(() => {});
  token = null;
  currentUser = null;
  cache = {};
  localStorage.removeItem('adviser_token');
  localStorage.removeItem('adviser_user');
  document.getElementById('login-page').classList.remove('hidden');
  document.getElementById('app-page').classList.add('hidden');
}

async function showApp() {
  document.getElementById('login-page').classList.add('hidden');
  document.getElementById('app-page').classList.remove('hidden');
  if (!currentUser) {
    try {
      const data = await api('/me');
      currentUser = data.user;
      localStorage.setItem('adviser_user', JSON.stringify(currentUser));
    } catch {
      doLogout();
      return;
    }
  }
  document.getElementById('sidebar-user-name').textContent = currentUser.name;
  document.getElementById('sidebar-user-role').textContent = isGod() ? 'God Mode' : 'Adviser';
  buildNav();
  navigate('dashboard');
}

function buildNav() {
  let html = '';
  html += navItem('dashboard', 'grid-outline', 'Dashboard');
  html += navItem('clients', 'people-outline', isGod() ? 'All Clients' : 'My Clients');
  html += navItem('reports', 'bar-chart-outline', 'Reports');
  if (isGod()) {
    html += '<div class="nav-divider"></div>';
    html += '<div class="nav-label">Administration</div>';
    html += navItem('advisers', 'person-outline', 'Advisers');
    html += navItem('quests', 'trophy-outline', 'Quests');
    html += navItem('ctas', 'megaphone-outline', 'CTAs');
    html += navItem('messages', 'chatbubbles-outline', 'Messages');
    html += navItem('settings', 'settings-outline', 'Settings');
  }
  document.getElementById('sidebar-nav').innerHTML = html;
}

function navItem(page, icon, label) {
  return `<div class="nav-item${currentPage === page ? ' active' : ''}" data-page="${page}" onclick="navigate('${page}')"><ion-icon name="${icon}"></ion-icon><span>${label}</span></div>`;
}

function navigate(page) {
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
  const renderers = { dashboard: renderDashboard, clients: renderClients, reports: renderReports, advisers: renderAdvisers, quests: renderQuests, ctas: renderCTAs, messages: renderMessages, settings: renderSettings };
  if (renderers[page]) renderers[page]();
}

function showModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}
function hideModal() {
  document.getElementById('modal-overlay').classList.remove('show');
}
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-overlay')) hideModal();
});

function setMain(html) { document.getElementById('main-content').innerHTML = html; }
function $(id) { return document.getElementById(id); }
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmt(n) { return Number(n || 0).toLocaleString(); }
function pct(n) { return Number(n || 0).toFixed(0); }
function fmtDate(d) { if (!d) return '—'; return new Date(d).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' }); }
function fmtDateTime(d) { if (!d) return '—'; return new Date(d).toLocaleString('en-AU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); }
function timeAgo(d) {
  if (!d) return 'Never';
  const diff = Date.now() - new Date(d).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'Just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 30) return days + 'd ago';
  return fmtDate(d);
}
function initials(name) { if (!name) return '?'; return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2); }

async function renderDashboard() {
  setMain(`<div id="dash-content"><div class="loading">Loading dashboard...</div></div>`);
  try {
    let stats, recentActivity = [], advisorName = currentUser.name;
    if (isGod()) {
      const data = await api('/analytics/overview');
      stats = data.overview;
      recentActivity = data.recent_activity || [];
    } else {
      const aid = currentUser.advisorId;
      if (aid) {
        const data = await api('/analytics/advisor/' + aid);
        stats = data.stats;
        advisorName = data.advisor?.name || currentUser.name;
      } else {
        stats = { total_customers: 0, active_7d: 0, avg_fact_find: 0, avg_level: 1, total_points: 0, avg_streak: 0 };
      }
    }
    let html = `
      <div class="welcome-banner">
        <h2>Welcome back, ${esc(advisorName)}</h2>
        <p>${isGod() ? 'God Mode — Full platform overview' : 'Your client portfolio overview'}</p>
        <div class="quick-actions">
          <button class="btn btn-primary btn-sm" onclick="navigate('clients')"><ion-icon name="people-outline"></ion-icon> View Clients</button>
          <button class="btn btn-secondary btn-sm" onclick="navigate('reports')"><ion-icon name="bar-chart-outline"></ion-icon> Reports</button>
        </div>
      </div>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(13,148,136,0.15);color:var(--teal-light)"><ion-icon name="people"></ion-icon></div>
          <div class="stat-label">Total Clients</div>
          <div class="stat-val">${fmt(stats.total_customers)}</div>
          <div class="stat-sub">${fmt(stats.active_7d)} active this week</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(16,185,129,0.15);color:var(--green)"><ion-icon name="checkmark-circle"></ion-icon></div>
          <div class="stat-label">Avg Fact Find</div>
          <div class="stat-val">${pct(stats.avg_fact_find)}%</div>
          <div class="stat-sub">Completion rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(139,92,246,0.15);color:var(--purple)"><ion-icon name="trending-up"></ion-icon></div>
          <div class="stat-label">Avg Level</div>
          <div class="stat-val">${Number(stats.avg_level || 1).toFixed(1)}</div>
          <div class="stat-sub">Avg streak: ${Number(stats.avg_streak || 0).toFixed(1)}d</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background:rgba(245,158,11,0.15);color:var(--gold)"><ion-icon name="star"></ion-icon></div>
          <div class="stat-label">Total Good Coins</div>
          <div class="stat-val">${fmt(stats.total_points_issued || stats.total_points || 0)}</div>
          <div class="stat-sub">Coins issued</div>
        </div>
      </div>`;

    if (recentActivity.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Recent Client Activity</h3></div>`;
      recentActivity.slice(0, 10).forEach(a => {
        html += `<div class="activity-item">
          <div class="activity-dot"></div>
          <div>
            <div class="activity-text"><strong>${esc(a.customer_name || 'Unknown')}</strong> — ${esc(a.action)}</div>
            <div class="activity-time">${timeAgo(a.created_at)}</div>
          </div>
          ${a.points_earned > 0 ? `<div class="activity-pts">+${a.points_earned} coins</div>` : ''}
        </div>`;
      });
      html += '</div>';
    }

    if (!isGod() && currentUser.advisorId) {
      try {
        const customers = await api('/customers?advisor_id=' + currentUser.advisorId);
        if (customers.length > 0) {
          const recent = customers.filter(c => c.last_active).sort((a, b) => new Date(b.last_active) - new Date(a.last_active)).slice(0, 5);
          if (recent.length) {
            html += `<div class="card"><div class="card-header"><h3>Recently Active Clients</h3></div>
            <table><thead><tr><th>Client</th><th>Level</th><th>Good Coins</th><th>Fact Find</th><th>Last Active</th></tr></thead><tbody>`;
            recent.forEach(c => {
              html += `<tr class="clickable" onclick="viewClient(${c.id})">
                <td><strong>${esc(c.name || 'Unnamed')}</strong></td>
                <td>${c.level}</td><td>${fmt(c.total_points_earned)}</td>
                <td><div class="progress-bar" style="width:60px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${pct(c.fact_find_progress)}%"></div></div> ${pct(c.fact_find_progress)}%</td>
                <td>${timeAgo(c.last_active)}</td>
              </tr>`;
            });
            html += '</tbody></table></div>';
          }
        }
      } catch {}
    }

    $('dash-content').innerHTML = html;
  } catch (e) {
    $('dash-content').innerHTML = '<div class="empty-state">Failed to load dashboard</div>';
  }
}

let clientSearch = '';
let clientAdvisorFilter = '';
let clientSort = 'last_active';
let clientSortDir = 'desc';

async function renderClients() {
  setMain(`<div class="page-header"><h1>${isGod() ? 'All Clients' : 'My Clients'}</h1><p>Manage your client portfolio</p></div><div id="clients-content"><div class="loading">Loading clients...</div></div>`);
  try {
    let url = '/customers';
    if (isAdviser() && currentUser.advisorId) url += '?advisor_id=' + currentUser.advisorId;
    else if (clientAdvisorFilter) url += '?advisor_id=' + clientAdvisorFilter;
    const customers = await api(url);
    cache.customers = customers;

    let advisors = [];
    if (isGod()) {
      try { advisors = await api('/advisors'); cache.advisors = advisors; } catch {}
    }

    let filtered = customers;
    if (clientSearch) {
      const s = clientSearch.toLowerCase();
      filtered = filtered.filter(c => (c.name || '').toLowerCase().includes(s) || (c.email || '').toLowerCase().includes(s));
    }

    filtered.sort((a, b) => {
      let va = a[clientSort], vb = b[clientSort];
      if (clientSort === 'last_active' || clientSort === 'created_at') {
        va = va ? new Date(va).getTime() : 0;
        vb = vb ? new Date(vb).getTime() : 0;
      }
      if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
      if (va < vb) return clientSortDir === 'asc' ? -1 : 1;
      if (va > vb) return clientSortDir === 'asc' ? 1 : -1;
      return 0;
    });

    let html = '<div class="search-bar">';
    html += `<input type="text" placeholder="Search by name or email..." value="${esc(clientSearch)}" oninput="clientSearch=this.value;renderClientsTable()">`;
    if (isGod() && advisors.length > 0) {
      html += `<select onchange="clientAdvisorFilter=this.value;renderClients()"><option value="">All Advisers</option>`;
      advisors.forEach(a => { html += `<option value="${a.id}" ${clientAdvisorFilter == a.id ? 'selected' : ''}>${esc(a.name)}</option>`; });
      html += '</select>';
    }
    html += '</div>';

    html += `<div class="card" style="padding:0;overflow-x:auto"><table><thead><tr>`;
    const cols = [
      { key: 'name', label: 'Name' },
      { key: 'email', label: 'Email' },
      { key: 'level', label: 'Level' },
      { key: 'total_points_earned', label: 'Good Coins' },
      { key: 'streak', label: 'Streak' },
      { key: 'fact_find_progress', label: 'Fact Find %' },
      { key: 'last_active', label: 'Last Active' },
    ];
    if (isGod()) cols.splice(2, 0, { key: 'advisor_name', label: 'Adviser' });
    cols.forEach(col => {
      const arrow = clientSort === col.key ? (clientSortDir === 'asc' ? ' ▲' : ' ▼') : '';
      html += `<th style="cursor:pointer" onclick="sortClients('${col.key}')">${col.label}${arrow}</th>`;
    });
    html += '</tr></thead><tbody id="clients-tbody">'; 

    filtered.forEach(c => {
      html += `<tr class="clickable" onclick="viewClient(${c.id})">
        <td><strong>${esc(c.name || 'Unnamed')}</strong></td>
        <td>${esc(c.email || '—')}</td>`;
      if (isGod()) html += `<td>${esc(c.advisor_name || 'Unassigned')}</td>`;
      html += `<td>${c.level}</td>
        <td>${fmt(c.total_points_earned)}</td>
        <td>${c.streak}d</td>
        <td><div class="progress-bar" style="width:60px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${pct(c.fact_find_progress)}%"></div></div> ${pct(c.fact_find_progress)}%</td>
        <td>${timeAgo(c.last_active)}</td>
      </tr>`;
    });

    if (filtered.length === 0) html += '<tr><td colspan="10" class="empty-state">No clients found</td></tr>';
    html += '</tbody></table></div>';
    html += `<p style="font-size:12px;color:var(--text-muted);margin-top:8px">Showing ${filtered.length} of ${customers.length} clients</p>`;

    $('clients-content').innerHTML = html;
  } catch (e) {
    $('clients-content').innerHTML = '<div class="empty-state">Failed to load clients</div>';
  }
}

function sortClients(key) {
  if (clientSort === key) clientSortDir = clientSortDir === 'asc' ? 'desc' : 'asc';
  else { clientSort = key; clientSortDir = key === 'name' || key === 'email' ? 'asc' : 'desc'; }
  renderClients();
}

function renderClientsTable() {
  renderClients();
}

async function viewClient(id) {
  setMain(`<div id="client-detail"><div class="loading">Loading client...</div></div>`);
  currentPage = 'client-detail';
  try {
    const c = await api('/customers/' + id);
    let advisors = cache.advisors || [];
    if (isGod() && !advisors.length) {
      try { advisors = await api('/advisors'); cache.advisors = advisors; } catch {}
    }

    let html = `<div class="breadcrumb">
      <a onclick="navigate('clients')">${isGod() ? 'All Clients' : 'My Clients'}</a>
      <span>›</span>
      <span>${esc(c.name || 'Client #' + c.id)}</span>
    </div>`;

    html += `<div class="client-header">
      <div class="client-avatar">${initials(c.name)}</div>
      <div class="client-info">
        <h2>${esc(c.name || 'Unnamed Client')}</h2>
        <p>${esc(c.email || 'No email')}${c.phone ? ' · ' + esc(c.phone) : ''}</p>
        <div class="client-meta">
          <span><ion-icon name="time-outline"></ion-icon> Last active: ${timeAgo(c.last_active)}</span>
          <span><ion-icon name="calendar-outline"></ion-icon> Joined: ${fmtDate(c.created_at)}</span>
          ${c.advisor_name ? `<span><ion-icon name="person-outline"></ion-icon> Adviser: ${esc(c.advisor_name)}</span>` : ''}
        </div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="showEditClientModal(${c.id})" style="margin-left:auto"><ion-icon name="create-outline"></ion-icon> Edit</button>
    </div>`;

    html += `<div class="stat-grid">
      <div class="stat-card"><div class="stat-label">Level / XP</div><div class="stat-val">${c.level}</div><div class="stat-sub">${fmt(c.xp)} XP</div></div>
      <div class="stat-card"><div class="stat-label">Good Coins</div><div class="stat-val">${fmt(c.points)}</div><div class="stat-sub">${fmt(c.total_points_earned)} total earned</div></div>
      <div class="stat-card"><div class="stat-label">Streak</div><div class="stat-val">${c.streak}d</div><div class="stat-sub">Daily check-in streak</div></div>
      <div class="stat-card"><div class="stat-label">Token Balance</div><div class="stat-val">$${Number(c.token_balance || 0).toFixed(2)}</div><div class="stat-sub">$${Number(c.total_tokens_earned || 0).toFixed(2)} total</div></div>
      <div class="stat-card"><div class="stat-label">Fact Find</div><div class="stat-val">${pct(c.fact_find_progress)}%</div><div class="progress-bar" style="margin-top:8px"><div class="fill" style="width:${pct(c.fact_find_progress)}%"></div></div></div>
    </div>`;

    const missions = c.completed_missions || [];
    const badges = c.unlocked_badges || [];
    const rewards = c.redeemed_rewards || [];

    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">';
    html += `<div class="card"><div class="card-header"><h3>Completed Missions (${missions.length})</h3></div>`;
    if (missions.length) { html += '<div class="tag-list">'; missions.forEach(m => html += `<span class="tag">${esc(m)}</span>`); html += '</div>'; }
    else html += '<div class="empty-state">No missions completed yet</div>';
    html += '</div>';

    html += `<div class="card"><div class="card-header"><h3>Earned Badges (${badges.length})</h3></div>`;
    if (badges.length) { html += '<div class="tag-list">'; badges.forEach(b => html += `<span class="tag" style="background:rgba(245,158,11,0.12);color:var(--gold)">${esc(b)}</span>`); html += '</div>'; }
    else html += '<div class="empty-state">No badges earned yet</div>';
    html += '</div>';
    html += '</div>';

    if (rewards.length) {
      html += `<div class="card"><div class="card-header"><h3>Redeemed Rewards (${rewards.length})</h3></div>`;
      html += '<div class="tag-list">'; rewards.forEach(r => html += `<span class="tag" style="background:rgba(139,92,246,0.12);color:var(--purple)">${esc(r)}</span>`); html += '</div></div>';
    }

    const fd = c.finance_data || {};
    if (Object.keys(fd).length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Finance Summary</h3></div><div class="finance-grid">`;
      for (const [key, val] of Object.entries(fd)) {
        if (val !== null && val !== undefined && val !== '' && typeof val !== 'object') {
          const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          html += `<div class="finance-item"><div class="fi-label">${esc(label)}</div><div class="fi-val">${typeof val === 'number' ? fmt(val) : esc(String(val))}</div></div>`;
        }
      }
      html += '</div></div>';
    }

    const activities = c.recent_activities || [];
    if (activities.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Recent Activity</h3></div>`;
      activities.forEach(a => {
        html += `<div class="activity-item">
          <div class="activity-dot"></div>
          <div>
            <div class="activity-text">${esc(a.action)}</div>
            <div class="activity-time">${fmtDateTime(a.created_at)}</div>
          </div>
          ${a.points_earned > 0 ? `<div class="activity-pts">+${a.points_earned} coins</div>` : ''}
        </div>`;
      });
      html += '</div>';
    }

    cache.currentClient = c;
    cache.clientAdvisors = advisors;
    $('client-detail').innerHTML = html;
  } catch (e) {
    $('client-detail').innerHTML = '<div class="empty-state">Failed to load client details</div>';
  }
}

function showEditClientModal(id) {
  const c = cache.currentClient;
  const advisors = cache.clientAdvisors || [];
  let advisorOpts = '<option value="">Unassigned</option>';
  advisors.forEach(a => { advisorOpts += `<option value="${a.id}" ${c.advisor_id == a.id ? 'selected' : ''}>${esc(a.name)}</option>`; });

  showModal(`
    <h2>Edit Client</h2>
    <div class="form-group"><label>Name</label><input id="m-client-name" value="${esc(c.name || '')}"></div>
    <div class="form-group"><label>Email</label><input id="m-client-email" value="${esc(c.email || '')}"></div>
    <div class="form-group"><label>Phone</label><input id="m-client-phone" value="${esc(c.phone || '')}"></div>
    ${isGod() ? `<div class="form-group"><label>Assigned Adviser</label><select id="m-client-advisor">${advisorOpts}</select></div>` : ''}
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveClient(${id})">Save Changes</button>
    </div>
  `);
}

async function saveClient(id) {
  const data = {
    name: $('m-client-name').value,
    email: $('m-client-email').value,
    phone: $('m-client-phone').value,
  };
  if (isGod()) {
    const av = $('m-client-advisor');
    data.advisor_id = av ? (av.value || null) : undefined;
  }
  try {
    await api('/customers/' + id, { method: 'PUT', body: JSON.stringify(data) });
    hideModal();
    toast('Client updated successfully');
    viewClient(id);
  } catch (e) { toast('Failed to save: ' + e.message, 'error'); }
}

async function renderReports() {
  setMain(`<div class="page-header"><h1>Reports</h1><p>${isGod() ? 'Global analytics and performance reports' : 'Your portfolio performance'}</p></div><div id="reports-content"><div class="loading">Loading reports...</div></div>`);
  try {
    let html = '';
    if (isGod()) {
      const data = await api('/analytics/overview');
      const o = data.overview;

      html += `<div class="stat-grid">
        <div class="stat-card"><div class="stat-label">Total Clients</div><div class="stat-val">${fmt(o.total_customers)}</div></div>
        <div class="stat-card"><div class="stat-label">Active (7d)</div><div class="stat-val">${fmt(o.active_7d)}</div></div>
        <div class="stat-card"><div class="stat-label">Active (30d)</div><div class="stat-val">${fmt(o.active_30d)}</div></div>
        <div class="stat-card"><div class="stat-label">Unassigned</div><div class="stat-val">${fmt(data.unassigned_customers)}</div></div>
        <div class="stat-card"><div class="stat-label">Tokens Issued</div><div class="stat-val">${fmt(o.total_tokens_issued)}</div></div>
      </div>`;

      const active7d = Number(o.active_7d);
      const inactive = Number(o.total_customers) - active7d;
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">';
      html += `<div class="card"><div class="card-header"><h3>Client Engagement</h3></div>
        <div class="chart-container">${renderPieChart([{label:'Active (7d)',value:active7d,color:'#10B981'},{label:'Inactive',value:inactive,color:'#EF4444'}], 100)}</div></div>`;

      const levelDist = data.level_distribution || [];
      if (levelDist.length > 0) {
        html += `<div class="card"><div class="card-header"><h3>Level Distribution</h3></div>
          <div class="chart-container">${renderBarChart(levelDist.map(l => ({label:'L'+l.level, value:Number(l.count)})), '#8B5CF6')}</div></div>`;
      }
      html += '</div>';

      if (data.by_advisor.length > 0) {
        html += `<div class="card"><div class="card-header"><h3>Adviser Performance Comparison</h3></div>
          <div style="overflow-x:auto"><table><thead><tr><th>Adviser</th><th>Clients</th><th>Active (7d)</th><th>Avg Fact Find</th><th>Total Coins</th><th>Avg Level</th><th>Avg Streak</th><th>Tokens</th><th>Status</th></tr></thead><tbody>`;
        data.by_advisor.forEach(a => {
          html += `<tr>
            <td><strong>${esc(a.name)}</strong><br><small style="color:var(--text-muted)">${esc(a.email)}</small></td>
            <td>${a.customer_count}</td><td>${a.active_7d}</td>
            <td><div class="progress-bar" style="width:60px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${pct(a.avg_fact_find)}%"></div></div> ${pct(a.avg_fact_find)}%</td>
            <td>${fmt(a.total_points)}</td><td>${Number(a.avg_level).toFixed(1)}</td><td>${Number(a.avg_streak).toFixed(1)}d</td><td>${fmt(a.total_tokens)}</td>
            <td><span class="badge ${a.status==='active'?'badge-active':'badge-inactive'}">${a.status}</span></td>
          </tr>`;
        });
        html += '</tbody></table></div></div>';
      }
    } else {
      const aid = currentUser.advisorId;
      if (!aid) { $('reports-content').innerHTML = '<div class="empty-state">No adviser profile linked to your account</div>'; return; }
      const data = await api('/analytics/advisor/' + aid);
      const s = data.stats;
      const customers = data.customers || [];

      html += `<div class="stat-grid">
        <div class="stat-card"><div class="stat-label">Total Clients</div><div class="stat-val">${fmt(s.total_customers)}</div></div>
        <div class="stat-card"><div class="stat-label">Active (7d)</div><div class="stat-val">${fmt(s.active_7d)}</div></div>
        <div class="stat-card"><div class="stat-label">Avg Fact Find</div><div class="stat-val">${pct(s.avg_fact_find)}%</div></div>
        <div class="stat-card"><div class="stat-label">Total Good Coins</div><div class="stat-val">${fmt(s.total_points)}</div></div>
      </div>`;

      const active7d = Number(s.active_7d);
      const inactive = Number(s.total_customers) - active7d;
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">';
      html += `<div class="card"><div class="card-header"><h3>Client Engagement</h3></div>
        <div class="chart-container">${renderPieChart([{label:'Active (7d)',value:active7d,color:'#10B981'},{label:'Inactive',value:inactive,color:'#EF4444'}], 100)}</div></div>`;

      if (customers.length > 0) {
        const ffRanges = [{label:'0-25%',min:0,max:25,color:'#EF4444'},{label:'26-50%',min:26,max:50,color:'#F59E0B'},{label:'51-75%',min:51,max:75,color:'#3B82F6'},{label:'76-100%',min:76,max:100,color:'#10B981'}];
        const ffData = ffRanges.map(r => ({label:r.label, value:customers.filter(c => c.fact_find_progress >= r.min && c.fact_find_progress <= r.max).length, color:r.color}));
        html += `<div class="card"><div class="card-header"><h3>Fact Find Completion</h3></div>
          <div class="chart-container">${renderPieChart(ffData, 100)}</div></div>`;
      }
      html += '</div>';

      if (customers.length > 0) {
        const pointsData = customers.filter(c => c.total_points_earned > 0).sort((a, b) => b.total_points_earned - a.total_points_earned).slice(0, 10);
        if (pointsData.length) {
          html += `<div class="card"><div class="card-header"><h3>Good Coins Distribution — Top Clients</h3></div>
            <div class="chart-container">${renderBarChart(pointsData.map(c => ({label: (c.name||'?').split(' ')[0], value: Number(c.total_points_earned)})), '#F59E0B')}</div></div>`;
        }

        const topClients = [...customers].sort((a, b) => (b.level * 1000 + b.streak * 10 + b.total_points_earned) - (a.level * 1000 + a.streak * 10 + a.total_points_earned)).slice(0, 5);
        html += `<div class="card"><div class="card-header"><h3>Top Performing Clients</h3></div>
          <table><thead><tr><th>Client</th><th>Level</th><th>Streak</th><th>Good Coins</th><th>Fact Find</th></tr></thead><tbody>`;
        topClients.forEach(c => {
          html += `<tr class="clickable" onclick="viewClient(${c.id})"><td><strong>${esc(c.name || 'Unnamed')}</strong></td><td>${c.level}</td><td>${c.streak}d</td><td>${fmt(c.total_points_earned)}</td><td>${pct(c.fact_find_progress)}%</td></tr>`;
        });
        html += '</tbody></table></div>';
      }
    }

    $('reports-content').innerHTML = html;
  } catch (e) {
    $('reports-content').innerHTML = '<div class="empty-state">Failed to load reports</div>';
  }
}

function renderPieChart(data, radius) {
  const total = data.reduce((s, d) => s + d.value, 0);
  if (total === 0) return '<div class="empty-state">No data</div>';
  const r = radius || 80;
  const cx = r + 10, cy = r + 10;
  let svg = `<svg width="${(r+10)*2}" height="${(r+10)*2}" viewBox="0 0 ${(r+10)*2} ${(r+10)*2}">`;
  let startAngle = -90;
  data.forEach(d => {
    if (d.value === 0) return;
    const pct = d.value / total;
    const angle = pct * 360;
    const endAngle = startAngle + angle;
    const largeArc = angle > 180 ? 1 : 0;
    const x1 = cx + r * Math.cos(startAngle * Math.PI / 180);
    const y1 = cy + r * Math.sin(startAngle * Math.PI / 180);
    const x2 = cx + r * Math.cos(endAngle * Math.PI / 180);
    const y2 = cy + r * Math.sin(endAngle * Math.PI / 180);
    if (data.filter(dd => dd.value > 0).length === 1) {
      svg += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${d.color}" opacity="0.8"/>`;
    } else {
      svg += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc},1 ${x2},${y2} Z" fill="${d.color}" opacity="0.8"/>`;
    }
    startAngle = endAngle;
  });
  svg += '</svg>';
  let legend = '<div class="chart-legend">';
  data.forEach(d => {
    const p = total > 0 ? ((d.value / total) * 100).toFixed(0) : 0;
    legend += `<div class="chart-legend-item"><div class="dot" style="background:${d.color}"></div>${d.label}: ${d.value} (${p}%)</div>`;
  });
  legend += '</div>';
  return svg + legend;
}

function renderBarChart(data, color) {
  if (!data.length) return '<div class="empty-state">No data</div>';
  const maxVal = Math.max(...data.map(d => d.value));
  const barW = Math.min(40, Math.floor(300 / data.length));
  const h = 160;
  const w = data.length * (barW + 8) + 20;
  let svg = `<svg width="${w}" height="${h + 30}" viewBox="0 0 ${w} ${h + 30}">`;
  data.forEach((d, i) => {
    const bh = maxVal > 0 ? (d.value / maxVal) * h : 0;
    const x = i * (barW + 8) + 10;
    const y = h - bh;
    svg += `<rect x="${x}" y="${y}" width="${barW}" height="${bh}" rx="4" fill="${color}" opacity="0.8"/>`;
    svg += `<text x="${x + barW / 2}" y="${h + 14}" text-anchor="middle" fill="#94A3B8" font-size="10" font-family="DM Sans">${d.label}</text>`;
    svg += `<text x="${x + barW / 2}" y="${y - 4}" text-anchor="middle" fill="#E2E8F0" font-size="10" font-family="DM Sans">${d.value}</text>`;
  });
  svg += '</svg>';
  return svg;
}

async function renderAdvisers() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Advisers</h1><p>Manage adviser team</p></div><div id="advisers-content"><div class="loading">Loading advisers...</div></div>`);
  try {
    const advisors = await api('/advisors');
    cache.advisors = advisors;
    let html = `<div style="margin-bottom:16px"><button class="btn btn-primary btn-sm" onclick="showAdviserModal()"><ion-icon name="add-outline"></ion-icon> Add Adviser</button></div>`;

    advisors.forEach(a => {
      html += `<div class="advisor-card">
        <div class="advisor-row">
          <div class="advisor-avatar">${initials(a.name)}</div>
          <div class="advisor-info">
            <h4>${esc(a.name)}</h4>
            <p>${esc(a.email)}${a.phone ? ' · ' + esc(a.phone) : ''}</p>
            ${a.specialization ? `<p style="color:var(--teal-light);font-size:11px;margin-top:2px">${esc(a.specialization)}</p>` : ''}
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <span class="badge ${a.status === 'active' ? 'badge-active' : 'badge-inactive'}">${a.status}</span>
            <button class="btn btn-secondary btn-sm" onclick="showAdviserModal(${a.id})"><ion-icon name="create-outline"></ion-icon></button>
            <button class="btn btn-secondary btn-sm" onclick="showCreateAdviserLogin(${a.id},'${esc(a.name)}','${esc(a.email)}')" title="Create Login"><ion-icon name="key-outline"></ion-icon></button>
            <button class="btn btn-danger btn-sm" onclick="deleteAdviser(${a.id})"><ion-icon name="trash-outline"></ion-icon></button>
          </div>
        </div>
        <div class="advisor-stats">
          <div class="advisor-stat"><strong>${a.customer_count}</strong>Clients</div>
          <div class="advisor-stat"><strong>${fmt(a.total_customer_points)}</strong>Total Coins</div>
          <div class="advisor-stat"><strong>${pct(a.avg_fact_find_progress)}%</strong>Avg Fact Find</div>
          ${a.license_number ? `<div class="advisor-stat"><strong>${esc(a.license_number)}</strong>License</div>` : ''}
        </div>
      </div>`;
    });

    if (advisors.length === 0) html += '<div class="empty-state">No advisers yet</div>';
    $('advisers-content').innerHTML = html;
  } catch (e) {
    $('advisers-content').innerHTML = '<div class="empty-state">Failed to load advisers</div>';
  }
}

function showAdviserModal(editId) {
  const a = editId ? (cache.advisors || []).find(x => x.id === editId) : null;
  showModal(`
    <h2>${a ? 'Edit Adviser' : 'Add New Adviser'}</h2>
    <div class="form-group"><label>Name</label><input id="m-adv-name" value="${esc(a?.name || '')}"></div>
    <div class="form-group"><label>Email</label><input id="m-adv-email" value="${esc(a?.email || '')}"></div>
    <div class="form-group"><label>Phone</label><input id="m-adv-phone" value="${esc(a?.phone || '')}"></div>
    <div class="form-group"><label>License Number</label><input id="m-adv-license" value="${esc(a?.license_number || '')}"></div>
    <div class="form-group"><label>Specialization</label><input id="m-adv-spec" value="${esc(a?.specialization || '')}" placeholder="e.g. Mortgage, Super, Insurance"></div>
    ${a ? `<div class="form-group"><label>Status</label><select id="m-adv-status"><option ${a.status==='active'?'selected':''}>active</option><option ${a.status==='inactive'?'selected':''}>inactive</option></select></div>` : ''}
    <div class="form-group"><label>Notes</label><textarea id="m-adv-notes">${esc(a?.notes || '')}</textarea></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveAdviser(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveAdviser(editId) {
  const data = {
    name: $('m-adv-name').value,
    email: $('m-adv-email').value,
    phone: $('m-adv-phone').value,
    license_number: $('m-adv-license').value,
    specialization: $('m-adv-spec').value,
    notes: $('m-adv-notes').value,
  };
  if (editId) {
    const st = $('m-adv-status');
    data.status = st ? st.value : 'active';
  }
  try {
    if (editId) await api('/advisors/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/advisors', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast(editId ? 'Adviser updated' : 'Adviser created');
    renderAdvisers();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteAdviser(id) {
  if (!confirm('Delete this adviser? Their clients will become unassigned.')) return;
  try {
    await api('/advisors/' + id, { method: 'DELETE' });
    toast('Adviser deleted');
    renderAdvisers();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

function showCreateAdviserLogin(advisorId, name, email) {
  showModal(`
    <h2>Create Login for ${esc(name)}</h2>
    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px">This will create an admin account with the "adviser" role, linked to this adviser profile.</p>
    <div class="form-group"><label>Email</label><input id="m-login-email" value="${esc(email)}"></div>
    <div class="form-group"><label>Password</label><input type="password" id="m-login-pass" placeholder="Set a password"></div>
    <div class="form-group"><label>Display Name</label><input id="m-login-name" value="${esc(name)}"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createAdviserLogin(${advisorId})">Create Login</button>
    </div>
  `);
}

async function createAdviserLogin(advisorId) {
  const data = {
    email: $('m-login-email').value,
    password: $('m-login-pass').value,
    name: $('m-login-name').value,
    role: 'adviser',
    advisor_id: advisorId,
  };
  try {
    await api('/admin-users', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast('Login created successfully');
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

let messagesFilter = 'all';
let messagesCache = [];

async function renderMessages() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Tooltips, Pop-ups & FTUE</h1><p>Manage in-app messages and user guidance</p></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <div style="display:flex;gap:6px" id="msg-filters">
        <button class="btn btn-sm ${messagesFilter==='all'?'btn-primary':'btn-secondary'}" onclick="messagesFilter='all';renderMessages()">All</button>
        <button class="btn btn-sm ${messagesFilter==='tooltip'?'btn-primary':'btn-secondary'}" onclick="messagesFilter='tooltip';renderMessages()">Tooltips</button>
        <button class="btn btn-sm ${messagesFilter==='popup'?'btn-primary':'btn-secondary'}" onclick="messagesFilter='popup';renderMessages()">Pop-ups</button>
        <button class="btn btn-sm ${messagesFilter==='ftue'?'btn-primary':'btn-secondary'}" onclick="messagesFilter='ftue';renderMessages()">FTUE</button>
      </div>
      <button class="btn btn-primary btn-sm" onclick="showMessageModal()"><ion-icon name="add-outline"></ion-icon> New Message</button>
    </div>
    <div id="messages-content"><div class="loading">Loading...</div></div>`);
  try {
    const msgs = await api('/messages?type=' + messagesFilter);
    messagesCache = msgs;
    if (!msgs.length) { $('messages-content').innerHTML = '<div class="empty-state">No messages found</div>'; return; }
    let html = '<div class="card"><table><thead><tr><th>Type</th><th>Title</th><th>Target</th><th>Display Rule</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    msgs.forEach(m => {
      const typeBadge = m.type === 'tooltip' ? 'background:rgba(59,130,246,0.15);color:#60A5FA' : m.type === 'popup' ? 'background:rgba(139,92,246,0.15);color:#A78BFA' : 'background:rgba(16,185,129,0.15);color:#34D399';
      html += `<tr>
        <td><span class="badge" style="${typeBadge}">${m.type}</span></td>
        <td><strong style="color:#fff">${esc(m.title)}</strong>${m.body ? '<br><span style="font-size:11px;color:var(--text-muted)">' + esc(m.body).substring(0,60) + (m.body.length>60?'...':'') + '</span>' : ''}</td>
        <td>${m.target_screen || 'all'}</td>
        <td>${m.display_rule}</td>
        <td>${m.priority}</td>
        <td><span class="badge ${m.is_active?'badge-active':'badge-inactive'}" style="cursor:pointer" onclick="toggleMessageActive(${m.id},${!m.is_active})">${m.is_active?'Active':'Inactive'}</span></td>
        <td><button class="btn btn-secondary btn-sm" onclick="showMessageModal(${m.id})" style="margin-right:4px"><ion-icon name="pencil-outline"></ion-icon></button><button class="btn btn-danger btn-sm" onclick="deleteMessage(${m.id})"><ion-icon name="trash-outline"></ion-icon></button></td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    $('messages-content').innerHTML = html;
  } catch (e) { $('messages-content').innerHTML = '<div class="empty-state">Failed to load messages</div>'; }
}

async function toggleMessageActive(id, active) {
  const msg = messagesCache.find(m => m.id === id);
  if (!msg) return;
  try {
    await api('/messages/' + id, { method: 'PUT', body: JSON.stringify({ ...msg, is_active: active }) });
    toast(active ? 'Message activated' : 'Message deactivated');
    renderMessages();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function showMessageModal(editId) {
  let msg = editId ? messagesCache.find(m => m.id === editId) : null;
  let segments = [];
  try { segments = await api('/segments'); } catch {}

  let segOpts = '<option value="">None</option>';
  segments.forEach(s => segOpts += `<option value="${s.id}" ${msg && msg.segment_id==s.id?'selected':''}>${esc(s.name)}</option>`);

  const screenOpts = ['overview','mortgage','super','budget','insurance','rewards','banks','planning','investor','fact-find','all']
    .map(s => `<option value="${s}" ${msg && msg.target_screen===s?'selected':''}>${s}</option>`).join('');

  showModal(`
    <h2>${editId ? 'Edit' : 'New'} Message</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Message ID (slug)</label><input id="m-msg-id" value="${msg?esc(msg.message_id):''}" ${editId?'readonly style="opacity:0.6"':''}></div>
      <div class="form-group"><label>Type</label><select id="m-msg-type"><option value="tooltip" ${msg&&msg.type==='tooltip'?'selected':''}>Tooltip</option><option value="popup" ${msg&&msg.type==='popup'?'selected':''}>Pop-up</option><option value="ftue" ${msg&&msg.type==='ftue'?'selected':''}>FTUE</option></select></div>
    </div>
    <div class="form-group"><label>Title</label><input id="m-msg-title" value="${msg?esc(msg.title):''}" oninput="if(!${!!editId}){document.getElementById('m-msg-id').value=this.value.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'')}"></div>
    <div class="form-group"><label>Body</label><textarea id="m-msg-body" rows="3">${msg?esc(msg.body||''):''}</textarea></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>CTA Text</label><input id="m-msg-cta" value="${msg?esc(msg.cta_text||''):''}"></div>
      <div class="form-group"><label>CTA Action (tab/URL)</label><input id="m-msg-action" value="${msg?esc(msg.cta_action||''):''}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Target Screen</label><select id="m-msg-screen">${screenOpts}</select></div>
      <div class="form-group"><label>Position</label><select id="m-msg-pos"><option value="center" ${msg&&msg.position==='center'?'selected':''}>Center</option><option value="bottom" ${msg&&msg.position==='bottom'?'selected':''}>Bottom</option><option value="top" ${msg&&msg.position==='top'?'selected':''}>Top</option><option value="left" ${msg&&msg.position==='left'?'selected':''}>Left</option><option value="right" ${msg&&msg.position==='right'?'selected':''}>Right</option></select></div>
    </div>
    <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px">
      <div class="form-group"><label>Icon (ionicons)</label><input id="m-msg-icon" value="${msg?esc(msg.icon||''):''}"></div>
      <div class="form-group"><label>Icon Color</label><input type="color" id="m-msg-iconcolor" value="${msg?msg.icon_color||'#0D9488':'#0D9488'}" style="height:38px"></div>
      <div class="form-group"><label>BG Color</label><input type="color" id="m-msg-bgcolor" value="${msg?msg.bg_color||'#132D46':'#132D46'}" style="height:38px"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="form-group"><label>Display Rule</label><select id="m-msg-rule"><option value="once" ${msg&&msg.display_rule==='once'?'selected':''}>Once</option><option value="every_session" ${msg&&msg.display_rule==='every_session'?'selected':''}>Every Session</option><option value="every_time" ${msg&&msg.display_rule==='every_time'?'selected':''}>Every Time</option><option value="first_time_only" ${msg&&msg.display_rule==='first_time_only'?'selected':''}>First Time Only</option></select></div>
      <div class="form-group"><label>Priority (1-10)</label><input type="number" id="m-msg-priority" min="1" max="10" value="${msg?msg.priority:5}"></div>
      <div class="form-group"><label>Delay (ms)</label><input type="number" id="m-msg-delay" min="0" value="${msg?msg.delay_ms:500}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Start Date</label><input type="datetime-local" id="m-msg-start" value="${msg&&msg.start_date?new Date(msg.start_date).toISOString().slice(0,16):''}"></div>
      <div class="form-group"><label>End Date</label><input type="datetime-local" id="m-msg-end" value="${msg&&msg.end_date?new Date(msg.end_date).toISOString().slice(0,16):''}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Segment</label><select id="m-msg-segment">${segOpts}</select></div>
      <div class="form-group"><label>Sort Order</label><input type="number" id="m-msg-sort" min="0" value="${msg?msg.sort_order:0}"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveMessage(${editId||'null'})">${editId?'Update':'Create'} Message</button>
    </div>
  `);
}

async function saveMessage(editId) {
  const data = {
    message_id: $('m-msg-id').value.trim(),
    type: $('m-msg-type').value,
    title: $('m-msg-title').value.trim(),
    body: $('m-msg-body').value.trim(),
    cta_text: $('m-msg-cta').value.trim() || null,
    cta_action: $('m-msg-action').value.trim() || null,
    target_screen: $('m-msg-screen').value,
    position: $('m-msg-pos').value,
    icon: $('m-msg-icon').value.trim() || null,
    icon_color: $('m-msg-iconcolor').value,
    bg_color: $('m-msg-bgcolor').value,
    display_rule: $('m-msg-rule').value,
    priority: parseInt($('m-msg-priority').value) || 5,
    delay_ms: parseInt($('m-msg-delay').value) || 500,
    is_active: editId ? (messagesCache.find(m=>m.id===editId)?.is_active ?? true) : true,
    start_date: $('m-msg-start').value || null,
    end_date: $('m-msg-end').value || null,
    segment_id: $('m-msg-segment').value ? parseInt($('m-msg-segment').value) : null,
    sort_order: parseInt($('m-msg-sort').value) || 0
  };
  if (!data.message_id || !data.title) { toast('Message ID and Title are required', 'error'); return; }
  try {
    if (editId) {
      await api('/messages/' + editId, { method: 'PUT', body: JSON.stringify(data) });
      toast('Message updated');
    } else {
      await api('/messages', { method: 'POST', body: JSON.stringify(data) });
      toast('Message created');
    }
    hideModal();
    renderMessages();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteMessage(id) {
  if (!confirm('Delete this message?')) return;
  try {
    await api('/messages/' + id, { method: 'DELETE' });
    toast('Message deleted');
    renderMessages();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function renderSettings() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Settings</h1><p>Manage admin users and system access</p></div><div id="settings-content"><div class="loading">Loading...</div></div>`);
  try {
    const users = await api('/admin-users');
    let html = `<div class="card"><div class="card-header"><h3>Admin Users</h3><button class="btn btn-primary btn-sm" onclick="showCreateUserModal()"><ion-icon name="add-outline"></ion-icon> Add User</button></div>
      <table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Created</th><th>Last Login</th></tr></thead><tbody>`;
    users.forEach(u => {
      const roleBadge = u.role === 'god' ? 'badge-god' : u.role === 'adviser' ? 'badge-adviser' : 'badge-active';
      html += `<tr>
        <td><strong>${esc(u.name)}</strong></td>
        <td>${esc(u.email)}</td>
        <td><span class="badge ${roleBadge}">${u.role}</span></td>
        <td>${fmtDate(u.created_at)}</td>
        <td>${u.last_login ? fmtDateTime(u.last_login) : 'Never'}</td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    $('settings-content').innerHTML = html;
  } catch (e) {
    $('settings-content').innerHTML = '<div class="empty-state">Failed to load settings</div>';
  }
}

function showCreateUserModal() {
  const advisors = cache.advisors || [];
  let advOpts = '<option value="">None</option>';
  advisors.forEach(a => advOpts += `<option value="${a.id}">${esc(a.name)}</option>`);

  showModal(`
    <h2>Create Admin User</h2>
    <div class="form-group"><label>Name</label><input id="m-user-name"></div>
    <div class="form-group"><label>Email</label><input id="m-user-email"></div>
    <div class="form-group"><label>Password</label><input type="password" id="m-user-pass"></div>
    <div class="form-group"><label>Role</label><select id="m-user-role" onchange="document.getElementById('m-user-advisor-group').style.display=this.value==='adviser'?'block':'none'">
      <option value="admin">Admin</option>
      <option value="adviser">Adviser</option>
      <option value="god">God</option>
    </select></div>
    <div class="form-group" id="m-user-advisor-group" style="display:none"><label>Linked Adviser</label><select id="m-user-advisor">${advOpts}</select></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createUser()">Create User</button>
    </div>
  `);
}

async function createUser() {
  const data = {
    name: $('m-user-name').value,
    email: $('m-user-email').value,
    password: $('m-user-pass').value,
    role: $('m-user-role').value,
  };
  if (data.role === 'adviser') {
    const av = $('m-user-advisor');
    if (av && av.value) data.advisor_id = parseInt(av.value);
  }
  try {
    await api('/admin-users', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast('User created');
    renderSettings();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

let questTypeFilter = 'all';
async function renderQuests() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Quests & Missions</h1><p>Manage in-app quests and missions for users</p></div><div id="quests-content"><div class="loading">Loading...</div></div>`);
  try {
    const quests = await api('/quests');
    cache.quests = quests;
    let segments = [];
    try { segments = await api('/segments'); cache.segments = segments; } catch {}

    let html = `<div class="card"><div class="card-header"><h3>All Quests (${quests.length})</h3><button class="btn btn-primary btn-sm" onclick="showQuestModal()"><ion-icon name="add-outline"></ion-icon> Add Quest</button></div>`;
    html += `<table><thead><tr><th>Icon</th><th>Title</th><th>Description</th><th>Base Coins</th><th>2x Active</th><th>Category</th><th>Segment</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    quests.forEach(q => {
      const statusBadge = q.is_active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>';
      const twoxBadge = q.is_2x_active ? '<span class="badge badge-god">2x</span>' : '<span style="color:var(--text-muted);font-size:12px">—</span>';
      html += `<tr>
        <td><ion-icon name="${esc(q.icon || 'help-outline')}" style="font-size:20px;color:${esc(q.icon_bg || 'var(--teal)')}"></ion-icon></td>
        <td><strong>${esc(q.title)}</strong></td>
        <td style="max-width:220px;font-size:12px;color:var(--text-secondary)">${esc(q.description || '')}</td>
        <td>${fmt(q.base_points)}</td>
        <td>${twoxBadge}</td>
        <td><span style="font-size:12px;color:var(--text-muted)">${esc(q.category || 'mission')}</span></td>
        <td>${q.segment_name ? '<span class="badge badge-adviser">' + esc(q.segment_name) + '</span>' : '<span style="font-size:12px;color:var(--text-muted)">All</span>'}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="showQuestModal(${q.id})" style="margin-right:4px"><ion-icon name="create-outline"></ion-icon></button>
          <button class="btn btn-danger btn-sm" onclick="deleteQuest(${q.id})"><ion-icon name="trash-outline"></ion-icon></button>
        </td>
      </tr>`;
    });
    if (quests.length === 0) html += '<tr><td colspan="9" class="empty-state">No quests configured</td></tr>';
    html += '</tbody></table></div>';
    $('quests-content').innerHTML = html;
  } catch (e) {
    $('quests-content').innerHTML = '<div class="empty-state">Failed to load quests</div>';
  }
}

function showQuestModal(editId) {
  const q = editId ? (cache.quests || []).find(x => x.id === editId) : null;
  const segments = cache.segments || [];
  let segOpts = '<option value="">All Users</option>';
  segments.forEach(s => segOpts += `<option value="${s.id}" ${q && q.segment_id == s.id ? 'selected' : ''}>${esc(s.name)}</option>`);

  showModal(`
    <h2>${q ? 'Edit Quest' : 'Add New Quest'}</h2>
    ${!q ? '<div class="form-group"><label>Quest ID (slug)</label><input id="m-q-qid" placeholder="e.g. review_super"></div>' : ''}
    <div class="form-group"><label>Title</label><input id="m-q-title" value="${esc(q?.title || '')}"></div>
    <div class="form-group"><label>Description</label><textarea id="m-q-desc">${esc(q?.description || '')}</textarea></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Icon (Ionicons)</label><input id="m-q-icon" value="${esc(q?.icon || 'help-outline')}" placeholder="e.g. shield-checkmark-outline"></div>
      <div class="form-group"><label>Icon Background</label><input id="m-q-iconbg" type="color" value="${q?.icon_bg || '#3B82F6'}" style="height:40px"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="form-group"><label>Base Coins</label><input id="m-q-points" type="number" value="${q?.base_points || 100}"></div>
      <div class="form-group"><label>Category</label><select id="m-q-cat"><option value="mission" ${(!q || q.category === 'mission') ? 'selected' : ''}>Mission</option><option value="daily" ${q?.category === 'daily' ? 'selected' : ''}>Daily</option><option value="weekly" ${q?.category === 'weekly' ? 'selected' : ''}>Weekly</option><option value="special" ${q?.category === 'special' ? 'selected' : ''}>Special</option></select></div>
      <div class="form-group"><label>Sort Order</label><input id="m-q-sort" type="number" value="${q?.sort_order || 0}"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>2x Multiplier Active</label><select id="m-q-2x"><option value="false" ${!q?.is_2x_active ? 'selected' : ''}>No</option><option value="true" ${q?.is_2x_active ? 'selected' : ''}>Yes</option></select></div>
      <div class="form-group"><label>Segment</label><select id="m-q-seg">${segOpts}</select></div>
    </div>
    ${q ? `<div class="form-group"><label>Status</label><select id="m-q-active"><option value="true" ${q.is_active ? 'selected' : ''}>Active</option><option value="false" ${!q.is_active ? 'selected' : ''}>Inactive</option></select></div>` : ''}
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveQuest(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveQuest(editId) {
  const data = {
    title: $('m-q-title').value,
    description: $('m-q-desc').value,
    icon: $('m-q-icon').value,
    icon_bg: $('m-q-iconbg').value,
    base_points: parseInt($('m-q-points').value) || 100,
    is_2x_active: $('m-q-2x').value === 'true',
    category: $('m-q-cat').value,
    sort_order: parseInt($('m-q-sort').value) || 0,
    segment_id: $('m-q-seg').value || null,
  };
  if (!editId) data.quest_id = $('m-q-qid').value;
  if (editId) data.is_active = $('m-q-active').value === 'true';
  try {
    if (editId) await api('/quests/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/quests', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast(editId ? 'Quest updated' : 'Quest created');
    renderQuests();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteQuest(id) {
  if (!confirm('Delete this quest?')) return;
  try {
    await api('/quests/' + id, { method: 'DELETE' });
    toast('Quest deleted');
    renderQuests();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

let ctaTabFilter = 'all';
async function renderCTAs() {
  if (!isGod()) { navigate('dashboard'); return; }
  setMain(`<div class="page-header"><h1>Sales CTAs</h1><p>Manage call-to-action banners shown on each app tab</p></div><div id="ctas-content"><div class="loading">Loading...</div></div>`);
  try {
    const ctas = await api('/ctas');
    cache.ctas = ctas;
    let segments = [];
    try { segments = await api('/segments'); cache.segments = segments; } catch {}

    const tabs = [...new Set(ctas.map(c => c.tab_key))].sort();
    let filterHtml = `<div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">`;
    filterHtml += `<button class="btn btn-sm ${ctaTabFilter === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="ctaTabFilter='all';renderCTAs()">All</button>`;
    tabs.forEach(t => {
      filterHtml += `<button class="btn btn-sm ${ctaTabFilter === t ? 'btn-primary' : 'btn-secondary'}" onclick="ctaTabFilter='${t}';renderCTAs()">${esc(t.charAt(0).toUpperCase() + t.slice(1))}</button>`;
    });
    filterHtml += '</div>';

    const filtered = ctaTabFilter === 'all' ? ctas : ctas.filter(c => c.tab_key === ctaTabFilter);

    let html = filterHtml;
    html += `<div class="card"><div class="card-header"><h3>CTAs (${filtered.length})</h3><button class="btn btn-primary btn-sm" onclick="showCTAModal()"><ion-icon name="add-outline"></ion-icon> Add CTA</button></div>`;
    html += `<table><thead><tr><th>Icon</th><th>Tab</th><th>CTA Text</th><th>Segment</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    filtered.forEach(c => {
      const statusBadge = c.is_active ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-inactive">Inactive</span>';
      html += `<tr>
        <td><ion-icon name="${esc(c.icon || 'megaphone-outline')}" style="font-size:20px;color:${esc(c.icon_color || 'var(--teal)')}"></ion-icon></td>
        <td><span class="badge" style="background:rgba(13,148,136,0.15);color:var(--teal-light)">${esc(c.tab_label || c.tab_key)}</span></td>
        <td><strong>${esc(c.cta_text)}</strong></td>
        <td>${c.segment_name ? '<span class="badge badge-adviser">' + esc(c.segment_name) + '</span>' : '<span style="font-size:12px;color:var(--text-muted)">All</span>'}</td>
        <td>${statusBadge}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="showCTAModal(${c.id})" style="margin-right:4px"><ion-icon name="create-outline"></ion-icon></button>
          <button class="btn btn-danger btn-sm" onclick="deleteCTA(${c.id})"><ion-icon name="trash-outline"></ion-icon></button>
        </td>
      </tr>`;
    });
    if (filtered.length === 0) html += '<tr><td colspan="6" class="empty-state">No CTAs found</td></tr>';
    html += '</tbody></table></div>';
    $('ctas-content').innerHTML = html;
  } catch (e) {
    $('ctas-content').innerHTML = '<div class="empty-state">Failed to load CTAs</div>';
  }
}

function showCTAModal(editId) {
  const c = editId ? (cache.ctas || []).find(x => x.id === editId) : null;
  const segments = cache.segments || [];
  let segOpts = '<option value="">All Users</option>';
  segments.forEach(s => segOpts += `<option value="${s.id}" ${c && c.segment_id == s.id ? 'selected' : ''}>${esc(s.name)}</option>`);

  const tabOptions = ['mortgage','super','insurance','savings','rewards','banks','budget','planning','fact_find','investor','overview'].map(t =>
    `<option value="${t}" ${c?.tab_key === t ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1).replace('_',' ')}</option>`
  ).join('');

  showModal(`
    <h2>${c ? 'Edit CTA' : 'Add New CTA'}</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Tab</label><select id="m-cta-tab" onchange="var l=$('m-cta-label');if(!l.value||l.dataset.auto)l.value=this.options[this.selectedIndex].text,l.dataset.auto='1'">${tabOptions}</select></div>
      <div class="form-group"><label>Tab Label</label><input id="m-cta-label" value="${esc(c?.tab_label || '')}" ${!c ? 'data-auto="1"' : ''}></div>
    </div>
    <div class="form-group"><label>CTA Text</label><input id="m-cta-text" value="${esc(c?.cta_text || '')}" placeholder="e.g. Get a free rate review"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="form-group"><label>Icon (Ionicons)</label><input id="m-cta-icon" value="${esc(c?.icon || 'megaphone-outline')}" placeholder="e.g. home-outline"></div>
      <div class="form-group"><label>Icon Color</label><input id="m-cta-color" type="color" value="${c?.icon_color || '#0D9488'}" style="height:40px"></div>
    </div>
    <div class="form-group"><label>Segment</label><select id="m-cta-seg">${segOpts}</select></div>
    ${c ? `<div class="form-group"><label>Status</label><select id="m-cta-active"><option value="true" ${c.is_active ? 'selected' : ''}>Active</option><option value="false" ${!c.is_active ? 'selected' : ''}>Inactive</option></select></div>` : ''}
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCTA(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveCTA(editId) {
  const data = {
    cta_text: $('m-cta-text').value,
    icon: $('m-cta-icon').value,
    icon_color: $('m-cta-color').value,
    segment_id: $('m-cta-seg').value || null,
  };
  if (!editId) {
    data.tab_key = $('m-cta-tab').value;
    data.tab_label = $('m-cta-label').value;
  }
  if (editId) data.is_active = $('m-cta-active').value === 'true';
  try {
    if (editId) await api('/ctas/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/ctas', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    toast(editId ? 'CTA updated' : 'CTA created');
    renderCTAs();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

async function deleteCTA(id) {
  if (!confirm('Delete this CTA?')) return;
  try {
    await api('/ctas/' + id, { method: 'DELETE' });
    toast('CTA deleted');
    renderCTAs();
  } catch (e) { toast('Failed: ' + e.message, 'error'); }
}

if (token) {
  const savedUser = localStorage.getItem('adviser_user');
  if (savedUser) { try { currentUser = JSON.parse(savedUser); } catch {} }
  showApp();
}
</script>
</body>
</html>