<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Good Money - Admin Control Panel</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:#f0f2f5;color:#1a1a2e;min-height:100vh}
:root{--teal:#0d9488;--teal-dark:#0f766e;--navy:#1a1a2e;--gold:#f59e0b;--red:#ef4444;--green:#10b981;--blue:#3b82f6;--purple:#8b5cf6;--pink:#ec4899;--gray100:#f3f4f6;--gray200:#e5e7eb;--gray400:#9ca3af;--gray600:#4b5563;--border:#e2e8f0;--card:#fff;--shadow:0 1px 3px rgba(0,0,0,0.1)}

.login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0d9488 0%,#1a1a2e 100%)}
.login-card{background:#fff;border-radius:20px;padding:40px;width:400px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.login-card h1{font-size:24px;text-align:center;margin-bottom:8px;color:var(--navy)}
.login-card p{text-align:center;color:var(--gray600);margin-bottom:28px;font-size:14px}
.login-card .logo-row{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:20px}
.login-card .logo-icon{width:48px;height:48px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#7c5800;border:3px solid #d4930d}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-weight:600;font-size:13px;color:var(--gray600);margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:10px;font-size:14px;font-family:inherit;outline:none;transition:border .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--teal)}
.form-group textarea{resize:vertical;min-height:60px}
.btn{padding:10px 20px;border:none;border-radius:10px;font-family:inherit;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--teal);color:#fff}.btn-primary:hover{background:var(--teal-dark)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:#dc2626}
.btn-secondary{background:var(--gray200);color:var(--gray600)}.btn-secondary:hover{background:var(--gray400);color:#fff}
.btn-gold{background:var(--gold);color:#7c5800}.btn-gold:hover{background:#d4930d}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:8px}
.btn-full{width:100%;justify-content:center;padding:12px}
.login-error{color:var(--red);font-size:13px;text-align:center;margin-top:10px;display:none}

.app{display:flex;min-height:100vh}
.sidebar{width:240px;background:var(--navy);color:#fff;padding:20px 0;flex-shrink:0;position:fixed;height:100vh;overflow-y:auto;z-index:100}
.sidebar .logo-area{padding:0 20px 20px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:8px;display:flex;align-items:center;gap:10px}
.sidebar .logo-area .coin{width:36px;height:36px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;color:#7c5800;border:2px solid #d4930d}
.sidebar .logo-area h2{font-size:16px;font-weight:700}
.sidebar .logo-area span{font-size:11px;color:var(--gray400);display:block}
.nav-item{padding:10px 20px;cursor:pointer;font-size:14px;font-weight:500;color:rgba(255,255,255,0.7);transition:all .15s;display:flex;align-items:center;gap:10px;border-left:3px solid transparent}
.nav-item:hover{background:rgba(255,255,255,0.05);color:#fff}
.nav-item.active{background:rgba(13,148,136,0.2);color:var(--teal);border-left-color:var(--teal)}
.nav-item .nav-icon{width:20px;text-align:center;font-size:16px}
.nav-divider{height:1px;background:rgba(255,255,255,0.1);margin:8px 20px}
.sidebar .user-area{position:absolute;bottom:0;left:0;right:0;padding:16px 20px;border-top:1px solid rgba(255,255,255,0.1);background:rgba(0,0,0,0.2)}
.sidebar .user-area .user-name{font-size:13px;font-weight:600}
.sidebar .user-area .user-role{font-size:11px;color:var(--gold);text-transform:uppercase}
.sidebar .user-area .logout-btn{font-size:12px;color:var(--gray400);cursor:pointer;margin-top:6px;background:none;border:none;font-family:inherit}
.sidebar .user-area .logout-btn:hover{color:var(--red)}

.main{margin-left:240px;flex:1;padding:28px;min-height:100vh}
.page-header{margin-bottom:24px}
.page-header h1{font-size:24px;font-weight:700;color:var(--navy)}
.page-header p{font-size:14px;color:var(--gray600);margin-top:4px}

.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border-radius:14px;padding:20px;box-shadow:var(--shadow);border:1px solid var(--border)}
.stat-card .stat-label{font-size:12px;font-weight:600;color:var(--gray400);text-transform:uppercase;letter-spacing:.5px}
.stat-card .stat-val{font-size:28px;font-weight:700;margin-top:4px}
.stat-card .stat-sub{font-size:12px;color:var(--gray600);margin-top:2px}
.stat-card.teal .stat-val{color:var(--teal)}
.stat-card.gold .stat-val{color:var(--gold)}
.stat-card.blue .stat-val{color:var(--blue)}
.stat-card.green .stat-val{color:var(--green)}
.stat-card.purple .stat-val{color:var(--purple)}

.card{background:var(--card);border-radius:14px;padding:20px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:20px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.card-header h3{font-size:16px;font-weight:700}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 12px;font-size:12px;font-weight:600;color:var(--gray400);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border)}
td{padding:10px 12px;font-size:13px;border-bottom:1px solid var(--gray100)}
tr:hover td{background:var(--gray100)}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-active{background:#d1fae5;color:#065f46}
.badge-inactive{background:#fee2e2;color:#991b1b}
.badge-god{background:#fef3c7;color:#92400e}
.badge-admin{background:#dbeafe;color:#1e40af}

.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;display:none}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:16px;padding:28px;width:520px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.modal h2{font-size:18px;font-weight:700;margin-bottom:20px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

.color-dot{width:14px;height:14px;border-radius:50%;display:inline-block;vertical-align:middle;margin-right:6px}
.icon-preview{font-size:18px;margin-right:6px}
.tab-bar{display:flex;gap:4px;margin-bottom:20px;background:var(--gray100);border-radius:10px;padding:4px}
.tab-btn{padding:8px 16px;border:none;background:none;font-family:inherit;font-weight:600;font-size:13px;color:var(--gray600);cursor:pointer;border-radius:8px;transition:all .15s;flex:1;text-align:center}
.tab-btn.active{background:#fff;color:var(--teal);box-shadow:0 1px 3px rgba(0,0,0,0.1)}

.search-bar{display:flex;gap:10px;margin-bottom:16px}
.search-bar input{flex:1;padding:8px 14px;border:1px solid var(--border);border-radius:10px;font-size:13px;font-family:inherit;outline:none}
.search-bar input:focus{border-color:var(--teal)}

.empty-state{text-align:center;padding:40px;color:var(--gray400);font-size:14px}

.advisor-card{background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:12px;cursor:pointer;transition:border-color .15s}
.advisor-card:hover{border-color:var(--teal)}
.advisor-card .advisor-row{display:flex;align-items:center;gap:14px}
.advisor-card .advisor-avatar{width:44px;height:44px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:#fff}
.advisor-card .advisor-info h4{font-size:15px;font-weight:600}
.advisor-card .advisor-info p{font-size:12px;color:var(--gray600)}
.advisor-card .advisor-stats{display:flex;gap:20px;margin-top:10px;padding-top:10px;border-top:1px solid var(--gray100)}
.advisor-card .advisor-stat{font-size:12px;color:var(--gray600)}
.advisor-card .advisor-stat strong{color:var(--navy);display:block;font-size:16px}

.progress-bar{height:8px;background:var(--gray200);border-radius:4px;overflow:hidden}
.progress-bar .fill{height:100%;border-radius:4px;background:var(--teal);transition:width .3s}

.hidden{display:none!important}

@media(max-width:768px){
  .sidebar{width:60px}
  .sidebar .logo-area h2,.sidebar .logo-area span,.nav-item span,.sidebar .user-area .user-name,.sidebar .user-area .user-role{display:none}
  .sidebar .logo-area{justify-content:center}
  .nav-item{justify-content:center;padding:12px}
  .main{margin-left:60px;padding:16px}
  .stat-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<div id="login-page" class="login-wrap">
  <div class="login-card">
    <div class="logo-row"><div class="logo-icon">$</div></div>
    <h1>Good Money Admin</h1>
    <p>Back Office Control Panel</p>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="login-email" value="admin@goodmoney.com.au" placeholder="admin@goodmoney.com.au">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-password" value="admin123" placeholder="Enter password">
    </div>
    <button class="btn btn-primary btn-full" onclick="doLogin()">Sign In</button>
    <div id="login-error" class="login-error"></div>
  </div>
</div>

<div id="app-page" class="app hidden">
  <div class="sidebar">
    <div class="logo-area">
      <div class="coin">$</div>
      <div><h2>Good Money</h2><span>Admin Panel</span></div>
    </div>
    <div class="nav-item active" data-page="dashboard" onclick="navigate('dashboard')">
      <span class="nav-icon">&#9632;</span><span>Dashboard</span>
    </div>
    <div class="nav-item" data-page="quests" onclick="navigate('quests')">
      <span class="nav-icon">&#9733;</span><span>Quests & Missions</span>
    </div>
    <div class="nav-item" data-page="badges" onclick="navigate('badges')">
      <span class="nav-icon">&#9813;</span><span>Badges</span>
    </div>
    <div class="nav-item" data-page="rewards" onclick="navigate('rewards')">
      <span class="nav-icon">&#127873;</span><span>Rewards Store</span>
    </div>
    <div class="nav-item" data-page="settings" onclick="navigate('settings')">
      <span class="nav-icon">&#9881;</span><span>Game Settings</span>
    </div>
    <div class="nav-item" data-page="ctas" onclick="navigate('ctas')">
      <span class="nav-icon">&#128227;</span><span>Sales CTAs</span>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-item" data-page="advisors" onclick="navigate('advisors')">
      <span class="nav-icon">&#128100;</span><span>Advisors</span>
    </div>
    <div class="nav-item" data-page="customers" onclick="navigate('customers')">
      <span class="nav-icon">&#128101;</span><span>Customers</span>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-item" data-page="analytics" onclick="navigate('analytics')">
      <span class="nav-icon">&#128200;</span><span>Analytics</span>
    </div>
    <div class="user-area">
      <div class="user-name" id="sidebar-user-name"></div>
      <div class="user-role" id="sidebar-user-role"></div>
      <button class="logout-btn" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <div class="main" id="main-content"></div>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal-content"></div>
</div>

<script>
const API = '/api/admin';
let token = localStorage.getItem('admin_token');
let currentUser = null;
let currentPage = 'dashboard';
let cachedData = {};

async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['x-admin-token'] = token;
  const r = await fetch(API + path, { ...opts, headers });
  if (r.status === 401) { doLogout(); throw new Error('Unauthorized'); }
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || 'Request failed');
  return data;
}

async function doLogin() {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  try {
    errEl.style.display = 'none';
    const data = await fetch(API + '/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    }).then(r => r.json());
    if (data.error) { errEl.textContent = data.error; errEl.style.display = 'block'; return; }
    token = data.token;
    currentUser = data.user;
    localStorage.setItem('admin_token', token);
    showApp();
  } catch (e) {
    errEl.textContent = 'Login failed';
    errEl.style.display = 'block';
  }
}

function doLogout() {
  token = null;
  currentUser = null;
  localStorage.removeItem('admin_token');
  document.getElementById('login-page').classList.remove('hidden');
  document.getElementById('app-page').classList.add('hidden');
}

async function showApp() {
  document.getElementById('login-page').classList.add('hidden');
  document.getElementById('app-page').classList.remove('hidden');
  if (!currentUser) {
    try {
      const data = await api('/me');
      currentUser = data.user;
    } catch {
      doLogout();
      return;
    }
  }
  document.getElementById('sidebar-user-name').textContent = currentUser.name;
  document.getElementById('sidebar-user-role').textContent = currentUser.role === 'god' ? 'God Mode' : 'Admin';
  navigate('dashboard');
}

function navigate(page) {
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
  const renderers = { dashboard: renderDashboard, quests: renderQuests, badges: renderBadges, rewards: renderRewards, settings: renderSettings, ctas: renderCtas, advisors: renderAdvisors, customers: renderCustomers, analytics: renderAnalytics };
  if (renderers[page]) renderers[page]();
}

function showModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}

function hideModal() {
  document.getElementById('modal-overlay').classList.remove('show');
}

document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modal-overlay')) hideModal();
});

function setMain(html) {
  document.getElementById('main-content').innerHTML = html;
}

async function renderDashboard() {
  setMain('<div class="page-header"><h1>Dashboard</h1><p>Overview of your Good Money platform</p></div><div id="dash-content"><p>Loading...</p></div>');
  try {
    const data = await api('/analytics/overview');
    const o = data.overview;
    let html = `<div class="stat-grid">
      <div class="stat-card teal"><div class="stat-label">Total Customers</div><div class="stat-val">${o.total_customers}</div><div class="stat-sub">${o.active_7d} active this week</div></div>
      <div class="stat-card gold"><div class="stat-label">Points Issued</div><div class="stat-val">${Number(o.total_points_issued).toLocaleString()}</div><div class="stat-sub">${Number(o.total_tokens_issued).toLocaleString()} tokens earned</div></div>
      <div class="stat-card blue"><div class="stat-label">Avg Level</div><div class="stat-val">${Number(o.avg_level).toFixed(1)}</div><div class="stat-sub">Avg streak: ${Number(o.avg_streak).toFixed(1)} days</div></div>
      <div class="stat-card green"><div class="stat-label">Avg Fact Find</div><div class="stat-val">${Number(o.avg_fact_find).toFixed(0)}%</div><div class="stat-sub">${data.unassigned_customers} unassigned</div></div>
    </div>`;

    if (data.by_advisor.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Performance by Advisor</h3></div><table><thead><tr><th>Advisor</th><th>Customers</th><th>Active (7d)</th><th>Avg Fact Find</th><th>Total Points</th><th>Avg Level</th><th>Status</th></tr></thead><tbody>`;
      data.by_advisor.forEach(a => {
        html += `<tr style="cursor:pointer" onclick="viewAdvisorReport(${a.id})">
          <td><strong>${a.name}</strong><br><small style="color:var(--gray400)">${a.email}</small></td>
          <td>${a.customer_count}</td><td>${a.active_7d}</td>
          <td><div class="progress-bar" style="width:80px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${Number(a.avg_fact_find).toFixed(0)}%"></div></div> ${Number(a.avg_fact_find).toFixed(0)}%</td>
          <td>${Number(a.total_points).toLocaleString()}</td>
          <td>${Number(a.avg_level).toFixed(1)}</td>
          <td><span class="badge ${a.status === 'active' ? 'badge-active' : 'badge-inactive'}">${a.status}</span></td>
        </tr>`;
      });
      html += '</tbody></table></div>';
    }

    if (data.recent_activity.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Recent Activity</h3></div><table><thead><tr><th>Customer</th><th>Action</th><th>Points</th><th>Time</th></tr></thead><tbody>`;
      data.recent_activity.forEach(a => {
        html += `<tr><td>${a.customer_name || 'Unknown'}</td><td>${a.action}</td><td>${a.points_earned > 0 ? '+' + a.points_earned : '-'}</td><td>${new Date(a.created_at).toLocaleString()}</td></tr>`;
      });
      html += '</tbody></table></div>';
    }

    document.getElementById('dash-content').innerHTML = html;
  } catch (e) {
    document.getElementById('dash-content').innerHTML = '<p>Failed to load dashboard data</p>';
  }
}

async function renderQuests() {
  setMain('<div class="page-header"><h1>Quests & Missions</h1><p>Configure quest challenges and mission objectives</p></div><div id="quest-content"><p>Loading...</p></div>');
  try {
    const quests = await api('/quests');
    cachedData.quests = quests;
    let html = `<div class="card"><div class="card-header"><h3>All Quests (${quests.length})</h3><button class="btn btn-primary btn-sm" onclick="showQuestModal()">+ Add Quest</button></div>
    <table><thead><tr><th>Quest</th><th>Points</th><th>2x Active</th><th>Category</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    quests.forEach(q => {
      html += `<tr>
        <td><span class="color-dot" style="background:${q.icon_bg}"></span><strong>${q.title}</strong><br><small style="color:var(--gray400)">${q.description || ''}</small></td>
        <td><strong>${q.base_points}</strong></td>
        <td>${q.is_2x_active ? '<span class="badge badge-active">Yes</span>' : '<span class="badge badge-inactive">No</span>'}</td>
        <td>${q.category || 'mission'}</td>
        <td><span class="badge ${q.is_active ? 'badge-active' : 'badge-inactive'}">${q.is_active ? 'Active' : 'Inactive'}</span></td>
        <td><button class="btn btn-secondary btn-sm" onclick="showQuestModal(${q.id})">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteQuest(${q.id})">Delete</button></td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    document.getElementById('quest-content').innerHTML = html;
  } catch (e) {
    document.getElementById('quest-content').innerHTML = '<p>Failed to load quests</p>';
  }
}

function showQuestModal(editId) {
  const q = editId ? cachedData.quests.find(x => x.id === editId) : null;
  showModal(`
    <h2>${q ? 'Edit Quest' : 'Add New Quest'}</h2>
    <div class="form-group"><label>Quest ID</label><input id="m-quest-id" value="${q?.quest_id || ''}" ${q ? 'disabled' : ''} placeholder="e.g. review_insurance"></div>
    <div class="form-group"><label>Title</label><input id="m-quest-title" value="${q?.title || ''}" placeholder="Quest title"></div>
    <div class="form-group"><label>Description</label><textarea id="m-quest-desc">${q?.description || ''}</textarea></div>
    <div class="form-group"><label>Icon (Ionicon name)</label><input id="m-quest-icon" value="${q?.icon || ''}" placeholder="e.g. shield-checkmark-outline"></div>
    <div class="form-group"><label>Icon Background Color</label><input id="m-quest-bg" type="color" value="${q?.icon_bg || '#3B82F6'}"></div>
    <div class="form-group"><label>Base Points</label><input id="m-quest-pts" type="number" value="${q?.base_points || 100}"></div>
    <div class="form-group"><label>Category</label><select id="m-quest-cat"><option ${q?.category==='mission'?'selected':''}>mission</option><option ${q?.category==='daily'?'selected':''}>daily</option><option ${q?.category==='weekly'?'selected':''}>weekly</option><option ${q?.category==='special'?'selected':''}>special</option></select></div>
    <div class="form-group"><label><input type="checkbox" id="m-quest-2x" ${q?.is_2x_active?'checked':''}> 2x Active Multiplier</label></div>
    <div class="form-group"><label><input type="checkbox" id="m-quest-active" ${q?.is_active !== false?'checked':''}> Active</label></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveQuest(${editId || 'null'})">Save Quest</button>
    </div>
  `);
}

async function saveQuest(editId) {
  const data = {
    quest_id: document.getElementById('m-quest-id').value,
    title: document.getElementById('m-quest-title').value,
    description: document.getElementById('m-quest-desc').value,
    icon: document.getElementById('m-quest-icon').value,
    icon_bg: document.getElementById('m-quest-bg').value,
    base_points: parseInt(document.getElementById('m-quest-pts').value),
    category: document.getElementById('m-quest-cat').value,
    is_2x_active: document.getElementById('m-quest-2x').checked,
    is_active: document.getElementById('m-quest-active').checked,
    sort_order: editId ? cachedData.quests.find(x => x.id === editId)?.sort_order || 0 : 0,
  };
  try {
    if (editId) await api('/quests/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/quests', { method: 'POST', body: JSON.stringify(data) });
    hideModal();
    renderQuests();
  } catch (e) { alert('Save failed: ' + e.message); }
}

async function deleteQuest(id) {
  if (!confirm('Delete this quest?')) return;
  try { await api('/quests/' + id, { method: 'DELETE' }); renderQuests(); } catch (e) { alert('Delete failed'); }
}

async function renderBadges() {
  setMain('<div class="page-header"><h1>Badges</h1><p>Configure achievement badges</p></div><div id="badge-content"><p>Loading...</p></div>');
  try {
    const badges = await api('/badges');
    cachedData.badges = badges;
    let html = `<div class="card"><div class="card-header"><h3>All Badges (${badges.length})</h3><button class="btn btn-primary btn-sm" onclick="showBadgeModal()">+ Add Badge</button></div>
    <table><thead><tr><th>Badge</th><th>Criteria</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    badges.forEach(b => {
      html += `<tr>
        <td><span class="color-dot" style="background:${b.color}"></span><strong>${b.title}</strong><br><small style="color:var(--gray400)">${b.description || ''}</small></td>
        <td>${b.criteria || '-'}</td>
        <td><span class="badge ${b.is_active ? 'badge-active' : 'badge-inactive'}">${b.is_active ? 'Active' : 'Inactive'}</span></td>
        <td><button class="btn btn-secondary btn-sm" onclick="showBadgeModal(${b.id})">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteBadge(${b.id})">Delete</button></td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    document.getElementById('badge-content').innerHTML = html;
  } catch (e) {
    document.getElementById('badge-content').innerHTML = '<p>Failed to load badges</p>';
  }
}

function showBadgeModal(editId) {
  const b = editId ? cachedData.badges.find(x => x.id === editId) : null;
  showModal(`
    <h2>${b ? 'Edit Badge' : 'Add New Badge'}</h2>
    <div class="form-group"><label>Badge ID</label><input id="m-badge-id" value="${b?.badge_id || ''}" ${b ? 'disabled' : ''}></div>
    <div class="form-group"><label>Title</label><input id="m-badge-title" value="${b?.title || ''}"></div>
    <div class="form-group"><label>Description</label><textarea id="m-badge-desc">${b?.description || ''}</textarea></div>
    <div class="form-group"><label>Icon</label><input id="m-badge-icon" value="${b?.icon || ''}"></div>
    <div class="form-group"><label>Color</label><input id="m-badge-color" type="color" value="${b?.color || '#10B981'}"></div>
    <div class="form-group"><label>Unlock Criteria</label><input id="m-badge-criteria" value="${b?.criteria || ''}" placeholder="e.g. streak_7, points_1000"></div>
    <div class="form-group"><label><input type="checkbox" id="m-badge-active" ${b?.is_active !== false?'checked':''}> Active</label></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveBadge(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveBadge(editId) {
  const data = {
    badge_id: document.getElementById('m-badge-id').value,
    title: document.getElementById('m-badge-title').value,
    description: document.getElementById('m-badge-desc').value,
    icon: document.getElementById('m-badge-icon').value,
    color: document.getElementById('m-badge-color').value,
    criteria: document.getElementById('m-badge-criteria').value,
    is_active: document.getElementById('m-badge-active').checked,
    sort_order: editId ? cachedData.badges.find(x => x.id === editId)?.sort_order || 0 : 0,
  };
  try {
    if (editId) await api('/badges/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/badges', { method: 'POST', body: JSON.stringify(data) });
    hideModal(); renderBadges();
  } catch (e) { alert('Save failed: ' + e.message); }
}

async function deleteBadge(id) {
  if (!confirm('Delete this badge?')) return;
  try { await api('/badges/' + id, { method: 'DELETE' }); renderBadges(); } catch (e) { alert('Delete failed'); }
}

async function renderRewards() {
  setMain('<div class="page-header"><h1>Rewards Store</h1><p>Configure redeemable rewards</p></div><div id="reward-content"><p>Loading...</p></div>');
  try {
    const rewards = await api('/rewards');
    cachedData.rewards = rewards;
    let html = `<div class="card"><div class="card-header"><h3>All Rewards (${rewards.length})</h3><button class="btn btn-primary btn-sm" onclick="showRewardModal()">+ Add Reward</button></div>
    <table><thead><tr><th>Reward</th><th>Points Cost</th><th>Stock</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    rewards.forEach(r => {
      html += `<tr>
        <td><strong>${r.title}</strong><br><small style="color:var(--gray400)">${r.description || ''}</small></td>
        <td><strong>${r.points_cost.toLocaleString()}</strong> pts</td>
        <td>${r.stock === -1 ? 'Unlimited' : r.stock}</td>
        <td><span class="badge ${r.is_active ? 'badge-active' : 'badge-inactive'}">${r.is_active ? 'Active' : 'Inactive'}</span></td>
        <td><button class="btn btn-secondary btn-sm" onclick="showRewardModal(${r.id})">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteReward(${r.id})">Delete</button></td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    document.getElementById('reward-content').innerHTML = html;
  } catch (e) {
    document.getElementById('reward-content').innerHTML = '<p>Failed to load rewards</p>';
  }
}

function showRewardModal(editId) {
  const r = editId ? cachedData.rewards.find(x => x.id === editId) : null;
  showModal(`
    <h2>${r ? 'Edit Reward' : 'Add New Reward'}</h2>
    <div class="form-group"><label>Reward ID</label><input id="m-reward-id" value="${r?.reward_id || ''}" ${r ? 'disabled' : ''}></div>
    <div class="form-group"><label>Title</label><input id="m-reward-title" value="${r?.title || ''}"></div>
    <div class="form-group"><label>Description</label><textarea id="m-reward-desc">${r?.description || ''}</textarea></div>
    <div class="form-group"><label>Icon</label><input id="m-reward-icon" value="${r?.icon || ''}"></div>
    <div class="form-group"><label>Points Cost</label><input id="m-reward-cost" type="number" value="${r?.points_cost || 1000}"></div>
    <div class="form-group"><label>Stock (-1 = unlimited)</label><input id="m-reward-stock" type="number" value="${r?.stock ?? -1}"></div>
    <div class="form-group"><label><input type="checkbox" id="m-reward-active" ${r?.is_active !== false?'checked':''}> Active</label></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveReward(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveReward(editId) {
  const data = {
    reward_id: document.getElementById('m-reward-id').value,
    title: document.getElementById('m-reward-title').value,
    description: document.getElementById('m-reward-desc').value,
    icon: document.getElementById('m-reward-icon').value,
    points_cost: parseInt(document.getElementById('m-reward-cost').value),
    stock: parseInt(document.getElementById('m-reward-stock').value),
    is_active: document.getElementById('m-reward-active').checked,
    sort_order: editId ? cachedData.rewards.find(x => x.id === editId)?.sort_order || 0 : 0,
  };
  try {
    if (editId) await api('/rewards/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/rewards', { method: 'POST', body: JSON.stringify(data) });
    hideModal(); renderRewards();
  } catch (e) { alert('Save failed: ' + e.message); }
}

async function deleteReward(id) {
  if (!confirm('Delete this reward?')) return;
  try { await api('/rewards/' + id, { method: 'DELETE' }); renderRewards(); } catch (e) { alert('Delete failed'); }
}

async function renderSettings() {
  setMain('<div class="page-header"><h1>Gamification Settings</h1><p>Configure global game parameters</p></div><div id="settings-content"><p>Loading...</p></div>');
  try {
    const settings = await api('/settings');
    cachedData.settings = settings;
    let html = '<div class="card"><div class="card-header"><h3>Global Settings</h3></div><table><thead><tr><th>Setting</th><th>Value</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
    settings.forEach(s => {
      html += `<tr>
        <td><strong>${s.setting_key}</strong></td>
        <td><input id="setting-${s.setting_key}" value="${s.setting_value}" style="width:100px;padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-family:inherit"></td>
        <td><small style="color:var(--gray600)">${s.description || ''}</small></td>
        <td><button class="btn btn-primary btn-sm" onclick="saveSetting('${s.setting_key}')">Save</button></td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    document.getElementById('settings-content').innerHTML = html;
  } catch (e) {
    document.getElementById('settings-content').innerHTML = '<p>Failed to load settings</p>';
  }
}

async function saveSetting(key) {
  const value = document.getElementById('setting-' + key).value;
  try {
    await api('/settings/' + key, { method: 'PUT', body: JSON.stringify({ value }) });
    alert('Setting saved');
  } catch (e) { alert('Save failed'); }
}

async function renderCtas() {
  setMain('<div class="page-header"><h1>Sales CTAs</h1><p>Edit the call-to-action messages shown on each tab in the app summary</p></div><div id="cta-content"><p>Loading...</p></div>');
  try {
    const ctas = await api('/ctas');
    cachedData.ctas = ctas;
    let html = `<div class="card"><div class="card-header"><h3>Tab CTAs (${ctas.length})</h3></div>
    <table><thead><tr><th>Tab</th><th>CTA Text</th><th>Icon</th><th>Color</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    ctas.forEach(c => {
      html += `<tr>
        <td><strong>${c.tab_label}</strong><br><small style="color:var(--gray400)">${c.tab_key}</small></td>
        <td style="max-width:300px"><input id="cta-text-${c.id}" value="${c.cta_text}" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px"></td>
        <td><input id="cta-icon-${c.id}" value="${c.icon || ''}" style="width:120px;padding:6px 10px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:12px" placeholder="icon-name"></td>
        <td><input id="cta-color-${c.id}" type="color" value="${c.icon_color || '#0d9488'}" style="width:40px;height:32px;border:none;cursor:pointer"></td>
        <td><label style="cursor:pointer"><input type="checkbox" id="cta-active-${c.id}" ${c.is_active ? 'checked' : ''} onchange="saveCta(${c.id})"> Active</label></td>
        <td><button class="btn btn-primary btn-sm" onclick="saveCta(${c.id})">Save</button></td>
      </tr>`;
    });
    html += '</tbody></table></div>';
    html += `<div class="card" style="background:linear-gradient(135deg,#0d9488 0%,#1a1a2e 100%);color:#fff;border:none"><div class="card-header"><h3 style="color:#fff">&#128161; CTA Tips</h3></div>
      <ul style="font-size:13px;line-height:2;padding-left:18px;color:rgba(255,255,255,0.8)">
        <li>Keep CTAs short and action-oriented (under 40 characters)</li>
        <li>Use verbs like "Get", "Compare", "Boost", "Link", "Complete"</li>
        <li>Highlight the benefit to the customer, not the feature</li>
        <li>Toggle inactive to hide a CTA without deleting it</li>
        <li>Icons use Ionicons names (e.g. home-outline, wallet-outline)</li>
      </ul></div>`;
    document.getElementById('cta-content').innerHTML = html;
  } catch (e) {
    document.getElementById('cta-content').innerHTML = '<p>Failed to load CTAs</p>';
  }
}

async function saveCta(id) {
  const cta_text = document.getElementById('cta-text-' + id).value;
  const icon = document.getElementById('cta-icon-' + id).value;
  const icon_color = document.getElementById('cta-color-' + id).value;
  const is_active = document.getElementById('cta-active-' + id).checked;
  try {
    await api('/ctas/' + id, { method: 'PUT', body: JSON.stringify({ cta_text, icon, icon_color, is_active }) });
    const row = document.getElementById('cta-text-' + id).closest('tr');
    row.style.transition = 'background .3s';
    row.style.background = '#d1fae5';
    setTimeout(() => { row.style.background = ''; }, 800);
  } catch (e) { alert('Save failed: ' + e.message); }
}

async function renderAdvisors() {
  setMain('<div class="page-header"><h1>Advisor Management</h1><p>Manage financial advisors and their client assignments</p></div><div id="advisor-content"><p>Loading...</p></div>');
  try {
    const advisors = await api('/advisors');
    cachedData.advisors = advisors;
    let html = `<div style="display:flex;justify-content:flex-end;margin-bottom:16px"><button class="btn btn-primary" onclick="showAdvisorModal()">+ Add Advisor</button></div>`;
    if (advisors.length === 0) {
      html += '<div class="empty-state">No advisors yet. Add your first advisor to start assigning customers.</div>';
    } else {
      advisors.forEach(a => {
        html += `<div class="advisor-card" onclick="viewAdvisorReport(${a.id})">
          <div class="advisor-row">
            <div class="advisor-avatar">${(a.name||'?')[0].toUpperCase()}</div>
            <div class="advisor-info">
              <h4>${a.name} <span class="badge ${a.status === 'active' ? 'badge-active' : 'badge-inactive'}" style="margin-left:8px">${a.status}</span></h4>
              <p>${a.email} ${a.phone ? '| ' + a.phone : ''} ${a.license_number ? '| License: ' + a.license_number : ''}</p>
            </div>
          </div>
          <div class="advisor-stats">
            <div class="advisor-stat"><strong>${a.customer_count}</strong>Clients</div>
            <div class="advisor-stat"><strong>${Number(a.total_customer_points).toLocaleString()}</strong>Total Points</div>
            <div class="advisor-stat"><strong>${Number(a.avg_fact_find_progress).toFixed(0)}%</strong>Avg Fact Find</div>
          </div>
        </div>`;
      });
    }
    document.getElementById('advisor-content').innerHTML = html;
  } catch (e) {
    document.getElementById('advisor-content').innerHTML = '<p>Failed to load advisors</p>';
  }
}

function showAdvisorModal(editId) {
  const a = editId ? cachedData.advisors.find(x => x.id === editId) : null;
  showModal(`
    <h2>${a ? 'Edit Advisor' : 'Add New Advisor'}</h2>
    <div class="form-group"><label>Full Name</label><input id="m-adv-name" value="${a?.name || ''}"></div>
    <div class="form-group"><label>Email</label><input id="m-adv-email" type="email" value="${a?.email || ''}"></div>
    <div class="form-group"><label>Phone</label><input id="m-adv-phone" value="${a?.phone || ''}"></div>
    <div class="form-group"><label>License Number (AFSL)</label><input id="m-adv-license" value="${a?.license_number || ''}"></div>
    <div class="form-group"><label>Specialization</label><input id="m-adv-spec" value="${a?.specialization || ''}" placeholder="e.g. Retirement Planning, Insurance"></div>
    <div class="form-group"><label>Status</label><select id="m-adv-status"><option ${a?.status==='active'?'selected':''}>active</option><option ${a?.status==='inactive'?'selected':''}>inactive</option></select></div>
    <div class="form-group"><label>Notes</label><textarea id="m-adv-notes">${a?.notes || ''}</textarea></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      ${a ? `<button class="btn btn-danger" onclick="deleteAdvisor(${editId})">Delete</button>` : ''}
      <button class="btn btn-primary" onclick="saveAdvisor(${editId || 'null'})">Save</button>
    </div>
  `);
}

async function saveAdvisor(editId) {
  const data = {
    name: document.getElementById('m-adv-name').value,
    email: document.getElementById('m-adv-email').value,
    phone: document.getElementById('m-adv-phone').value,
    license_number: document.getElementById('m-adv-license').value,
    specialization: document.getElementById('m-adv-spec').value,
    status: document.getElementById('m-adv-status').value,
    notes: document.getElementById('m-adv-notes').value,
  };
  try {
    if (editId) await api('/advisors/' + editId, { method: 'PUT', body: JSON.stringify(data) });
    else await api('/advisors', { method: 'POST', body: JSON.stringify(data) });
    hideModal(); renderAdvisors();
  } catch (e) { alert('Save failed: ' + e.message); }
}

async function deleteAdvisor(id) {
  if (!confirm('Delete this advisor? Their customers will be unassigned.')) return;
  try { await api('/advisors/' + id, { method: 'DELETE' }); hideModal(); renderAdvisors(); } catch (e) { alert('Delete failed'); }
}

async function renderCustomers() {
  setMain('<div class="page-header"><h1>Customer Data</h1><p>View and manage customer accounts</p></div><div class="search-bar"><input id="cust-search" placeholder="Search customers..." oninput="filterCustomers()"><select id="cust-advisor-filter" onchange="loadCustomers()" style="width:200px;padding:8px;border:1px solid var(--border);border-radius:10px;font-family:inherit"><option value="">All Advisors</option></select></div><div id="customer-content"><p>Loading...</p></div>');
  try {
    const advisors = await api('/advisors');
    const sel = document.getElementById('cust-advisor-filter');
    advisors.forEach(a => {
      const opt = document.createElement('option');
      opt.value = a.id;
      opt.textContent = a.name;
      sel.appendChild(opt);
    });
    const unOpt = document.createElement('option');
    unOpt.value = 'unassigned';
    unOpt.textContent = '-- Unassigned --';
    sel.appendChild(unOpt);
    cachedData.advisorsList = advisors;
    await loadCustomers();
  } catch (e) {
    document.getElementById('customer-content').innerHTML = '<p>Failed to load</p>';
  }
}

async function loadCustomers() {
  const advisorId = document.getElementById('cust-advisor-filter').value;
  let url = '/customers';
  if (advisorId && advisorId !== 'unassigned') url += '?advisor_id=' + advisorId;
  try {
    let customers = await api(url);
    if (advisorId === 'unassigned') customers = customers.filter(c => !c.advisor_id);
    cachedData.customers = customers;
    renderCustomerTable(customers);
  } catch (e) {
    document.getElementById('customer-content').innerHTML = '<p>Failed to load customers</p>';
  }
}

function renderCustomerTable(customers) {
  if (customers.length === 0) {
    document.getElementById('customer-content').innerHTML = '<div class="empty-state">No customers found. Customers will appear here when they sync their app data.</div>';
    return;
  }
  let html = `<div class="card"><table><thead><tr><th>Customer</th><th>Advisor</th><th>Level</th><th>Points</th><th>Streak</th><th>Fact Find</th><th>Last Active</th><th>Actions</th></tr></thead><tbody>`;
  customers.forEach(c => {
    html += `<tr>
      <td><strong>${c.name || 'Anonymous'}</strong><br><small style="color:var(--gray400)">${c.email || c.device_id?.substr(0,12) || '-'}</small></td>
      <td>${c.advisor_name || '<span style="color:var(--gray400)">Unassigned</span>'}</td>
      <td><strong>${c.level}</strong></td>
      <td>${Number(c.total_points_earned).toLocaleString()}</td>
      <td>${c.streak} days</td>
      <td><div class="progress-bar" style="width:60px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${c.fact_find_progress || 0}%"></div></div> ${c.fact_find_progress || 0}%</td>
      <td>${c.last_active ? new Date(c.last_active).toLocaleDateString() : '-'}</td>
      <td><button class="btn btn-secondary btn-sm" onclick="showCustomerDetail(${c.id})">View</button> <button class="btn btn-primary btn-sm" onclick="showAssignModal(${c.id})">Assign</button></td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  document.getElementById('customer-content').innerHTML = html;
}

function filterCustomers() {
  const q = document.getElementById('cust-search').value.toLowerCase();
  const filtered = (cachedData.customers || []).filter(c => {
    const name = (c.name || '').toLowerCase();
    const email = (c.email || '').toLowerCase();
    return name.includes(q) || email.includes(q);
  });
  renderCustomerTable(filtered);
}

function showAssignModal(custId) {
  const advisors = cachedData.advisorsList || [];
  const c = cachedData.customers.find(x => x.id === custId);
  let opts = '<option value="">-- Unassigned --</option>';
  advisors.forEach(a => {
    opts += `<option value="${a.id}" ${c?.advisor_id == a.id ? 'selected' : ''}>${a.name}</option>`;
  });
  showModal(`
    <h2>Assign Advisor</h2>
    <p style="margin-bottom:16px;color:var(--gray600)">Assign an advisor to <strong>${c?.name || 'this customer'}</strong></p>
    <div class="form-group"><label>Advisor</label><select id="m-assign-advisor">${opts}</select></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
      <button class="btn btn-primary" onclick="assignAdvisor(${custId})">Save Assignment</button>
    </div>
  `);
}

async function assignAdvisor(custId) {
  const advisorId = document.getElementById('m-assign-advisor').value || null;
  try {
    await api('/customers/' + custId, { method: 'PUT', body: JSON.stringify({ advisor_id: advisorId }) });
    hideModal();
    loadCustomers();
  } catch (e) { alert('Assignment failed'); }
}

async function showCustomerDetail(custId) {
  try {
    const c = await api('/customers/' + custId);
    let html = `<h2>Customer Detail</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
      <div><strong>Name:</strong> ${c.name || 'Anonymous'}</div>
      <div><strong>Email:</strong> ${c.email || '-'}</div>
      <div><strong>Phone:</strong> ${c.phone || '-'}</div>
      <div><strong>Advisor:</strong> ${c.advisor_name || 'Unassigned'}</div>
      <div><strong>Level:</strong> ${c.level} (${c.xp} XP)</div>
      <div><strong>Points:</strong> ${Number(c.points).toLocaleString()} current / ${Number(c.total_points_earned).toLocaleString()} total</div>
      <div><strong>Streak:</strong> ${c.streak} days</div>
      <div><strong>Tokens:</strong> $${Number(c.token_balance).toFixed(2)} (total: $${Number(c.total_tokens_earned).toFixed(2)})</div>
      <div><strong>Fact Find:</strong> ${c.fact_find_progress}%</div>
      <div><strong>Last Active:</strong> ${c.last_active ? new Date(c.last_active).toLocaleString() : 'Never'}</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
      <strong style="width:100%">Completed Missions:</strong>
      ${(c.completed_missions || []).map(m => `<span class="badge badge-active">${m}</span>`).join(' ') || '<span style="color:var(--gray400)">None</span>'}
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
      <strong style="width:100%">Unlocked Badges:</strong>
      ${(c.unlocked_badges || []).map(b => `<span class="badge badge-active">${b}</span>`).join(' ') || '<span style="color:var(--gray400)">None</span>'}
    </div>`;
    if (c.recent_activities && c.recent_activities.length > 0) {
      html += `<strong>Recent Activity:</strong><table style="margin-top:8px"><thead><tr><th>Action</th><th>Points</th><th>Time</th></tr></thead><tbody>`;
      c.recent_activities.forEach(a => {
        html += `<tr><td>${a.action}</td><td>${a.points_earned > 0 ? '+' + a.points_earned : '-'}</td><td>${new Date(a.created_at).toLocaleString()}</td></tr>`;
      });
      html += '</tbody></table>';
    }
    html += `<div class="modal-actions"><button class="btn btn-secondary" onclick="hideModal()">Close</button></div>`;
    showModal(html);
  } catch (e) { alert('Failed to load customer details'); }
}

async function renderAnalytics() {
  setMain('<div class="page-header"><h1>Analytics & Reporting</h1><p>God mode overview with per-advisor drill-down</p></div><div id="analytics-content"><p>Loading...</p></div>');
  try {
    const data = await api('/analytics/overview');
    const o = data.overview;
    let html = `<div class="stat-grid">
      <div class="stat-card teal"><div class="stat-label">Total Customers</div><div class="stat-val">${o.total_customers}</div><div class="stat-sub">${o.active_7d} active (7d) | ${o.active_30d} active (30d)</div></div>
      <div class="stat-card gold"><div class="stat-label">Total Points Issued</div><div class="stat-val">${Number(o.total_points_issued).toLocaleString()}</div></div>
      <div class="stat-card purple"><div class="stat-label">Total Tokens (AUD)</div><div class="stat-val">$${Number(o.total_tokens_issued).toLocaleString()}</div></div>
      <div class="stat-card blue"><div class="stat-label">Avg Level</div><div class="stat-val">${Number(o.avg_level).toFixed(1)}</div></div>
      <div class="stat-card green"><div class="stat-label">Avg Fact Find</div><div class="stat-val">${Number(o.avg_fact_find).toFixed(0)}%</div></div>
    </div>`;

    if (data.level_distribution.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Level Distribution</h3></div><div style="display:flex;gap:12px;flex-wrap:wrap">`;
      data.level_distribution.forEach(l => {
        html += `<div style="text-align:center;background:var(--gray100);border-radius:10px;padding:12px 20px"><div style="font-size:24px;font-weight:700;color:var(--teal)">${l.count}</div><div style="font-size:12px;color:var(--gray600)">Level ${l.level}</div></div>`;
      });
      html += '</div></div>';
    }

    html += `<div class="card"><div class="card-header"><h3>Advisor Performance Comparison</h3></div>`;
    if (data.by_advisor.length === 0) {
      html += '<div class="empty-state">No advisors found. Add advisors and assign customers to see performance data.</div>';
    } else {
      html += `<table><thead><tr><th>Advisor</th><th>Clients</th><th>Active (7d)</th><th>Avg Fact Find</th><th>Total Points</th><th>Total Tokens</th><th>Avg Level</th><th>Avg Streak</th><th></th></tr></thead><tbody>`;
      data.by_advisor.forEach(a => {
        html += `<tr>
          <td><strong>${a.name}</strong><br><small style="color:var(--gray400)">${a.email}</small></td>
          <td>${a.customer_count}</td><td>${a.active_7d}</td>
          <td><div class="progress-bar" style="width:80px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${Number(a.avg_fact_find).toFixed(0)}%"></div></div> ${Number(a.avg_fact_find).toFixed(0)}%</td>
          <td>${Number(a.total_points).toLocaleString()}</td>
          <td>$${Number(a.total_tokens).toLocaleString()}</td>
          <td>${Number(a.avg_level).toFixed(1)}</td>
          <td>${Number(a.avg_streak).toFixed(1)}</td>
          <td><button class="btn btn-primary btn-sm" onclick="viewAdvisorReport(${a.id})">Report</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
    }
    html += '</div>';

    if (data.unassigned_customers > 0) {
      html += `<div class="card" style="border-left:4px solid var(--gold)"><div class="card-header"><h3>Unassigned Customers: ${data.unassigned_customers}</h3><button class="btn btn-gold btn-sm" onclick="navigate('customers')">Manage</button></div><p style="color:var(--gray600);font-size:13px">${data.unassigned_customers} customer(s) have no assigned advisor. Go to Customers to assign them.</p></div>`;
    }

    document.getElementById('analytics-content').innerHTML = html;
  } catch (e) {
    document.getElementById('analytics-content').innerHTML = '<p>Failed to load analytics</p>';
  }
}

async function viewAdvisorReport(advisorId) {
  setMain('<div class="page-header"><h1>Advisor Report</h1><p>Loading...</p></div>');
  try {
    const data = await api('/analytics/advisor/' + advisorId);
    const a = data.advisor;
    const s = data.stats;
    let html = `<div class="page-header"><h1>${a.name}</h1><p>${a.email} ${a.phone ? '| ' + a.phone : ''} ${a.license_number ? '| License: ' + a.license_number : ''}</p></div>
    <div style="margin-bottom:16px"><button class="btn btn-secondary btn-sm" onclick="navigate('analytics')">Back to Analytics</button> <button class="btn btn-secondary btn-sm" onclick="showAdvisorModal(${a.id})">Edit Advisor</button></div>
    <div class="stat-grid">
      <div class="stat-card teal"><div class="stat-label">Total Clients</div><div class="stat-val">${s.total_customers}</div><div class="stat-sub">${s.active_7d} active this week</div></div>
      <div class="stat-card gold"><div class="stat-label">Total Points</div><div class="stat-val">${Number(s.total_points).toLocaleString()}</div></div>
      <div class="stat-card green"><div class="stat-label">Avg Fact Find</div><div class="stat-val">${Number(s.avg_fact_find).toFixed(0)}%</div></div>
      <div class="stat-card blue"><div class="stat-label">Avg Level</div><div class="stat-val">${Number(s.avg_level).toFixed(1)}</div><div class="stat-sub">Avg streak: ${Number(s.avg_streak).toFixed(1)} days</div></div>
    </div>`;

    if (data.customers.length > 0) {
      html += `<div class="card"><div class="card-header"><h3>Clients (${data.customers.length})</h3></div>
      <table><thead><tr><th>Customer</th><th>Level</th><th>Points</th><th>Streak</th><th>Tokens</th><th>Fact Find</th><th>Last Active</th></tr></thead><tbody>`;
      data.customers.forEach(c => {
        html += `<tr onclick="showCustomerDetail(${c.id})" style="cursor:pointer">
          <td><strong>${c.name || 'Anonymous'}</strong><br><small style="color:var(--gray400)">${c.email || '-'}</small></td>
          <td>${c.level}</td>
          <td>${Number(c.total_points_earned).toLocaleString()}</td>
          <td>${c.streak}</td>
          <td>$${Number(c.token_balance).toFixed(2)}</td>
          <td><div class="progress-bar" style="width:60px;display:inline-block;vertical-align:middle"><div class="fill" style="width:${c.fact_find_progress || 0}%"></div></div> ${c.fact_find_progress || 0}%</td>
          <td>${c.last_active ? new Date(c.last_active).toLocaleDateString() : '-'}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
    } else {
      html += '<div class="empty-state">No clients assigned to this advisor yet.</div>';
    }
    setMain(html);
  } catch (e) {
    setMain('<p>Failed to load advisor report</p>');
  }
}

if (token) {
  showApp();
} else {
  document.getElementById('login-page').classList.remove('hidden');
}
</script>
</body>
</html>
